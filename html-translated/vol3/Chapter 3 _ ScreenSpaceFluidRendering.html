<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:ops="http://www.idpf.org/2007/ops" xml:lang="en" class="translated-ltr" style="height: 100%;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <link rel="stylesheet" type="text/css" href="./Chapter 3 _ ScreenSpaceFluidRendering_files/style.scss">
  <meta name="generator" content="Re:VIEW">
  <title>ScreenSpaceFluidRendering</title>

			<style>
				img {
					max-width: 80vw;
					max-height: 80vh;
				}
			</style><style>
					.goog-te-banner-frame {
						display: none;
					}
				</style>
			<script>(function(){(function injection() {
  var pageLang = 'ja';
  var userLang = 'en';

  var uid = '1E07F158C6FA4460B352973E9693B329';
  var teId = 'TE_' + uid;
  var cbId = 'TECB_' + uid;

  function show() {
    window.setTimeout(function() {
      window[teId].showBanner(true);
    }, 10);
  }

  function newElem() {
    
  }

  if (window[teId]) {
    show();
  } else {
    if (!window.google || !google.translate ||
        !google.translate.TranslateElement) {
      if (!window[cbId]) {
        window[cbId] = function() {
          window[teId] = newElem();
          show();
        };
      }
      
    }
  }
})();})();</script><script src="https://translate.google.com/translate_a/element.js?cb=TECB_1E07F158C6FA4460B352973E9693B329&amp;client=tee&amp;hl=en"></script><script src="./Chapter 3 _ ScreenSpaceFluidRendering_files/f.txt"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/translate_static/js/element/main.js"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="./Chapter 3 _ ScreenSpaceFluidRendering_files/translateelement.css"><script type="text/javascript" charset="UTF-8" src="./Chapter 3 _ ScreenSpaceFluidRendering_files/main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script><script type="text/javascript" charset="UTF-8" src="./Chapter 3 _ ScreenSpaceFluidRendering_files/element_main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/translate_static/js/element/main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script></head>
		
<body style="position: relative; min-height: 100%; top: 40px;"><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div>
<h1><a id="h3"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;" class="">Chapter 3　</font></font></span><font style="vertical-align: inherit;"><font class="" style="vertical-align: inherit;"> ScreenSpaceFluidRendering</font></font></h1>

<h2><a id="h3-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Introduction</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This chapter </font><font style="vertical-align: inherit;">introduces </font><strong><font style="vertical-align: inherit;">Screen Space Fluid Rendering</font></strong><font style="vertical-align: inherit;"> by </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deferred Shading</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as one of the particle rendering methods </font><font style="vertical-align: inherit;">.</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p>

<h2><a id="h3-2"></a><span class="secno">3.2　</span>Screen Space Fluid Renderingとは</h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traditionally, the Martin Cubes method is used to render fluid-like continuums, but it is relatively computationally intensive and not suitable for detailed drawing in real-time applications. </font><font style="vertical-align: inherit;">Therefore, a method </font><font style="vertical-align: inherit;">called </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Screen Space Fluid Rendering</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> was devised </font><font style="vertical-align: inherit;">as a method for drawing particle-based fluids at high speed </font><font style="vertical-align: inherit;">.</font></font></p>
<div id="ssfr_screen_space_fluid_rendering_overview" class="image">
<img src="./Chapter 3 _ ScreenSpaceFluidRendering_files/ssfr_screen_space_fluid_rendering_overview.png" alt="Schematic of Screen Space Fluid Rendering">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 3.1: Schematic diagram of Screen Space Fluid Rendering
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This creates a surface from the depth of the surface of the particles in the screen space visible to the camera, as shown in Figure 3.1.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A technique called </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deferred Rendering</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is used </font><font style="vertical-align: inherit;">to generate this surface geometry </font><font style="vertical-align: inherit;">.</font></font></p>

<h2><a id="h3-3"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.3 What is　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Deferred Rendering?</font></font></h2>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2-dimensional screen space (screen space)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shading (shadow calculation)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a technology to perform. </font><font style="vertical-align: inherit;">For the sake of distinction, the traditional type of technique is </font><font style="vertical-align: inherit;">called </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Forward Rendering</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 3.2 </font><font style="vertical-align: inherit;">outlines </font><font style="vertical-align: inherit;">the traditional </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Forward Rendering</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deferred Rendering</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rendering pipelines.</font></font></p>
<div id="ssfr_rendering_pipeline_compare" class="image">
<img src="./Chapter 3 _ ScreenSpaceFluidRendering_files/ssfr_rendering_pipeline_compare.png" alt="Comparison of Foward Rendering and Deferred Rendering pipelines">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 3.2: Comparison of Foward Rendering and Deferred Rendering pipelines
</font></font></p>
</div>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the case of </font><strong><font style="vertical-align: inherit;">Forward Rendering</font></strong><font style="vertical-align: inherit;"> , lighting and shading processing are performed </font><font style="vertical-align: inherit;">in </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the first pass</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of the </font><font style="vertical-align: inherit;">shader, </font><font style="vertical-align: inherit;">but in </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deferred Rendering</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">2D image information such </font><font style="vertical-align: inherit;">as </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">normal</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">position</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">depth</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diffuse color</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> required for shading </font><font style="vertical-align: inherit;">is generated, and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G-Buffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Store in a buffer called. </font><font style="vertical-align: inherit;">In the second pass, that information is used to perform lighting and shading to obtain the final rendering result. </font><font style="vertical-align: inherit;">This </font><font style="vertical-align: inherit;">delays </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> actual rendering to </font><strong><font style="vertical-align: inherit;">the second pass (and beyond)</font></strong><font style="vertical-align: inherit;"> , hence the name </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Deferred" Rendering</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<p><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The advantage of </font><strong><font style="vertical-align: inherit;">Deferred Rendering</font></strong><font style="vertical-align: inherit;"> is</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Many light sources can be used</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When shading, you only need to calculate the displayed area, so you can minimize the number of times the fragment shader is executed.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geometry can be transformed</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G-Buffer information can be used in PostEffect etc. (SSAO etc.)</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The downside is</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Weak in translucent expression</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some algorithms such as MSAA may not be effective enough for antialiasing.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Difficult to use multiple materials</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Not supported on Orthographic cameras</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are some restrictions such as trade-offs, so it is necessary to consider them before making a decision.</font></font></p>

<h4><a id="h3-3-0-1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terms of use for Deferred Rendering in Unity</font></font></h4>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deferred Rendering</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> has the following usage conditions, and this sample program may not work depending on the environment. </font><font style="vertical-align: inherit;">..</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Only available in Unity Pro</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multi-render target (MRT) is enabled</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shader model 3.0 and above</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Requires a graphics card that supports depth slender textures and two-sided stencil buffers</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deferred Rendering</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font><font style="vertical-align: inherit;">not supported when using </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orthographic</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> projection </font><font style="vertical-align: inherit;">, and </font><strong><font style="vertical-align: inherit;">Forward Rendering</font></strong><font style="vertical-align: inherit;"> is used </font><font style="vertical-align: inherit;">when </font><font style="vertical-align: inherit;">the camera's projection mode is </font><font style="vertical-align: inherit;">set to </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orthographic</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p>

<h2><a id="h3-4"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.4　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> G-Buffer (geometry buffer)</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Information about (2D texture) in screen space, such as </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">normals</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">positions</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diffuse colors</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> used for shading and lining calculations, </font><font style="vertical-align: inherit;">is called </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G-Buffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G-Buffer path</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of </font><font style="vertical-align: inherit;">Unity's rendering pipeline </font><font style="vertical-align: inherit;">, each object is rendered once and rendered into a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G-Buffer texture</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , generating the following information by default:</font></font></p>
<div id="tbl1" class="table">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Form 3.1: </font></font></p>
<table>
<tbody><tr><th>render target</th><th>format</th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data type</font></font></font></font></th></tr>
<tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RT0</font></font></font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ARGB32</font></font></font></font></td><td>Diffuse color (RGB), Occulusion (A)</td></tr>
<tr><td>RT1</td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ARGB32</font></font></font></font></td><td>Specular color (RGB), Roughness (A)</td></tr>
<tr><td>RT2</td><td>ARGB2101010</td><td>World space normal (RGB)</td></tr>
<tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RT3</font></font></font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ARGB2101010</font></font></font></font></td><td>Emission + (Ambient + Reflections + Lightmaps)</td></tr>
<tr><td>Z-buffer</td><td></td><td>Depth + Stencil</td></tr>
</tbody></table>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G-Buffer textures</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are set as global properties and can be retrieved within the shader.</font></font></p>
<div id="tbl2" class="table">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Table 3.2: </font></font></p>
<table>
<tbody><tr><th>shader property name</th><th>data type</th></tr>
<tr><td>_CameraGBufferTexture0</td><td>Diffuse color (RGB), occulusion (A)</td></tr>
<tr><td>_CameraGBufferTexture1</td><td>Specular color (RGB)</td></tr>
<tr><td>_CameraGBufferTexture2</td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">World space normal (RGB)</font></font></font></font></td></tr>
<tr><td>_CameraGBufferTexture3</td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emission + (Ambient + Reflections + Lightmaps)</font></font></font></font></td></tr>
<tr><td>_CameraDepthTexture</td><td>Depth + Stencil</td></tr>
</tbody></table>
</div>
<p><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you open </font><strong><font style="vertical-align: inherit;">Assets / ScreenSpaceFluidRendering / Scenes / ShowGBufferTest</font></strong><font style="vertical-align: inherit;"> in the </font><font style="vertical-align: inherit;">sample code, </font><font style="vertical-align: inherit;">you can see how </font><font style="vertical-align: inherit;">this </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G-Buffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is acquired and displayed on the screen.</font></font></p>
<div id="ssfr_g-buffer" class="image">
<img src="./Chapter 3 _ ScreenSpaceFluidRendering_files/ssfr_g-buffer.png" alt="G-Buffer generated by default">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 3.3: G-Buffer generated by default
</font></font></p>
</div>

<h2><a id="h3-5"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.5　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> About Command Buffer</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The sample program introduced in this chapter </font><font style="vertical-align: inherit;">uses Unity's API called </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CommandBuffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> drawing process itself is not performed in the method written in the script executed by the </font><strong><font style="vertical-align: inherit;">CPU</font></strong><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Instead, </font><font style="vertical-align: inherit;">it is </font><font style="vertical-align: inherit;">added to the </font><strong><font style="vertical-align: inherit;">GPU</font></strong><font style="vertical-align: inherit;"> 's understandable </font><font style="vertical-align: inherit;">list of </font><strong><font style="vertical-align: inherit;">rendering commands</font></strong><font style="vertical-align: inherit;"> , called the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">graphics command buffer,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font><font style="vertical-align: inherit;">the generated </font><strong><font style="vertical-align: inherit;">command buffer</font></strong><font style="vertical-align: inherit;"> is </font><font style="vertical-align: inherit;">read directly by the </font><strong><font style="vertical-align: inherit;">GPU</font></strong><font style="vertical-align: inherit;"> and executed to actually draw the object.</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rendering commands</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> provided by Unity are </font><font style="vertical-align: inherit;">, for example, </font><font style="vertical-align: inherit;">methods such as </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graphics.DrawMesh ()</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graphics.DrawProcedural ()</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of Unity of API </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CommandBuffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> By using, Unity of the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rendering pipeline</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to a specific point in the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">command buffer (a list of the rendering commands)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by inserting a, Unity of the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rendering pipeline</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be extended to.</font></font></p>
<p><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can see some sample projects using </font><strong><font style="vertical-align: inherit;">CommandBuffer</font></strong><font style="vertical-align: inherit;"> here.</font></font></p>
<p><a href="https://docs.unity3d.com/ja/current/Manual/GraphicsCommandBuffers.html" class="link">https://docs.unity3d.com/ja/current/Manual/GraphicsCommandBuffers.html</a></p>

<h2><a id="h3-6"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.6　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Coordinate system and coordinate transformation</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the following, we will briefly explain the 3DCG graphics pipeline and coordinate system to understand the contents of the calculations performed on the screen space.</font></font></p>

<h4><a id="h3-6-0-1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Homogeneous Coordinates</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When considering a three-dimensional position vector (x, y, z), it is sometimes treated as a four-dimensional one such as (x, y, z, w), which is called Homogeneous Coordinates. .. </font><font style="vertical-align: inherit;">By thinking in four dimensions in this way, you can effectively multiply 4x4 Matrix. </font><font style="vertical-align: inherit;">The calculation of the coordinate transformation is basically done by multiplying the 4x4 Matrix, so the position vector is expressed in 4 dimensions like this.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The conversion between homogeneous coordinates and non-homogeneous coordinates is done in this way. </font><font style="vertical-align: inherit;">(x / w, y / w, z / w, 1) = (x, y, z, w)</font></font></p>

<h4><a id="h3-6-0-2"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Object Space (object coordinate system, local coordinate system, model coordinate system)</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The coordinate system around which the object itself is central.</font></font></p>

<h4><a id="h3-6-0-3"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">World Space (world coordinate system, global coordinate system)</font></font></h4>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">World Space</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a coordinate system that shows how multiple objects are spatially related in a scene, centered on the scene. </font><font style="vertical-align: inherit;">The World Space is </font><font style="vertical-align: inherit;">transformed from </font><font style="vertical-align: inherit;">the </font><strong><font style="vertical-align: inherit;">Object Space</font></strong><font style="vertical-align: inherit;"> by </font><font style="vertical-align: inherit;">a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modeling Transform</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that moves, rotates, and scales the object </font><font style="vertical-align: inherit;">.</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p>

<h4><a id="h3-6-0-4"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eye (View) Space (viewpoint coordinate system, camera coordinate system)</font></font></h4>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eye Space</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a coordinate system centered on the drawing camera and with its viewpoint as the origin. </font><font style="vertical-align: inherit;">Orientation on the position and the camera of the camera, was to define the information, such as a camera focus direction of the orientation of the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View Matrix</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> According to the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View Transform</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by making a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">World Space</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will be converted from.</font></font></p>

<h4><a id="h3-6-0-5"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clip Space (Clipping coordinate system, Clip coordinate system)</font></font></h4>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clip Space</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the above </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View Matrix</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> other parameters of the camera defined by and defines a field of view (FOV) · aspect ratio · near clip · _far clip </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projection Matrix</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View Space</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> coordinate system obtained by converting multiplying the is. </font><font style="vertical-align: inherit;">This transformation </font><font style="vertical-align: inherit;">is called the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projection Transform</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which clips the space drawn by the camera.</font></font></p>

<h4><a id="h3-6-0-6"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Normalized Device Coordinates</font></font></h4>
<p><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coordinate value obtained by </font><strong><font style="vertical-align: inherit;">Clip Space</font></strong><font style="vertical-align: inherit;"> xyz By dividing each element by w, the range is -1 &lt;= x &lt;= 1, -1 &lt;= y &lt;= 1, 0 &lt;= z &lt;= 1. All position coordinates are normalized. </font><font style="vertical-align: inherit;">The coordinate system obtained by this </font><font style="vertical-align: inherit;">is called </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Normalized Device Coordinates (NDC)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This transformation is </font><font style="vertical-align: inherit;">called </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Persepective Devide,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the objects in the foreground are drawn larger and the ones in the back are drawn smaller.</font></font></p>

<h4><a id="h3-6-0-7"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Screen (Window) Space (screen coordinate system, window coordinate system)</font></font></h4>
<p><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A coordinate system in which the normalized values ​​obtained by </font><strong><font style="vertical-align: inherit;">Normalized Device Coordinates</font></strong><font style="vertical-align: inherit;"> are converted to match the screen resolution. </font><font style="vertical-align: inherit;">In the case of Direct3D, the origin is the upper left.</font></font></p>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deferred Rendering</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> calculates based on the image in this screen space, but if necessary, it calculates and uses the information of any coordinate system by multiplying it by the inverse matrix of each transformation, so this rendering pipeline is used. It's important to understand.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 3.3 illustrates the relationship between the 3DCG graphics pipeline, the coordinate system, and coordinate transformation.</font></font></p>
<div id="ssfr_coordinate_system_and_transform" class="image">
<img src="./Chapter 3 _ ScreenSpaceFluidRendering_files/ssfr_coordinate_system_and_transform.png" alt="Coordinate system, flow of coordinate transformation">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 3.4: Coordinate system, flow of coordinate transformation
</font></font></p>
</div>

<h2><a id="h3-7"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.7　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Explanation of implementation</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of the sample code</font></font></p>
<p><strong>Assets/ScreenSpaceFluidRendering/Scenes/ScreenSpaceFluidRendering</strong></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Please open the scene.</font></font></p>

<h3><a id="h3-7-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.7.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Algorithm Overview</font></font></h3>
<p><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The general algorithm for </font><strong><font style="vertical-align: inherit;">Screen Space Fluid Rendering</font></strong><font style="vertical-align: inherit;"> is as follows.</font></font></p>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Draw particles to generate a depth image of screen space</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apply a blur effect to the depth image to make it smooth</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculate surface normals from depth</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculate surface shading</font></font></li>
</ol>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* In this sample code, even the creation of surface geometry is performed. </font><font style="vertical-align: inherit;">We do not perform transparent expressions.</font></font></p>

<h3><a id="h3-7-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.7.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Script configuration</font></font></h3>
<div id="tbl3" class="table">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Table 3.3: </font></font></p>
<table>
<tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script name</font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">function</font></font></th></tr>
<tr><td>ScreenSpaceFluidRenderer.cs</td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Main script</font></font></td></tr>
<tr><td>RenderParticleDepth.shader</td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Find the depth of the particle's screen space</font></font></td></tr>
<tr><td>BilateralFilterBlur.shader</td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blur effect that attenuates with depth</font></font></td></tr>
<tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CalcNormal.shader</font></font></font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Find the normal from the depth information of the screen space</font></font></td></tr>
<tr><td>RenderGBuffer.shader</td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Write depth, normals, color information, etc. to G-Buffer</font></font></td></tr>
</tbody></table>
</div>

<h3><a id="h3-7-3"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.7.3　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Create CommandBuffer and register it in the camera</font></font></h3>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScreenSpaceFluidRendering.cs</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OnWillRenderObject</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Within the function, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CommandBuffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to create a, at any point of the camera of rendering path </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CommandBuffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> make the process of registering.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Below is an excerpt of the code</font></font></p>
<div class="emlist-code">
<p class="caption">ScreenSpaceFluidRendering.cs</p>
<pre class="emlist language-csharp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Called when the attached mesh renderer is in the camera</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
void OnWillRenderObject ()</font></font></font></font><font></font>
{<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // If it is not active, release it and do nothing after that</font></font><font></font>
  var act = gameObject.activeInHierarchy &amp;&amp; enabled;<font></font>
  if (!act)<font></font>
  {<font></font>
    CleanUp();<font></font>
    return;<font></font>
  }<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // If there is no camera currently rendering, do nothing after that</font></font><font></font>
  var cam = Camera.current;<font></font>
  if (!cam)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    return;</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  }</font></font></font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // For the camera currently rendering</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // If CommandBuffer is not attached</font></font><font></font>
  if (!_cameras.ContainsKey(cam))<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  {</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Create Command Buffer information</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    var buf = new CmdBufferInfo ();</font></font></font></font><font></font>
    buf.pass   = CameraEvent.BeforeGBuffer;<font></font>
    buf.buffer = new CommandBuffer();<font></font>
    buf.name = "Screen Space Fluid Renderer";<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // In the path on the camera's rendering pipeline before the G-Buffer was generated,</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Add the created CommandBuffer</font></font><font></font>
    cam.AddCommandBuffer(buf.pass, buf.buffer);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Add a camera to the list that manages cameras with CommandBuffer added</font></font><font></font>
    _cameras.Add(cam, buf);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  }</font></font></font></font><font></font>
</pre>
</div>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Camera.AddCommandBuffer (CameraEvent evt, Rendering.CommandBuffer buffer)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">adds </font><font style="vertical-align: inherit;">a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">command buffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the </font><font style="vertical-align: inherit;">camera that runs at any path </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Here, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CameraEvent.BeforeGBuffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">immediately before the G-Buffer is generated</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and specifies the location of where any </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">command buffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by inserting the, you can generate a calculated geometry on the screen space. </font><font style="vertical-align: inherit;">The added </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">command buffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font><font style="vertical-align: inherit;">deleted by using the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RemoveCommandBuffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">when the application is executed or the object is disabled </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The </font><font style="vertical-align: inherit;">process of deleting the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">command buffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the camera </font><font style="vertical-align: inherit;">is implemented in the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cleanup</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CommandBuffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rendering command</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will continue to register a. </font><font style="vertical-align: inherit;">At that time, at the beginning of frame update, </font><font style="vertical-align: inherit;">delete all buffer commands by </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CommandBuffer.Clear</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method.</font></font></p>

<h3><a id="h3-7-4"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.7.4　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Generate a depth image of particles</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generates a </font><strong><font style="vertical-align: inherit;">point sprite</font></strong><font style="vertical-align: inherit;"> based on </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of the </font><strong><font style="vertical-align: inherit;">vertices of</font></strong><font style="vertical-align: inherit;"> a given particle </font><font style="vertical-align: inherit;">and calculates </font><strong><font style="vertical-align: inherit;">the depth texture</font></strong><font style="vertical-align: inherit;"> in </font><font style="vertical-align: inherit;">that </font><strong><font style="vertical-align: inherit;">screen space</font></strong><font style="vertical-align: inherit;"> .</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code is excerpted below.</font></font></p>
<div class="emlist-code">
<p class="caption">ScreenSpaceFluidRendering.cs</p>
<pre class="emlist language-csharp">// --------------------------------------------------------------------<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// 1. Draw particles as point sprites to get depth and color data</font></font><font></font>
// --------------------------------------------------------------------<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Get the shader property ID of the depth buffer</font></font><font></font>
int depthBufferId = Shader.PropertyToID("_DepthBuffer");<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Get a temporary RenderTexture</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
buf.GetTemporaryRT (depthBufferId, -1, -1, 24,</font></font></font></font><font></font>
  FilterMode.Point, RenderTextureFormat.RFloat);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Specify color buffer and depth buffer as render targets</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
buf.SetRenderTarget</font></font></font></font><font></font>
(<font></font>
  new RenderTargetIdentifier(depthBufferId),  // デプス<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  new RenderTargetIdentifier (depthBufferId) // For depth writing</font></font><font></font>
);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Clear color buffer and depth buffer</font></font><font></font>
buf.ClearRenderTarget(true, true, Color.clear);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Set the particle size</font></font><font></font>
_renderParticleDepthMaterial.SetFloat ("_ParticleSize", _particleSize);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Set particle data (ComputeBuffer)</font></font><font></font>
_renderParticleDepthMaterial.SetBuffer("_ParticleDataBuffer",<font></font>
_particleControllerScript.GetParticleDataBuffer());<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Draw particles as point sprites to get a depth image</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
buf.DrawProcedural</font></font></font></font><font></font>
(<font></font>
  Matrix4x4.identity,<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  _renderParticleDepthMaterial,</font></font></font></font><font></font>
  0,<font></font>
  MeshTopology.Points,<font></font>
  _particleControllerScript.GetMaxParticleNum()<font></font>
);<font></font>
<font></font>
</pre>
</div>
<div class="emlist-code">
<p class="caption">RenderParticleDepth.shader</p>
<pre class="emlist language-hlsl">// --------------------------------------------------------------------<font></font>
// Vertex Shader<font></font>
// --------------------------------------------------------------------<font></font>
v2g vert(uint id : SV_VertexID)<font></font>
{<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  v2g or = (v2g) 0;</font></font><font></font>
  FluidParticle fp = _ParticleDataBuffer[id];<font></font>
  o.position = float4(fp.position, 1.0);<font></font>
  return o;<font></font>
}<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// --------------------------------------------------------------------</font></font><font></font>
// Geometry Shader<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// --------------------------------------------------------------------</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Position of each vertex of the point sprite</font></font><font></font>
static const float3 g_positions[4] =<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font></font></font><font></font>
  float3(-1, 1, 0),<font></font>
  float3( 1, 1, 0),<font></font>
  float3(-1,-1, 0),<font></font>
  float3( 1,-1, 0),<font></font>
};<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// UV coordinates of each vertex</font></font><font></font>
static const float2 g_texcoords[4] =<font></font>
{<font></font>
  float2(0, 1),<font></font>
  float2(1, 1),<font></font>
  float2(0, 0),<font></font>
  float2(1, 0),<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
};</font></font></font></font><font></font>
<font></font>
[maxvertexcount(4)]<font></font>
void geom(point v2g In[1], inout TriangleStream&lt;g2f&gt; SpriteStream)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  g2f o = (g2f) 0;</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Position of the center vertex of the point sprite</font></font><font></font>
  float3 vertpos = In[0].position.xyz;<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // 4 point sprites</font></font><font></font>
  [unroll]<font></font>
  for (int i = 0; i &lt; 4; i++)<font></font>
  {<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Find and substitute the position of the point sprite in the clip coordinate system</font></font><font></font>
    float3 pos = g_positions[i] * _ParticleSize;<font></font>
    pos = mul(unity_CameraToWorld, pos) + vertpos;<font></font>
    o.position = UnityObjectToClipPos(float4(pos, 1.0));<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Substitute the UV coordinates of the point sprite vertices</font></font><font></font>
    o.uv       = g_texcoords[i];<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Find and substitute the position of the point sprite in the viewpoint coordinate system</font></font><font></font>
    o.vpos     = UnityObjectToViewPos(float4(pos, 1.0)).xyz * float3(1, 1, 1);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Substitute the size of the point sprite</font></font><font></font>
    o.size     = _ParticleSize;<font></font>
<font></font>
    SpriteStream.Append(o);<font></font>
  }<font></font>
  SpriteStream.RestartStrip();<font></font>
}<font></font>
<font></font>
// --------------------------------------------------------------------<font></font>
// Fragment Shader<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// --------------------------------------------------------------------</font></font></font></font><font></font>
struct fragmentOut<font></font>
{<font></font>
  float  depthBuffer  : SV_Target0;<font></font>
  float  depthStencil : SV_Depth;<font></font>
};<font></font>
<font></font>
fragmentOut frag(g2f i)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Calculate normal</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  float3 N = (float3) 0;</font></font></font></font><font></font>
  N.xy = i.uv.xy * 2.0 - 1.0;<font></font>
  float radius_sq = dot(N.xy, N.xy);<font></font>
  if (radius_sq &gt; 1.0) discard;<font></font>
  N.z = sqrt(1.0 - radius_sq);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Pixel position in clip space</font></font><font></font>
  float4 pixelPos     = float4(i.vpos.xyz + N * i.size, 1.0);<font></font>
  float4 clipSpacePos = mul(UNITY_MATRIX_P, pixelPos);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // depth</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  float depth = clipSpacePos.z / clipSpacePos.w; // normalization</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  fragmentOut o = (fragmentOut) 0;</font></font></font></font><font></font>
  o.depthBuffer  = depth;<font></font>
  o.depthStencil = depth;<font></font>
<font></font>
  return o;<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font></font></font><font></font>
<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The C # script first </font><font style="vertical-align: inherit;">generates </font><font style="vertical-align: inherit;">a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temporary RenderTexture</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for calculations in screen space </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In the command buffer, use the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CommandBuffer.GetTemporaryRT</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">to create </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temporary RenderTexture</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> data and use it. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the first argument of the </font><strong><font style="vertical-align: inherit;">GetTemporaryRT</font></strong><font style="vertical-align: inherit;"> method, </font><font style="vertical-align: inherit;">pass </font><font style="vertical-align: inherit;">the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unique ID</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of the shader property of the buffer you want to create </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In shader </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unique ID</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and is, in order to access the properties of the shader that is generated each time the game scene of Unity is executed </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int type unique ID</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shader.PropertyToID</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the method </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">property name</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be generated by passing the I can. </font><font style="vertical-align: inherit;">(Since this unique ID is different in game scenes where the execution timing is different, its value cannot be retained or shared with other applications over the network.)</font></font></p>
<p><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second and third arguments of the </font><strong><font style="vertical-align: inherit;">GetTemporaryRT</font></strong><font style="vertical-align: inherit;"> method specify the resolution. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If -1</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is specified, the resolution (Camera pixel width, height) of the camera currently rendering in the game scene will be passed.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The fourth argument specifies the number of bits in the depth buffer. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In _DepthBuffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , we also want to write the depth + stencil value, so specify a value of 0 or more.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The resulting RenderTexture is, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CommandBuffer.SetRenderTarget</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the method, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the render target</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> specified, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClearRenderTarget</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the method, leave the clear. </font><font style="vertical-align: inherit;">If this is not done, it will be overwritten every frame and will not be drawn properly.</font></font></p>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The CommandBuffer.DrawProcedural</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method draws the particle data </font><font style="vertical-align: inherit;">and calculates </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the color and depth textures</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in </font><strong><font style="vertical-align: inherit;">screen space</font></strong><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The figure below shows this calculation.</font></font></p>
<div id="ssfr_calculate_depth_texture" class="image">
<img src="./Chapter 3 _ ScreenSpaceFluidRendering_files/ssfr_calculate_depth_texture.png" alt="Depth image calculation">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 3.5: Depth image calculation
</font></font></p>
</div>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Vertex</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> shader and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geometry</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> shader </font><font style="vertical-align: inherit;">generate </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">point sprites</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that </font><font style="vertical-align: inherit;">billboard in the viewpoint direction from the given particle data </font><font style="vertical-align: inherit;">. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Fragment</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> shader </font><font style="vertical-align: inherit;">calculates the hemispherical normal from the UV coordinates of </font><font style="vertical-align: inherit;">the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">point sprite</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and uses </font><font style="vertical-align: inherit;">this </font><font style="vertical-align: inherit;">to get </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a depth image in screen space</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div id="ssfr_depth_texture" class="image">
<img src="./Chapter 3 _ ScreenSpaceFluidRendering_files/ssfr_depth_texture.jpg" alt="Depth image">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 3.6: Depth image
</font></font></p>
</div>

<h3><a id="h3-7-5"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.7.5 Apply a　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> blur effect to the depth image to make it smooth</font></font></h3>
<p><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By applying a blur effect to smooth the </font><strong><font style="vertical-align: inherit;">obtained depth image</font></strong><font style="vertical-align: inherit;"> , it is possible to draw the image as if it is connected by blurring the boundary with adjacent particles. </font><font style="vertical-align: inherit;">Here, a filter is used so that the offset amount of the blur effect is attenuated according to the depth.</font></font></p>
<div id="ssfr_blurred_depth_texture" class="image">
<img src="./Chapter 3 _ ScreenSpaceFluidRendering_files/ssfr_blurred_depth_texture.jpg" alt="Blurred depth image">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 3.7: Blurred depth image
</font></font></p>
</div>

<h3><a id="h3-7-6"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.7.6　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Calculate surface normals from depth</font></font></h3>
<p><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculate the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">normal</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the </font><strong><font style="vertical-align: inherit;">blurred depth image</font></strong><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The normal is calculated </font><font style="vertical-align: inherit;">by performing </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">partial differentiation</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in </font><font style="vertical-align: inherit;">the X and Y directions </font><font style="vertical-align: inherit;">.</font></font></p>
<div id="ssfr_calculate_normal" class="image">
<img src="./Chapter 3 _ ScreenSpaceFluidRendering_files/ssfr_calculate_normal.png" alt="Normal calculation">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 3.8: Normal calculation
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Below is an excerpt of the code</font></font></font></font></p>
<div class="emlist-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CalcNormal.shader</font></font></font></font></p>
<pre class="emlist language-hlsl">// --------------------------------------------------------------------<font></font>
// Fragment Shader<font></font>
// --------------------------------------------------------------------<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Find the position in the viewpoint coordinate system from the UV of the screen</font></font><font></font>
float3 uvToEye(float2 uv, float z)<font></font>
{<font></font>
  float2 xyPos = uv * 2.0 - 1.0;<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Position in the clip coordinate system</font></font><font></font>
  float4 clipPos = float4(xyPos.xy, z, 1.0);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Position in the viewpoint coordinate system</font></font><font></font>
  float4 viewPos = mul(unity_CameraInvProjection, clipPos);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // normalization</font></font><font></font>
  viewPos.xyz = viewPos.xyz / viewPos.w;<font></font>
<font></font>
  return viewPos.xyz;<font></font>
}<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Get the depth value from the depth buffer</font></font><font></font>
float sampleDepth(float2 uv)<font></font>
{<font></font>
#if UNITY_REVERSED_Z<font></font>
  return 1.0 - tex2D(_DepthBuffer, uv).r;<font></font>
#else<font></font>
  return tex2D(_DepthBuffer, uv).r;<font></font>
#endif<font></font>
}<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Get the position in the viewpoint coordinate system</font></font><font></font>
float3 getEyePos(float2 uv)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font></font></font><font></font>
  return uvToEye(uv, sampleDepth(uv));<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font></font></font><font></font>
<font></font>
float4 frag(v2f_img i) : SV_Target<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Convert screen coordinates to texture UV coordinates</font></font><font></font>
  float2 uv = i.uv.xy;<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // get depth</font></font><font></font>
  float depth = tex2D(_DepthBuffer, uv);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Discard pixels if depth is not written</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#if UNITY_REVERSED_Z</font></font></font></font><font></font>
  if (Linear01Depth(depth) &gt; 1.0 - 1e-3)<font></font>
    discard;<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#else</font></font></font></font><font></font>
  if (Linear01Depth(depth) &lt; 1e-3)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    discard;</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
#endif</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Store texel size</font></font><font></font>
  float2 ts = _DepthBuffer_TexelSize.xy;<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Find the position of the viewpoint coordinate system (as seen from the camera) from the uv coordinates of the screen</font></font><font></font>
  float3 posEye = getEyePos(uv);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Partial differential with respect to x</font></font><font></font>
  float3 ddx  = getEyePos(uv + float2(ts.x, 0.0)) - posEye;<font></font>
  float3 ddx2 = posEye - getEyePos(uv - float2(ts.x, 0.0));<font></font>
  ddx = abs(ddx.z) &gt; abs(ddx2.z) ? ddx2 : ddx;<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Partial differential with respect to y</font></font><font></font>
  float3 ddy = getEyePos(uv + float2(0.0, ts.y)) - posEye;<font></font>
  float3 ddy2 = posEye - getEyePos(uv - float2(0.0, ts.y));<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  Dy = abs (Dy.z)&gt; abs (Dy2.z)? </font><font style="vertical-align: inherit;">dy2: should;</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Find the normal orthogonal to the vector found above from the cross product</font></font><font></font>
  float3 N = normalize(cross(ddx, ddy));<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Change the normal in relation to the camera position</font></font><font></font>
  float4x4 vm = _ViewMatrix;<font></font>
  N = normalize(mul(vm, float4(N, 0.0)));<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Convert (-1.0 to 1.0) to (0.0 to 1.0)</font></font><font></font>
  float4 col = float4(N * 0.5 + 0.5, 1.0);<font></font>
<font></font>
  return col;<font></font>
}<font></font>
<font></font>
</pre>
</div>
<div id="ssfr_normal_texture" class="image">
<img src="./Chapter 3 _ ScreenSpaceFluidRendering_files/ssfr_normal_texture.jpg" alt="Normal image">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 3.9: Normal image
</font></font></p>
</div>

<h3><a id="h3-7-7"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.7.7 Calculate　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> surface shading</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The depth image and normal image obtained by the calculation so far are written to </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G-Buffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> writing just before the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rendering pass</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> where the </font><strong><font style="vertical-align: inherit;">G-Buffer</font></strong><font style="vertical-align: inherit;"> is generated, </font><font style="vertical-align: inherit;">the geometry based on the calculation result is generated, and shading and lighting are applied.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excerpt from the code</font></font></p>
<div class="emlist-code">
<p class="caption">ScreenSpaceFluidRendering.cs</p>
<pre class="emlist language-csharp">// --------------------------------------------------------------------<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// 4. Write the calculation result to G-Buffer and draw the particles</font></font><font></font>
// --------------------------------------------------------------------<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
buf.SetGlobalTexture ("_NormalBuffer", normalBufferId); // Set the normal buffer</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
buf.SetGlobalTexture ("_DepthBuffer", depthBufferId); // Set the depth buffer</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// set properties</font></font><font></font>
_renderGBufferMaterial.SetColor("_Diffuse",  _diffuse );<font></font>
_renderGBufferMaterial.SetColor("_Specular",<font></font>
  new Vector4(_specular.r, _specular.g, _specular.b, 1.0f - _roughness));<font></font>
_renderGBufferMaterial.SetColor("_Emission", _emission);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Set G-Buffer to render target</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
buf.SetRenderTarget</font></font></font></font><font></font>
(<font></font>
  new RenderTargetIdentifier[4]<font></font>
  {<font></font>
    BuiltinRenderTextureType.GBuffer0, // Diffuse<font></font>
    BuiltinRenderTextureType.GBuffer1, // Specular + Roughness<font></font>
    BuiltinRenderTextureType.GBuffer2, // World Normal<font></font>
    BuiltinRenderTextureType.GBuffer3  // Emission<font></font>
  },<font></font>
  BuiltinRenderTextureType.CameraTarget  // Depth<font></font>
);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Write to G-Buffer</font></font><font></font>
buf.DrawMesh(quad, Matrix4x4.identity, _renderGBufferMaterial);<font></font>
<font></font>
</pre>
</div>
<div class="emlist-code">
<p class="caption">RenderGBuffer.shader</p>
<pre class="emlist language-hlsl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// GBuffer structure</font></font><font></font>
struct gbufferOut<font></font>
{<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  half4 diffuse: SV_Target0; // Diffuse reflection</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  half4 specular: SV_Target1; // specular reflection</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  half4 normal: SV_Target2; // normal</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  half4 emission: SV_Target3; // emission light</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  float depth: SV_Depth; // depth</font></font><font></font>
};<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sampler2D _DepthBuffer; // depth</font></font><font></font>
sampler2D _NormalBuffer;// 法線<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fixed4 _Diffuse; // Diffuse color</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fixed4 _Specular; // Color of specular light</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
float4 _Emission; // Color of synchrotron radiation</font></font><font></font>
<font></font>
void frag(v2f i, out gbufferOut o)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font></font></font><font></font>
  float2 uv = i.screenPos.xy * 0.5 + 0.5;<font></font>
<font></font>
  float  d = tex2D(_DepthBuffer,  uv).r;<font></font>
  float3 n = tex2D(_NormalBuffer, uv).xyz;<font></font>
<font></font>
#if UNITY_REVERSED_Z<font></font>
  if (Linear01Depth(d) &gt; 1.0 - 1e-3)<font></font>
    discard;<font></font>
#else<font></font>
  if (Linear01Depth(d) &lt; 1e-3)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    discard;</font></font></font></font><font></font>
#endif<font></font>
<font></font>
  o.diffuse  = _Diffuse;<font></font>
  o.specular = _Specular;<font></font>
  o.normal   = float4(n.xyz , 1.0);<font></font>
<font></font>
  o.emission = _Emission;<font></font>
#ifndef UNITY_HDR_ON<font></font>
  o.emission = exp2(-o.emission);<font></font>
#endif<font></font>
<font></font>
  o.depth    = d;<font></font>
}<font></font>
</pre>
</div>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the SetRenderTarget</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method, </font><font style="vertical-align: inherit;">specify </font><font style="vertical-align: inherit;">the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G-Buffer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to be </font><strong><font style="vertical-align: inherit;">written</font></strong><font style="vertical-align: inherit;"> to the render target </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">First in the color buffer to be an argument to the target </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BuiltinRenderTextureType</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enumeration </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GBuffer0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GBuffer1</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GBuffer2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GBuffer3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> specify a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RenderTargetIdentifier</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sequences, also in the depth buffer to be the second argument of the target </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CameraTarget</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by specifying a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">default G- A set of Buffers</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">depth information</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be specified </font><font style="vertical-align: inherit;">as the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">render target</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> order to perform calculations on the screen space with a shader that specifies </font><font style="vertical-align: inherit;">multiple </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">render targets</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the </font><strong><font style="vertical-align: inherit;">command buffer</font></strong><font style="vertical-align: inherit;"> , this is </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">achieved</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> here </font><font style="vertical-align: inherit;">by using </font><font style="vertical-align: inherit;">the </font><strong><font style="vertical-align: inherit;">DrawMesh</font></strong><font style="vertical-align: inherit;"> method to draw a rectangular mesh that covers the screen.</font></font></p>

<h3><a id="h3-7-8"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.7.8　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Temporary release of RenderTexture</font></font></h3>
<p><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Don't forget to release </font><font style="vertical-align: inherit;">the temporary </font><strong><font style="vertical-align: inherit;">RenderTexture</font></strong><font style="vertical-align: inherit;"> generated by the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTemporaryRT</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method with </font><font style="vertical-align: inherit;">the </font><strong><font style="vertical-align: inherit;">ReleaseTemporaryRT</font></strong><font style="vertical-align: inherit;"> method. </font><font style="vertical-align: inherit;">If this is not done, memory will be allocated every frame and memory overflow will occur.</font></font></p>

<h3><a id="h3-7-9"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.7.9　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rendering result</font></font></h3>
<div id="ssfr_result" class="image">
<img src="./Chapter 3 _ ScreenSpaceFluidRendering_files/ssfr_result.jpg" alt="Rendering result">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 3.10: Rendering result
</font></font></p>
</div>

<h2><a id="h3-8"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.8　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Summary</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This chapter </font><font style="vertical-align: inherit;">focused on manipulating geometry with </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deferred Shading</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In this sample, as a translucent object, elements such as light absorption according to the thickness, background transmission considering internal refraction, and condensing phenomenon are not implemented. </font><font style="vertical-align: inherit;">If you want to express it as a liquid, you should implement these elements as well. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> order to utilize </font><strong><font style="vertical-align: inherit;">Deferred Rendering</font></strong><font style="vertical-align: inherit;"> , it is necessary to understand the calculation in 3DCG rendering such as coordinate system, coordinate transformation, shading, lighting, etc. that you do not usually need to be aware of when using Unity. </font><font style="vertical-align: inherit;">In the range of observation, </font><font style="vertical-align: inherit;">there are not many sample codes and references for learning using </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deferred Rendering</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in </font><font style="vertical-align: inherit;">Unity, </font><font style="vertical-align: inherit;">and I am still not fully understood, but I feel that it is a technology that can expand the range of CG expression. I am. </font><font style="vertical-align: inherit;">We hope that </font><font style="vertical-align: inherit;">this chapter </font><font style="vertical-align: inherit;">will help those who have the purpose of expressing with CG that cannot be realized by </font><font style="vertical-align: inherit;">conventional </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Forward Rendering</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>

<h2><a id="h3-9"></a><span class="secno"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">See </font><span class="secno"><font style="vertical-align: inherit;">3.9　</font></span></font></h2>
<ul>
<li>GDC Screen Space Fluid Rendering for Games, Simon Green, NVIDIA</li>
</ul>
<p><a href="http://developer.download.nvidia.com/presentations/2010/gdc/Direct3D_Effects.pdf" class="link">http://developer.download.nvidia.com/presentations/2010/gdc/Direct3D_Effects.pdf</a></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why real-time rendering, Satoshi Kodaira</font></font></li>
</ul>
<p><a href="https://www.slideshare.net/SatoshiKodaira/ss-69311865" class="link">https://www.slideshare.net/SatoshiKodaira/ss-69311865</a></p><div id="goog-gt-tt" class="goog-tooltip skiptranslate" dir="ltr" style="visibility: hidden; left: 579px; top: 21.125px; display: none;"><div style="padding: 8px;"><div><div class="logo"><img src="./Chapter 3 _ ScreenSpaceFluidRendering_files/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text">第3章　ScreenSpaceFluidRendering</div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none; opacity: 0;"></div></div>


<div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 1001px; height: 263px; display: none;" src="./Chapter 3 _ ScreenSpaceFluidRendering_files/saved_resource(1).html"></iframe><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 197px; height: 69px; display: none;" src="./Chapter 3 _ ScreenSpaceFluidRendering_files/saved_resource(2).html"></iframe><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 1001px; height: 263px; display: none;"></iframe><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 197px; height: 69px; display: none;"></iframe><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 1001px; height: 263px; display: none;"></iframe><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 197px; height: 69px; display: none;"></iframe></body></html>