<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:ops="http://www.idpf.org/2007/ops" xml:lang="en" class="translated-ltr" style="height: 100%;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <link rel="stylesheet" type="text/css" href="./Chapter 7 _ Portal in Unity_files/style.scss">
  <meta name="generator" content="Re:VIEW">
  <title>I tried to implement Portal with Unity</title>

			<style>
				img {
					max-width: 80vw;
					max-height: 80vh;
				}
			</style><style>
					.goog-te-banner-frame {
						display: none;
					}
				</style>
			<script>(function(){(function injection() {
  var pageLang = 'ja';
  var userLang = 'en';

  var uid = '1E07F158C6FA4460B352973E9693B329';
  var teId = 'TE_' + uid;
  var cbId = 'TECB_' + uid;

  function show() {
    window.setTimeout(function() {
      window[teId].showBanner(true);
    }, 10);
  }

  function newElem() {
    
  }

  if (window[teId]) {
    show();
  } else {
    if (!window.google || !google.translate ||
        !google.translate.TranslateElement) {
      if (!window[cbId]) {
        window[cbId] = function() {
          window[teId] = newElem();
          show();
        };
      }
      
    }
  }
})();})();</script><script src="https://translate.google.com/translate_a/element.js?cb=TECB_1E07F158C6FA4460B352973E9693B329&amp;client=tee&amp;hl=en"></script><script src="./Chapter 7 _ Portal in Unity_files/f.txt"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/translate_static/js/element/main.js"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="./Chapter 7 _ Portal in Unity_files/translateelement.css"><script type="text/javascript" charset="UTF-8" src="./Chapter 7 _ Portal in Unity_files/main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script><script type="text/javascript" charset="UTF-8" src="./Chapter 7 _ Portal in Unity_files/element_main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/translate_static/js/element/main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script></head>
		
<body style="position: relative; min-height: 100%; top: 40px;"><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div>
<h1><a id="h7"></a><span class="secno"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"><font class="" style="vertical-align: inherit;">I tried to implement </font><span class="secno"><font class="" style="vertical-align: inherit;">Chapter 7　</font></span><font class="" style="vertical-align: inherit;"> Portal in Unity</font></font></h1>

<h2><a id="h7-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Introduction</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do you know the game </font><font style="vertical-align: inherit;">Portal </font></font><a id="fnb-portal" href="https://freder.io/files/unity3/fuqunaga.html#fn-portal" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? </font><font style="vertical-align: inherit;">A puzzle action game released by Valve in 2007. </font><font style="vertical-align: inherit;">It is a god game. </font><font style="vertical-align: inherit;">The feature is a hole called a portal, and you can see the scenery on the other side as if the two holes are connected by a worm home, and you can warp through objects and your character. </font><font style="vertical-align: inherit;">The point is Anywhere Door. </font><font style="vertical-align: inherit;">You can set up a portal on a flat surface with a gun called a portal gun, and use this to advance the game. </font><font style="vertical-align: inherit;">This chapter is an article that tried to implement the function of this portal in Unity while being simple. </font><font style="vertical-align: inherit;">The sample is </font><font style="vertical-align: inherit;">"PortalGate System" of </font></font><br><a href="https://github.com/IndieVisualLab/UnityGraphicsProgramming3" class="link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/IndieVisualLab/UnityGraphicsProgramming3</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-portal"><p class="footnote">[*1] https://ja.wikipedia.org/wiki/Portal_(%E3%82%B2%E3%83%BC%E3%83%A0)</p></div>

<h2><a id="h7-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Project overview</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Think about the necessary elements as a place to play on the portal.</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Own character that can move</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">field</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portal gun (function to make a portal appear at a specified position)</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I want a hit. </font><font style="vertical-align: inherit;">Your character may be visible on the other side of the portal, so it's a first-person perspective, but you'll need a full-body model. </font><font style="vertical-align: inherit;">This time, </font><font style="vertical-align: inherit;">I used the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adam </font></font></b><a id="fnb-adam" href="https://freder.io/files/unity3/fuqunaga.html#fn-adam" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> model </font><font style="vertical-align: inherit;">distributed by Unity </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Also, I want to see the objects warping other than my character, so I can launch a red ball with the E button.</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-adam"><p class="footnote">[*2] https://assetstore.unity.com/packages/essentials/tutorial-projects/adam-character-pack-adam-guard-lu-74842</p></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The operation method is as follows.</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Move: WASD key or arrow key (hold down shift and dash)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Viewpoint movement: Mouse movement</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portal launch: Mouse left and right click</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ball launch: E key</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jump: Spacebar</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From now on, the hole to warp is called a gate. </font><font style="vertical-align: inherit;">The class name </font><font style="vertical-align: inherit;">is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PortalGate in the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> source code </font><font style="vertical-align: inherit;">.</font></font></p>

<h3><a id="h7-2-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.2.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Own character</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My character was </font><font style="vertical-align: inherit;">created by modifying </font><font style="vertical-align: inherit;">Unity's Standard Assets </font></font><a id="fnb-stdasset" href="https://freder.io/files/unity3/fuqunaga.html#fn-stdasset" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It's like using the animation of ThirdPersonChracter while modifying the control of FirstPersonCharacter. </font><font style="vertical-align: inherit;">Field of view because if (the main camera) to the user's character itself will be reflected polygon is not clean Dari sinks </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Player</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the main camera provided a layer </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Player</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we try to not displayed to set the layer to the camera of CullingMask.</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-stdasset"><p class="footnote">[*3] https://assetstore.unity.com/packages/essentials/asset-packs/standard-assets-32351</p></div>

<h3><a id="h7-2-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.2.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Field</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the field, I used </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unity3d-jp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 's level design asset </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">playGROWnd </font></font></b><a id="fnb-playg" href="https://freder.io/files/unity3/fuqunaga.html#fn-playg" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 4</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Somehow the atmosphere is like Portal. </font><font style="vertical-align: inherit;">This time, the field is a rectangular parallelepiped room to simplify the rest of the process. </font><font style="vertical-align: inherit;">Collisions are not used as they are, but transparent collisions are placed on each side of the rectangular parallelepiped. </font><font style="vertical-align: inherit;">The floor collision is wider than the room to prevent it from falling, as the post-warp object may be partially outside the room. </font><font style="vertical-align: inherit;">This is the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stage Coll</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> layer.</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-playg"><p class="footnote">[*4] https://github.com/unity3d-jp/playgrownd</p></div>

<h2><a id="h7-3"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.3　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Gate generation</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now let's implement the gate. </font><font style="vertical-align: inherit;">The gate this time is oriented to spread on the XY plane in the local coordinate system and pass through the Z + direction.</font></font></p>
<div id="id_fuqunaga_2Fgate__coorinate" class="image">
<img src="./Chapter 7 _ Portal in Unity_files/gate_coorinate.png" alt="Gate coordinate system" class="width-050per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 7.1: Gate coordinate system
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The outbreak follows the original portal, so that when you click the mouse, the gate will appear on the plane of the viewpoint, and left-click and right-click will connect each other as a pair. </font><font style="vertical-align: inherit;">If there is already a gate, the old gate will disappear on the spot and a new gate will open. </font><font style="vertical-align: inherit;">Internally, the old gate has been moved to a new location and is the earliest.</font></font></p>
<div class="emlist-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PortalGun.cs</font></font></font></font></font></font></p>
<pre class="emlist">void Shot(int idx)<font></font>
{<font></font>
    RaycastHit hit;<font></font>
    if (Physics.Raycast(transform.position,<font></font>
        transform.forward,<font></font>
        out hit,<font></font>
        float.MaxValue,<font></font>
        LayerMask.GetMask(new[] { "StageColl" })))<font></font>
    {<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        var gate = gatePair [idx];</font></font></font></font><font></font>
        if (gate == null)<font></font>
        {<font></font>
            var go = Instantiate(gatePrefab);<font></font>
            gate = gatePair[idx] = go.GetComponent&lt;PortalGate&gt;();<font></font>
<font></font>
            var pair = gatePair[(idx + 1) % 2];<font></font>
            if (pair != null)<font></font>
            {<font></font>
                gate.SetPair(pair);<font></font>
                pair.SetPair(gate);<font></font>
            }<font></font>
        }<font></font>
<font></font>
        gate.hitColl = hit.collider;<font></font>
<font></font>
        var trans = gate.transform;<font></font>
        var normal = hit.normal;<font></font>
        var up = normal.y &gt;= 0f ? transform.up : transform.forward;<font></font>
<font></font>
        trans.position = hit.point + normal * gatePosOffset;<font></font>
        trans.rotation = Quaternion.LookRotation(-normal, up);<font></font>
<font></font>
        gate.Open();<font></font>
    }<font></font>
}<font></font>
</pre>
</div>
<p><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By specifying</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> only the </font><b><font style="vertical-align: inherit;">StageColl</font></b><font style="vertical-align: inherit;"> layer </font></font><code class="inline-code tt">transform.forward</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the ray is skipped </font><font style="vertical-align: inherit;">in the </font><font style="vertical-align: inherit;">direction and the hit is confirmed. </font><font style="vertical-align: inherit;">If there is a hit, the gate operation is processed. </font><font style="vertical-align: inherit;">First, check if there is an existing gate, and if not, generate it. </font><font style="vertical-align: inherit;">Pairing is also done here. </font></font><code class="inline-code tt">PortalGate.hitColl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set </font><font style="vertical-align: inherit;">the collider that Ray collided with for later use </font><font style="vertical-align: inherit;">, and ask for the position and orientation. </font><font style="vertical-align: inherit;">The position is slightly lifted in the normal direction from the plane where it collided, and Z-fighting measures are taken. </font><font style="vertical-align: inherit;">Did you notice that the way to find the orientation is a little strange? </font><font style="vertical-align: inherit;">The specification of the up vector of Quaternion.LookRotation () is changed by the positive or negative of normal.y. </font><font style="vertical-align: inherit;">Normally, transform.up is fine, but when the gate is put out on the ceiling, the front and back (Y direction of PortalGate) will be reversed and it will feel strange, so I did it like this. </font><font style="vertical-align: inherit;">I think the original Portal also behaved like this.</font></font></p>
<div id="id_fuqunaga_2Fceil__fall__bad" class="image">
<img src="./Chapter 7 _ Portal in Unity_files/ceil_fall_bad.png" alt="When not up-vector processing">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 7.2: Without up-vector processing
</font></font></p>
</div>
<div id="id_fuqunaga_2Fceil__fall__good" class="image">
<img src="./Chapter 7 _ Portal in Unity_files/ceil_fall_good.png" alt="When up-vector processing is performed">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 7.3: Up-vector processing
</font></font></p>
</div>

<h2><a id="h7-4"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.4　</font></font></font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VirtualCamera</font></font></font></font></h2>

<h3><a id="h7-4-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.4.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Initialization</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When the gate opens, you can see the other side of another paired gate (hereinafter referred to as pair gate), so you need to implement this drawing somehow. </font><font style="vertical-align: inherit;">I took the approach of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"preparing another camera (Virtual Camera), capturing it on the Render Texture, pasting it on the Portal Gate, and drawing with the main camera</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " to draw the "other side" </font><font style="vertical-align: inherit;">.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Virtual Camera is a camera that captures pictures on the other side of the gate.</font></font></p>
<div id="id_fuqunaga_2Fvirtual__camera" class="image">
<img src="./Chapter 7 _ Portal in Unity_files/virtual_camera.png" alt="VirtualCamera">
<p class="caption">
図7.4: VirtualCamera
</p>
</div>
<p><code class="inline-code tt">PortalGate.OnWillRenderObject()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is called for each camera, so if Virtual Camera is required at that timing, it will be generated.</font></font></p>
<div class="emlist-code">
<p class="caption">PortalGate.cs</p>
<pre class="emlist"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">private void OnWillRenderObject ()</font></font><font></font>
{<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
~ Omitted ~</font></font><font></font>
    VirtualCamera pairVC;<font></font>
    if (!pairVCTable.TryGetValue(cam, out pairVC))<font></font>
    {<font></font>
        if ((vc == null) || vc.generation &lt; maxGeneration)<font></font>
        {<font></font>
            pairVC = pairVCTable[cam] = CreateVirtualCamera(cam, vc);<font></font>
            return;<font></font>
        }<font></font>
    }<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
~ Omitted ~</font></font><font></font>
}<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When the gates face each other, the gate is reflected in the scenery on the other side, and the gate is also on the other side of the gate.</font></font></p>
<div id="id_fuqunaga_2Fgate__inf" class="image">
<img src="./Chapter 7 _ Portal in Unity_files/gate_inf.png" alt="Facing gate" class="width-050per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 7.5: Facing gates
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in this case,</font></font></p>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prepare a picture of the other side of the gate reflected in the main camera Virtual Camera</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Second generation Virtual Camera for the gate reflected in that Virtual Camera</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Furthermore, the third generation Virtual Camera for the gate reflected in the Virtual Camera</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">further···</font></font></li>
</ol>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you implement it honestly, you will need an infinite number of Virtual Cameras. </font><font style="vertical-align: inherit;">This is not the case, so </font></font><code class="inline-code tt">PortalGate.maxGeneration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will limit the number of generations, and although it is not an accurate picture, I will substitute it by pasting the texture one frame before to the gate.</font></font></p>
<div class="emlist-code">
<p class="caption">PortalGate.cs</p>
<pre class="emlist">VirtualCamera CreateVirtualCamera(Camera parentCam, VirtualCamera parentVC)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font><font></font>
    var rootCam = parentVC?.rootCamera ?? parentCam;<font></font>
    var generation = parentVC?.generation + 1 ?? 1;<font></font>
<font></font>
    var go = Instantiate(virtualCameraPrefab);<font></font>
    go.name = rootCam.name + "_virtual" + generation;<font></font>
    go.transform.SetParent(transform);<font></font>
<font></font>
    var vc = go.GetComponent&lt;VirtualCamera&gt;();<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    vc.rootCamera = rootCam;</font></font></font></font><font></font>
    vc.parentCamera = parentCam;<font></font>
    vc.parentGate = this;<font></font>
    vc.generation = generation;<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    vc.Init ();</font></font></font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    return you;</font></font><font></font>
}<font></font>
</pre>
</div>
<p><code class="inline-code tt">VirtualCamera.rootCamera</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is the main camera that dates back to the generation of Virtual Camera. </font><font style="vertical-align: inherit;">In addition, the parent camera, target gate, generation, etc. are set.</font></font></p>
<div class="emlist-code">
<p class="caption">VirtualCamera.cs</p>
<pre class="emlist">public void Init()<font></font>
{<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    camera_.aspect = rootCamera.aspect;</font></font></font></font><font></font>
    camera_.fieldOfView = rootCamera.fieldOfView;<font></font>
    camera_.nearClipPlane = rootCamera.nearClipPlane;<font></font>
    camera_.farClipPlane = rootCamera.farClipPlane;<font></font>
    camera_.cullingMask |= LayerMask.GetMask(new[] { PlayerLayerName });<font></font>
    camera_.depth = parentCamera.depth - 1;<font></font>
<font></font>
    camera_.targetTexture = tex0;<font></font>
    currentTex0 = true;<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font></font></font><font></font>
</pre>
</div>
<p><code class="inline-code tt">VirtualCamera.Init()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The parameters are inherited from the parent camera. </font><font style="vertical-align: inherit;">Since my character is reflected in Virtual Camera, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Player</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> layer is deleted </font><font style="vertical-align: inherit;">from Culling Mask </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Also, because you want to capture a picture earlier than the parent of the camera </font></font><code class="inline-code tt">parentCamera.depth - 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has been.</font></font></p>
<p><font style="vertical-align: inherit;"></font><code class="inline-code tt">Camera.CopyFrom()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I used it at the </font><font style="vertical-align: inherit;">beginning </font><font style="vertical-align: inherit;">, but it seems that CommandBuffer is also copied, and an </font><font style="vertical-align: inherit;">error occurred when using it together with </font><font style="vertical-align: inherit;">PostProcessingStack </font></font><a id="fnb-pp" href="https://freder.io/files/unity3/fuqunaga.html#fn-pp" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 5</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> used for post effect, </font><font style="vertical-align: inherit;">so I copied it for each property.</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-pp"><p class="footnote">[*5] https://github.com/Unity-Technologies/PostProcessing</p></div>

<h3><a id="h7-4-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.4.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> update</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualCamera </font></font><code class="inline-code tt">PortalGate.maxGeneration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can do </font><font style="vertical-align: inherit;">more </font><font style="vertical-align: inherit;">as the </font><font style="vertical-align: inherit;">processing is lighter, so </font><font style="vertical-align: inherit;">I pay a little attention to performance so as not to waste processing.</font></font></p>
<div class="emlist-code">
<p class="caption">VirtualCamera.cs</p>
<pre class="emlist">private void LateUpdate()<font></font>
{<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // PreviewCamera etc. seems to be null at this timing, so check</font></font><font></font>
    if (parentCamera == null)<font></font>
    {<font></font>
        Destroy(gameObject);<font></font>
        return;<font></font>
    }<font></font>
<font></font>
    camera_.enabled = parentGate.IsVisible(parentCamera);<font></font>
    if (camera_.enabled)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    {</font></font></font></font><font></font>
        var parentCamTrans = parentCamera.transform;<font></font>
        var parentGateTrans = parentGate.transform;<font></font>
<font></font>
        parentGate.UpdateTransformOnPair(<font></font>
            transform,<font></font>
            parentCamTrans.position,<font></font>
            parentCamTrans.rotation<font></font>
            );<font></font>
<font></font>
<font></font>
        UpdateCamera();<font></font>
    }<font></font>
}<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will follow this code in detail.</font></font></p>

<h4><a id="h7-4-2-1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Disable camera</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the parent camera does not show the gate, you do not need to prepare the picture on the other side, so disable the camera of Virtual Camera.</font></font></p>
<div class="emlist-code">
<p class="caption">PortalGate.cs</p>
<pre class="emlist">public bool IsVisible(Camera camera)<font></font>
{<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    var ret = false;</font></font></font></font><font></font>
<font></font>
    var pos = transform.position;<font></font>
    var camPos = camera.transform.position;<font></font>
<font></font>
    var camToGateDir = (pos - camPos).normalized;<font></font>
    var dot = Vector3.Dot(camToGateDir, transform.forward);<font></font>
    if (dot &gt; 0f)<font></font>
    {<font></font>
        var planes = GeometryUtility.CalculateFrustumPlanes(camera);<font></font>
        ret = GeometryUtility.TestPlanesAABB(planes, coll.bounds);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    }</font></font></font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    return ret;</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font></font></font><font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The visibility judgment is as follows.</font></font></p>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Judgment of orientation. </font><font style="vertical-align: inherit;">I'm checking if the gate is facing the camera. </font><font style="vertical-align: inherit;">It is judged by the sign of the inner product of the camera → gate direction and the Z + direction of the gate.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Visibility judgment of the frustum and bounding box. </font><font style="vertical-align: inherit;">Unity has a function for this, and you can use it as it is. </font><font style="vertical-align: inherit;">Thank you.</font></font></li>
</ol>

<h4><a id="h7-4-2-2"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Position and orientation updates</font></font></h4>
<p><code class="inline-code tt">parentGate.UpdateTransformOnPair()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In, "From the position and orientation of the parent camera with respect to the parent gate, find the position and orientation of the parent pair with respect to the gate and update the transform".</font></font></p>
<div class="emlist-code">
<p class="caption">PortalGate.cs</p>
<pre class="emlist">public void UpdateTransformOnPair(<font></font>
    Transform trans,<font></font>
    Vector3 worldPos,<font></font>
    Quaternion worldRot<font></font>
    )<font></font>
{<font></font>
    var localPos = transform.InverseTransformPoint(worldPos);<font></font>
    var localRot = Quaternion.Inverse(transform.rotation) * worldRot;<font></font>
<font></font>
    var pairGateTrans = pair.transform;<font></font>
    var gateRot = pair.gateRot;<font></font>
    var pos = pairGateTrans.TransformPoint(gateRot * localPos);<font></font>
    var rot = pairGateTrans.rotation * gateRot * localRot;<font></font>
<font></font>
    trans.SetPositionAndRotation(pos, rot);<font></font>
}<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The implementation looks like this,</font></font></p>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Change to the local coordinate system of the gate</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Change the direction from the front to the back of the gate with gateRot</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Treated as local coordinates of paired gates</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Convert to world coordinate system</font></font></li>
</ol>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is the procedure. </font><font style="vertical-align: inherit;">gateRot</font></font></p>
<div class="emlist-code">
<pre class="emlist">public Quaternion gateRot { get; } = Quaternion.Euler(0f, 180f, 0f);
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And, I rotate it 180 degrees on the Y axis, but since the Z value should be inverted</font></font></p>
<div class="emlist-code">
<pre class="emlist">public Quaternion gateRot { get; } =  Quaterion.Euler(180f, 0f, 0f);
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Even an implementation like this should not break down. </font><font style="vertical-align: inherit;">However, since the upward direction is reversed between the front and the back of the gate, when you pass through the gate, your character's head will be on the ground side, which makes you feel uncomfortable, so Y-axis rotation seems to be good.</font></font></p>

<h4><a id="h7-4-2-3"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Update camera parameters</font></font></h4>
<div class="emlist-code">
<p class="caption">VirtualCamera.cs</p>
<pre class="emlist">void UpdateCamera()<font></font>
{<font></font>
    var pair = parentGate.pair;<font></font>
    var pairTrans = pair.transform;<font></font>
    var mesh = pair.GetComponent&lt;MeshFilter&gt;().sharedMesh;<font></font>
    var vtxList = mesh.vertices<font></font>
                  .Select(vtx =&gt; pairTrans.TransformPoint(vtx)).ToList();<font></font>
<font></font>
    TargetCameraUtility.Update(camera_, vtxList);<font></font>
<font></font>
    // Oblique<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Draw only the back of pairGate = match nearClipPlane with pairGate</font></font><font></font>
    var pairGateTrans = parentGate.pair.transform;<font></font>
    var clipPlane = CalcPlane(camera_,<font></font>
                              pairGateTrans.position,<font></font>
                              -pairGateTrans.forward);<font></font>
<font></font>
    camera_.projectionMatrix = camera_.CalculateObliqueMatrix(clipPlane);<font></font>
}<font></font>
<font></font>
Vector4 CalcPlane(Camera cam, Vector3 pos, Vector3 normal)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font></font></font><font></font>
    var viewMat = cam.worldToCameraMatrix;<font></font>
<font></font>
    var normalOnView = viewMat.MultiplyVector(normal).normalized;<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    var posOnView = viewMat.MultiplyPoint (pos);</font></font><font></font>
<font></font>
    return new Vector4(<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        normalOnView.x,</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        normalOnView.y,</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        normalOnView.z,</font></font><font></font>
        -Vector3.Dot(normalOnView, posOnView)<font></font>
        );<font></font>
}<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Virtual Camera wants to be as light as possible, so make the view frustum as narrow as possible. </font><font style="vertical-align: inherit;">Since it is only necessary to draw the range of the pair gate seen through VirtualCamera, the vertices of the pair gate mesh are set to world coordinates, and the </font></font><code class="inline-code tt">TargetCameraUtility.Update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">view frustum is </font></font><code class="inline-code tt">Camera.rect</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">changed </font><font style="vertical-align: inherit;">so that the vertices fit in </font><font style="vertical-align: inherit;">.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, since the object between the Virtual Camera and the pair gate is not drawn, make the near clip surface of the camera the same plane as the pair gate. </font></font><code class="inline-code tt">Camera.CalculateObliqueMatrix()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can do </font><font style="vertical-align: inherit;">this with </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Since there is not much documentation, it will be judged from the sample code etc., but it seems that the near clip plane is passed by Vector4 with the normal to xyz and the distance to w in the view coordinate system.</font></font></p>

<h2><a id="h7-5"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.5　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Gate drawing</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is drawn is different according to the state, but it is done with a single shader.</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a frame and a display of the contents</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Immediately after the gate is created and moved, the circle will expand.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If there is no pair gate yet, the background (existing walls and floors) will be moody ( </font></font><span class="imgref"><a href="https://freder.io/files/unity3/fuqunaga.html#id_fuqunaga_2Fgate__no__pair"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 7.6</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When the pair gate is completed, fade in to the picture of Virtual Camera from Moyamoya</font></font></li>
<li><code class="inline-code tt">PortalGate.maxGeneration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you reach and there is no Virtual Camera, paste the picture one frame before to PortalGate.</font></font></li>
</ul>
<div id="id_fuqunaga_2Fgate__no__pair" class="image">
<img src="./Chapter 7 _ Portal in Unity_files/gate_no_pair.png" alt="When there is no pair gate, the background is moody" class="width-050per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 7.6: The background is moody when there is no pair gate
</font></font></p>
</div>
<div class="emlist-code">
<p class="caption">PortalGate.shader</p>
<pre class="emlist">GrabPass<font></font>
{<font></font>
    "_BackgroundTexture"<font></font>
}<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First </font><font style="vertical-align: inherit;">, capture the background with </font><font style="vertical-align: inherit;">GrabPass </font></font><a id="fnb-grabpass" href="https://freder.io/files/unity3/fuqunaga.html#fn-grabpass" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 6</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-grabpass"><p class="footnote">[*6] https://docs.unity3d.com/ja/current/Manual/SL-GrabPass.html</p></div>

<h3><a id="h7-5-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.5.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vertex shader</font></font></h3>
<div class="emlist-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PortalGate.shader</font></font></font></font></p>
<pre class="emlist">v2f vert(appdata_img In)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font></font></font><font></font>
    v2f o;<font></font>
<font></font>
    float3 posWorld = mul(unity_ObjectToWorld, float4(In.vertex.xyz, 1)).xyz;<font></font>
    float4 clipPos = mul(UNITY_MATRIX_VP, float4(posWorld, 1));<font></font>
    float4 clipPosOnMain = mul(_MainCameraViewProj, float4(posWorld, 1));<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    o.pos = clipPos;</font></font></font></font><font></font>
    o.uv = In.texcoord;<font></font>
    o.sposOnMain = ComputeScreenPos(clipPosOnMain);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    o.grabPos = ComputeGrabScreenPos (o.pos);</font></font></font></font><font></font>
    return o;<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font></font></font><font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The vertex shader looks like this. </font><font style="vertical-align: inherit;">We are looking for two positions in the screen coordinate system, one for the current camera and one for </font></font><code class="inline-code tt">clipPos</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the main camera </font></font><code class="inline-code tt">clipPosOnMain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The former is used for normal rendering, and the latter is used for referencing RenderTexture captured by Virtual Camera. </font><font style="vertical-align: inherit;">Also, when using GrabPass, there is a dedicated position calculation function, so use this.</font></font></p>

<h3><a id="h7-5-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.5.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fragment shader</font></font></h3>
<div class="emlist-code">
<p class="caption">PortalGate.shader</p>
<pre class="emlist">float2 uv = In.uv.xy;<font></font>
uv = (uv - 0.5) * 2; // map 0~1 to -1~1<font></font>
float insideRate = (1 - length(uv)) * _OpenRate;<font></font>
</pre>
</div>
<p><code class="inline-code tt">insideRate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Inside ratio of the circle) is calculated. </font><font style="vertical-align: inherit;">The center of the circle is 1, the circumference is 0, and the outside is negative. </font></font><code class="inline-code tt">_OpenRate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can change the opening degree of the circle with. </font><font style="vertical-align: inherit;">It is controlled by </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PortalGate.Open ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="emlist-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PortalGate.shader</font></font></font></font></p>
<pre class="emlist">// background<font></font>
float4 grabUV = In.grabPos;<font></font>
float2 grabOffset = float2(<font></font>
    snoise(float3(uv, _Time.y     )),<font></font>
    snoise(float3(uv, _Time.y + 10))<font></font>
);<font></font>
grabUV.xy += grabOffset * 0.3 * insideRate;<font></font>
float4 bgColor = tex2Dproj(_BackgroundTexture, grabUV);<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is generating a moody background. </font></font><code class="inline-code tt">snoise</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is a function defined in the included Noise.cginc and is SimplexNoise. </font><font style="vertical-align: inherit;">The grab UV is rocking with the uv value and time. </font><font style="vertical-align: inherit;">By multiplying the insideRate, the fluctuation becomes larger toward the center.</font></font></p>
<div class="emlist-code">
<p class="caption">PortalGate.shader</p>
<pre class="emlist">// portal other side<font></font>
float2 sUV = In.sposOnMain.xy / In.sposOnMain.w;<font></font>
float4 sideColor = tex2D(_MainTex, sUV);<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is a picture of the other side of the gate. </font></font><code class="inline-code tt">_MainTex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contains the texture captured by the Virutual Camera and is referenced by the UV value of the main camera.</font></font></p>
<div class="emlist-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PortalGate.shader</font></font></font></font></p>
<pre class="emlist">// color<font></font>
float4 col = lerp(bgColor, sideColor, _ConnectRate);<font></font>
</pre>
</div>
<p><code class="inline-code tt">bgColor</code><font style="vertical-align: inherit;"></font><code class="inline-code tt">sideColor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I mix </font><font style="vertical-align: inherit;">(walls and floors) and </font><font style="vertical-align: inherit;">(beyond the gate). </font></font><code class="inline-code tt">_ConnectRate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transitions from 0 to 1 when a pair gate is created and remains at 1 thereafter.</font></font></p>
<div class="emlist-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PortalGate.shader</font></font></font></font></p>
<pre class="emlist">// frame<font></font>
float frame = smoothstep(0, 0.1, insideRate);<font></font>
float frameColorRate = 1 - abs(frame - 0.5) * 2;<font></font>
float mixRate = saturate(grabOffset.x + grabOffset.y);<font></font>
float3 frameColor = lerp(_FrameColor0, _FrameColor1, mixRate);<font></font>
col.xyz = lerp(col.xyz, frameColor, frameColorRate);<font></font>
<font></font>
col.a = frame;<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, the frame is calculated. </font></font><code class="inline-code tt">insideRate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The edges of are </font></font><code class="inline-code tt">_FrameColor0,_FrameColor1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">displayed by mixing them appropriately.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The appearance is completed so far. </font><font style="vertical-align: inherit;">Next, let's focus on the physical behavior.</font></font></p>

<h2><a id="h7-6"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Object Warp</font></font></h2>
<p><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Changed to</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> process around warp in </font><b><font style="vertical-align: inherit;">PortalObj component</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">GameObjects with this will be able to warp.</font></font></p>

<h3><a id="h7-6-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Disable existing collisions</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The plane on which the gate is installed cannot pass through, that is, there is a collision. </font><font style="vertical-align: inherit;">This must be disabled when passing through the gate. </font><font style="vertical-align: inherit;">Actually, the gate is equipped with a collider that pops out rather large in the front and back as a trigger. </font><font style="vertical-align: inherit;">PortalObj uses this collider as a trigger to invalidate the collision with the plane.</font></font></p>
<div id="id_fuqunaga_2Fgate__collision" class="image">
<img src="./Chapter 7 _ Portal in Unity_files/gate_collision.png" alt="Gate collider" class="width-050per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 7.7: Gate Collider
</font></font></p>
</div>
<div class="emlist-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PortalObj.cs</font></font></font></font></p>
<pre class="emlist">private void OnTriggerStay(Collider other)<font></font>
{<font></font>
    var gate = other.GetComponent&lt;PortalGate&gt;();<font></font>
    if ((gate != null) &amp;&amp; !touchingGates.Contains(gate) &amp;&amp; (gate.pair != null))<font></font>
    {<font></font>
        touchingGates.Add(gate);<font></font>
        Physics.IgnoreCollision(gate.hitColl, collider_, true);<font></font>
    }<font></font>
}<font></font>
<font></font>
private void OnTriggerExit(Collider other)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    var gate = other.GetComponent&lt;PortalGate&gt;();</font></font><font></font>
    if (gate != null)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    {</font></font></font></font><font></font>
        touchingGates.Remove(gate);<font></font>
        Physics.IgnoreCollision(gate.hitColl, collider_, false);<font></font>
    }<font></font>
}<font></font>
</pre>
</div>
<p><code class="inline-code tt">OnTriggerEnder()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><code class="inline-code tt">OnTriggerStay()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reason for this is that if there is only one gate and there is no pair, Enter will be performed and then a pair will be created. </font><font style="vertical-align: inherit;">First </font></font><code class="inline-code tt">tougingGates</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, register </font><font style="vertical-align: inherit;">the gate that triggered it in </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The above </font></font><code class="inline-code tt">PortalGate.hitColl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is finally coming out. </font></font><code class="inline-code tt">Physics.IgnoreCollision()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set </font><font style="vertical-align: inherit;">this and your collider to </font><font style="vertical-align: inherit;">ignore the collision with.</font></font></p>
<p><code class="inline-code tt">OnTriggerExit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The collision is enabled again with. </font><font style="vertical-align: inherit;">As many of you may have noticed, since </font></font><code class="inline-code tt">PortalGate.hitColl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is a collider on the entire plane, it can actually pass through even outside the frame of the Portal Gate. </font><font style="vertical-align: inherit;">The condition "as long as you keep OnTriggerStay ()" is attached, so it is not very noticeable, but it seems that a little more complicated processing is required to collide in the form of a proper gate.</font></font></p>

<h3><a id="h7-6-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Warp processing</font></font></h3>
<div class="emlist-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PortalObj.cs</font></font></p>
<pre class="emlist">private void Update()<font></font>
{<font></font>
    var passedGate = touchingGates.FirstOrDefault(gate =&gt;<font></font>
    {<font></font>
        var posOnGate = gate.transform.InverseTransformPoint(center.position);<font></font>
        return posOnGate.z &gt; 0f;<font></font>
    });<font></font>
<font></font>
<font></font>
    if (passedGate != null)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    {</font></font><font></font>
        PassGate(passedGate);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    }</font></font><font></font>
<font></font>
    if ((rigidbody_ != null) &amp;&amp; !rigidbody_.useGravity)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    {</font></font><font></font>
        if ((Time.time - ignoreGravityStartTime)  &gt; ignoreGravityTime)<font></font>
        {<font></font>
            rigidbody_.useGravity = true;<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</pre>
</div>
<p><code class="inline-code tt">center</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is a Transform used to determine if it has passed the gate. </font><font style="vertical-align: inherit;">Basically, the GameObject with PortalObj component is fine, but I want to warp my character when the camera passes, not the center of the character, so I can set it manually. </font></font><code class="inline-code tt">center.position</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We are </font><font style="vertical-align: inherit;">checking </font></font><code class="inline-code tt">z &gt; 0f</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if there is a gate </font><font style="vertical-align: inherit;">with </font><font style="vertical-align: inherit;">(behind the gate) </font></font><code class="inline-code tt">touchingGates</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If such a gate is found </font></font><code class="inline-code tt">PassGate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(warp processing).</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, as will be described later, Portal Obj disables gravity immediately after passing through the gate. </font><font style="vertical-align: inherit;">This is done to make the object behave with a little inertia after passing because if you open a gate that connects to another floor under the object that is falling on the ground, the object will vibrate back and forth between the gates. I have.</font></font></p>
<div class="emlist-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PortalObj.cs</font></font></font></font></p>
<pre class="emlist">void PassGate(PortalGate gate)<font></font>
{<font></font>
    gate.UpdateTransformOnPair(transform);<font></font>
<font></font>
    if (rigidbody_ != null)<font></font>
    {<font></font>
        rigidbody_.velocity = gate.UpdateDirOnPair(rigidbody_.velocity);<font></font>
        rigidbody_.useGravity = false;<font></font>
        ignoreGravityStartTime = Time.time;<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    }</font></font></font></font><font></font>
<font></font>
    if (fpController != null)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    {</font></font></font></font><font></font>
        fpController.m_MoveDir = gate.UpdateDirOnPair(fpController.m_MoveDir);<font></font>
        fpController.InitMouseLook();<font></font>
    }<font></font>
}<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The warp process looks like this. </font><font style="vertical-align: inherit;">I also used it to find the position of the Virtual </font></font><code class="inline-code tt">PortalGate.UpdateTransformOnPair()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Camera and warp the Transform. </font></font><code class="inline-code tt">RigidBody</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you have, change the direction of speed as well. </font></font><code class="inline-code tt">fpController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The same applies to (script for own character operation). </font><font style="vertical-align: inherit;">As this area becomes larger, there will be objects that need more support, so it may be better to prepare each script callback and notify it.</font></font></p>

<h3><a id="h7-6-3"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6.3　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Warp issues</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There was a point that I had to implement a warp this time and pack some more.</font></font></p>

<h4><a id="h7-6-3-1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PortalObj hits the wall once when the speed is fast</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I wanted to somehow nullify the collision after the physics engine made a collision detection and before extrusion, but I couldn't find a good way. </font></font><code class="inline-code tt">OnTriggerEnter()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code class="inline-code tt">OnCollisionEnter()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The inner </font></font><code class="inline-code tt">Physics.IgnoreCollision()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seems to be referred to are disabled from after a collision once. </font><font style="vertical-align: inherit;">I think </font></font><code class="inline-code tt">On~Enter()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it </font></font><code class="inline-code tt">Physics.IgnoreCollision()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'s </font><font style="vertical-align: inherit;">probably a </font><font style="vertical-align: inherit;">little late to reflect </font><font style="vertical-align: inherit;">what is called after extrusion </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">For this reason, the range of the trigger is made to protrude considerably so that the frame that enters the trigger and the frame that collides with the wall are different. </font><font style="vertical-align: inherit;">However, this method has its limitations and is not compatible with Portal Obj, which moves at a higher speed. </font><font style="vertical-align: inherit;">If anyone says "There is such a way!", Please contact me!</font></font></p>

<h4><a id="h7-6-3-2"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actually it is better to put a copy in the middle</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I </font><font style="vertical-align: inherit;">implemented the </font><font style="vertical-align: inherit;">warp by </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"rewriting the position of the object"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but strictly speaking, there should be a state where it is half in front and half behind while passing through the gate. </font><font style="vertical-align: inherit;">If you want to put out a large object, it will be noticeable, so you need to think about this as well. </font><font style="vertical-align: inherit;">In addition, it needs to be affected by collisions both in front and behind, and more strictly, I feel that we have to intervene in the solver in the physics engine. </font><font style="vertical-align: inherit;">It seems to be strict with Unity, so I feel that it is realistic to cheat well.</font></font></p>

<h2><a id="h7-7"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.7　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Summary</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I tried to reproduce Portal that I wanted to try from before with Unity. </font><font style="vertical-align: inherit;">I tried it comfortably for the first time by stacking the cameras, but I found that it was more difficult than I expected. </font><font style="vertical-align: inherit;">Among CG and game technologies, those that are closer to the real world are in high demand and are becoming more and more standardized. </font><font style="vertical-align: inherit;">When it becomes easier to create a sense of reality, Anywhere Door-like "ideas that used to be common but unrealistic and slept" may come to life as a new experience.</font></font></p>

<h2><a id="h7-8"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.8　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Reference</font></font></h2>
<ul>
<li>Portal <a href="http://www.thinkwithportals.com/" class="link">http://www.thinkwithportals.com/</a></li>
<li>Adam Character Pack <a href="https://assetstore.unity.com/packages/essentials/tutorial-projects/adam-character-pack-adam-guard-lu-74842" class="link">https://assetstore.unity.com/packages/essentials/tutorial-projects/adam-character-pack-adam-guard-lu-74842</a></li>
<li>playGROWnd <a href="https://github.com/unity3d-jp/playgrownd" class="link">https://github.com/unity3d-jp/playgrownd</a></li>
<li>PostProcessingStack <a href="https://github.com/Unity-Technologies/PostProcessing" class="link">https://github.com/Unity-Technologies/PostProcessing</a></li>
</ul><div id="goog-gt-tt" class="goog-tooltip skiptranslate" dir="ltr" style="visibility: hidden; left: 19px; top: 26.125px; display: none;"><div style="padding: 8px;"><div><div class="logo"><img src="./Chapter 7 _ Portal in Unity_files/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text">第7章　PortalをUnityで実装してみた</div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none; opacity: 0;"></div></div>


<div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 1001px; height: 263px; display: none;" src="./Chapter 7 _ Portal in Unity_files/saved_resource(1).html"></iframe><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 197px; height: 69px; display: none;" src="./Chapter 7 _ Portal in Unity_files/saved_resource(2).html"></iframe><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 1001px; height: 263px; display: none;"></iframe><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 197px; height: 69px; display: none;"></iframe><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 1001px; height: 263px; display: none;"></iframe><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 197px; height: 69px; display: none;"></iframe></body></html>