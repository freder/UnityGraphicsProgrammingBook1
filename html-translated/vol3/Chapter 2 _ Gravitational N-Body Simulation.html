<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:ops="http://www.idpf.org/2007/ops" xml:lang="en" class="translated-ltr" style="height: 100%;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <link rel="stylesheet" type="text/css" href="./Chapter 2 _ Gravitational N-Body Simulation_files/style.scss">
  <meta name="generator" content="Re:VIEW">
  <title>Gravitational N-Body Simulation</title>

			<style>
				img {
					max-width: 80vw;
					max-height: 80vh;
				}
			</style><style>
					.goog-te-banner-frame {
						display: none;
					}
				</style>
			<script>(function(){(function injection() {
  var pageLang = 'ja';
  var userLang = 'en';

  var uid = '1E07F158C6FA4460B352973E9693B329';
  var teId = 'TE_' + uid;
  var cbId = 'TECB_' + uid;

  function show() {
    window.setTimeout(function() {
      window[teId].showBanner(true);
    }, 10);
  }

  function newElem() {
    
  }

  if (window[teId]) {
    show();
  } else {
    if (!window.google || !google.translate ||
        !google.translate.TranslateElement) {
      if (!window[cbId]) {
        window[cbId] = function() {
          window[teId] = newElem();
          show();
        };
      }
      
    }
  }
})();})();</script><script src="https://translate.google.com/translate_a/element.js?cb=TECB_1E07F158C6FA4460B352973E9693B329&amp;client=tee&amp;hl=en"></script><script src="./Chapter 2 _ Gravitational N-Body Simulation_files/f.txt"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/translate_static/js/element/main.js"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="./Chapter 2 _ Gravitational N-Body Simulation_files/translateelement.css"><script type="text/javascript" charset="UTF-8" src="./Chapter 2 _ Gravitational N-Body Simulation_files/main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script><script type="text/javascript" charset="UTF-8" src="./Chapter 2 _ Gravitational N-Body Simulation_files/element_main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/translate_static/js/element/main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script></head>
		
<body style="position: relative; min-height: 100%; top: 40px;"><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div>
<h1><a id="h2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;" class="">Chapter 2　</font></font></span><font style="vertical-align: inherit;"><font class="" style="vertical-align: inherit;"> Gravitational N-Body Simulation</font></font></h1>

<h2><a id="h2-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Introduction</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this chapter, we will explain the GPU implementation method of Gravitational N-Body Simulation, which is a method of simulating the movement of celestial bodies existing in outer space.</font></font></p>
<div id="id_takao_2Fthumb" class="image">
<img src="./Chapter 2 _ Gravitational N-Body Simulation_files/thumb.png" alt="Result">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 2.1: Result
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The corresponding sample program is </font></font><br><a href="https://github.com/IndieVisualLab/UnityGraphicsProgramming3" class="link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/IndieVisualLab/UnityGraphicsProgramming3</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "Assets / NBodySimulation".</font></font></p>

<h2><a id="h2-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2 What is　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N-Body simulation?</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulations that calculate the interaction of N physical objects are collectively called N-Body simulations. </font><font style="vertical-align: inherit;">There are many types of problems using N-Body simulation, and in particular, the problem of dealing with a system in which celestial bodies scattered in outer space attract each other by gravity to form a unit </font><font style="vertical-align: inherit;">is called a </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gravity multisystem problem.</font></font></b><!-- IDX:重力多体系問題 --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I will. </font><font style="vertical-align: inherit;">The algorithm explained in this chapter corresponds to this, and it means to solve the equation of motion of the gravitational multisystem using N-Body simulation.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition to the gravity multisystem problem, N-Body simulation is also available.</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculation of intermolecular force</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analysis of dark matter</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analysis of cluster collisions</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is applied in a wide range of fields, from small to magnificent.</font></font></p>

<h2><a id="h2-3"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Algorithm</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's see what kind of mathematical formulas we will solve immediately.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The gravitational multisystem problem </font><font style="vertical-align: inherit;">can be simulated by calculating </font><font style="vertical-align: inherit;">the </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">universal gravitational</font></font></b><!-- IDX:万有引力の方程式 --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> equation, which is a familiar equation for those who are taking high school physics, for </font><font style="vertical-align: inherit;">all celestial bodies in space. </font><font style="vertical-align: inherit;">However, in high school physics, I think that it was learned with such a description because it deals only with objects that are in a straight line.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Where </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the universal gravitational force, </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the gravitational constant, </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M and m</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are the masses of the two objects, and </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the distance between the objects. </font><font style="vertical-align: inherit;">Of course, this </font><font style="vertical-align: inherit;">can only determine </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the magnitude</font></font></b><!-- IDX:力の大きさ --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of the </font><b class="kw"><font style="vertical-align: inherit;">force</font></b><font style="vertical-align: inherit;"> (scalar amount) </font><font style="vertical-align: inherit;">between two objects </font><font style="vertical-align: inherit;">.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this implementation, it is necessary to consider the movement in the 3D space inside Unity, so a </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vector quantity</font></font></b><!-- IDX:ベクトル量 --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indicating the direction </font><font style="vertical-align: inherit;">is required. </font><font style="vertical-align: inherit;">Therefore, in </font><font style="vertical-align: inherit;">order to find the vector of the force generated between </font><font style="vertical-align: inherit;">two celestial bodies ( </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i, j</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), the equation of universal gravitational force is described as follows.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here, </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ mbox {\ boldmath $ f $} _ {ij}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the vector of the force that the object i receives from the object j, </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m_i and m_j</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are </font><span class="equation"><font style="vertical-align: inherit;">the masses</font></span><font style="vertical-align: inherit;"> of the two objects, and </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r_ {ij}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the object </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the object </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j.</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Direction vector to. </font><font style="vertical-align: inherit;">On the left side of the right side, the magnitude of the force is calculated in the same way as the equation of universal gravitational force that first appeared, and it is vectorized by multiplying the unit vector in the direction of receiving the force on the right side of the right side.</font></font></p>
<div id="id_takao_2Fvec" class="image">
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">missing image: takao / vec</font></font></font></font></pre>
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure: Meaning of formula
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Furthermore, if </font><font style="vertical-align: inherit;">the magnitude of the force that </font><font style="vertical-align: inherit;">one object ( </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) receives from all the surrounding </font><font style="vertical-align: inherit;">objects, not between two objects, is </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ mbox {\ boldmath $ F $} _ {i}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it can be calculated as follows. ..</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As shown in the formula, the force received from the surrounding celestial bodies can be calculated by taking the sum of all universal gravitational forces.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, to simplify the simulation, </font><font style="vertical-align: inherit;">the equation can be rewritten using the </font><font style="vertical-align: inherit;">Softening factor </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ varepsilon</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as follows.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This makes it possible to ignore collisions even if the celestial bodies come to the same position (even if they calculate themselves, the result in Sigma </font><font style="vertical-align: inherit;">will be </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, using the second law of motion </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m \ mbox {\ boldmath $ a $} = \ mbox {\ boldmath $ f $},</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we will convert the force vector into the acceleration vector. </font><font style="vertical-align: inherit;">First, we transform the second law of motion into the following equation.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, by substituting the above transformation equation into the equation of motion of the gravitational multisystem and rewriting it, the acceleration received by the celestial body can be calculated.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The simulation is now ready. </font><font style="vertical-align: inherit;">Now that we were able to express the gravitational multisystem problem with mathematical formulas, how can we incorporate these mathematical formulas into our program? </font><font style="vertical-align: inherit;">I would like to explain it firmly in the next section.</font></font></p>

<h2><a id="h2-4"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.4　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Difference method</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The above equation (\ ref {eq: newton}) is </font><font style="vertical-align: inherit;">classified as a </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">differential equation</font></font></b><!-- IDX:微分方程式 --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> among the equations </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Because, in the physical world, </font><font style="vertical-align: inherit;">the relationship between </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">position, velocity, and acceleration</font></font></b><!-- IDX:位置、速度、加速度 --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is as shown in the following image, and since acceleration is the second derivative of the position function, it is called a differential equation as it is.</font></font></p>
<div id="id_takao_2Fdiff" class="image">
<pre class="dummyimage"></pre>
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 2.2: Relationship between position, velocity, and acceleration
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are various methods for solving differential equations with a computer, but the most common one </font><font style="vertical-align: inherit;">is the algorithm called the </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">difference method</font></font></b><!-- IDX:差分法 --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Let's start with a review of differentiation.</font></font></p>

<h3><a id="h2-4-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.4.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Differentiation</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, let's review the definition of mathematical differentiation. </font><font style="vertical-align: inherit;">The derivative of the </font><font style="vertical-align: inherit;">function </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f (t)</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is defined by the following equation.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since it is difficult to understand what is shown by the formula alone, it becomes as follows when replaced with a graph.</font></font></p>
<div id="id_takao_2Fgraph" class="image">
<pre class="dummyimage"></pre>
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 2.3: Forward difference
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You already know that </font><font style="vertical-align: inherit;">the differential value of the function is </font><font style="vertical-align: inherit;">the slope of the graph at </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t_n</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">After all, this graph </font><font style="vertical-align: inherit;">shows the state that </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ Delta t</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is made infinitely small to </font><font style="vertical-align: inherit;">calculate the slope, </font><font style="vertical-align: inherit;">and you can see that it represents the formula (\ ref {eq: delta}) itself. think.</font></font></p>

<h3><a id="h2-4-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.4.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Difference</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You cannot handle "infinity" as a numerical value on a computer. </font><font style="vertical-align: inherit;">Therefore, </font><font style="vertical-align: inherit;">we will approximate it with a </font><font style="vertical-align: inherit;">finite </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ Delta t</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that is </font><font style="vertical-align: inherit;">as small as possible </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">With that in mind, if we rewrite the definition of differentiation to difference, we get the following equation.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It's a shape that has taken the limit as it is. </font><font style="vertical-align: inherit;">I think it's okay to recognize that </font><font style="vertical-align: inherit;">"an infinitesimal </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ Delta t</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cannot be represented on a computer, so </font><font style="vertical-align: inherit;">stop </font><font style="vertical-align: inherit;">at a certain size </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ Delta t</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to approximate it."</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here, the </font><font style="vertical-align: inherit;">physical representation </font><font style="vertical-align: inherit;">of </font></font><span class="imgref"><a href="https://freder.io/files/unity3/takao.html#id_takao_2Fdiff"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 2.2</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> above </font><font style="vertical-align: inherit;">is as follows.</font></font></p>
<div id="id_takao_2Fdiff2" class="image">
<pre class="dummyimage"></pre>
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 2.4: Relationship between position, velocity, and acceleration (mathematical formula)
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, the formula (\ ref {eq: diffuse}) is </font><font style="vertical-align: inherit;">compared </font><font style="vertical-align: inherit;">to </font></font><span class="imgref"><a href="https://freder.io/files/unity3/takao.html#id_takao_2Fdiff2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 2.4</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as follows:</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Furthermore, when the formulas (\ ref {eq: x}) and (\ ref {eq: v}) are combined, the result is as follows.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This formula means that </font><font style="vertical-align: inherit;">" </font><font style="vertical-align: inherit;">the position coordinates after </font><span class="equation"><font style="vertical-align: inherit;">\ Delta t</font></span><font style="vertical-align: inherit;"> seconds </font><font style="vertical-align: inherit;">from </font><font style="vertical-align: inherit;">the current time </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be calculated if the acceleration and velocity of the current time are known." </font><font style="vertical-align: inherit;">This is the basic idea when simulating with the finite difference method. </font><font style="vertical-align: inherit;">In addition, the expression of such a differential equation using the difference method </font><font style="vertical-align: inherit;">is called </font><font style="vertical-align: inherit;">a </font><b class="kw"><font style="vertical-align: inherit;">difference equation (recurrence formula)</font></b><font style="vertical-align: inherit;"> .</font></font><span class="equation"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"></font><b class="kw"><font style="vertical-align: inherit;"></font></b><!-- IDX:差分方程式(漸化式) --><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When actually performing real-time simulation by the difference method, it </font><font style="vertical-align: inherit;">is common to set </font><font style="vertical-align: inherit;">the minute time </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ Delta t</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (time step) to the drawing time of one frame (1/60 second at 60 fps).</font></font></p>

<h2><a id="h2-5"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.5　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> implementation</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now, let's get into the implementation. </font><font style="vertical-align: inherit;">The corresponding scene will be "SimpleNBodySimulation.unity".</font></font></p>

<h3><a id="h2-5-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.5.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CPU side program</font></font></h3>

<h4><a id="h2-5-1-1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data structure of celestial bodies</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First of all, we define the data structure of celestial particles. </font><font style="vertical-align: inherit;">Looking at the equation (\ ref {eq: delta}), we can see that the physical quantities that one celestial body should have are "position, velocity, mass". </font><font style="vertical-align: inherit;">Therefore, it seems good to define the following structure.</font></font></p>
<div class="emlist-code">
<p class="caption">Body.cs</p>
<pre class="emlist">public struct Body<font></font>
{<font></font>
  public Vector3 position;<font></font>
  public Vector3 velocity;<font></font>
  public float mass;<font></font>
}<font></font>
</pre>
</div>

<h4><a id="h2-5-1-2"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preparing the buffer</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, set the number of particles you want to generate from the inspector, and secure a buffer for that number. </font><font style="vertical-align: inherit;">Separate buffers for reading and writing to prevent data race conditions.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, the number of bytes per structure can be obtained with the "Marshal.SizeOf (Type t)" function in the "System.Runtime.InteropServices" namespace.</font></font></p>
<div class="emlist-code">
<p class="caption">SimpleNBodySimulation.cs</p>
<pre class="emlist">void InitBuffer()<font></font>
{<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Create buffer (for Read / Write) → Conflict prevention</font></font><font></font>
  bodyBuffers = new ComputeBuffer[2];<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Each element creates a buffer of Body structure for the number of particles</font></font><font></font>
  bodyBuffers[READ] = new ComputeBuffer(numBodies,<font></font>
    Marshal.SizeOf(typeof(Body)));<font></font>
<font></font>
  bodyBuffers[WRITE] = new ComputeBuffer(numBodies,<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    Marshal.SizeOf(typeof(Body)));</font></font></font></font><font></font>
}<font></font>
</pre>
</div>

<h4><a id="h2-5-1-3"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initial placement of celestial bodies</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then place the particles in space. </font><font style="vertical-align: inherit;">First, create an array for the particles and give each element an initial value of the physical quantity. </font><font style="vertical-align: inherit;">In the sample, the inside of the sphere was randomly sampled as the initial position, the velocity was 0, and the mass was randomly given.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, set the buffer for the created array and you are ready </font></font><a id="fnb-scaling" href="https://freder.io/files/unity3/takao.html#fn-scaling" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-scaling"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 1] * For look adjustment, we have prepared a variable that can scale the position coordinates, but you do not have to worry because it has already been adjusted.</font></font></p></div>
<div class="emlist-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleNBodySimulation.cs</font></font></font></font></p>
<pre class="emlist">void DistributeBodies()<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font></font></font><font></font>
  Random.InitState(seed);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // For look adjustment</font></font><font></font>
  float scale = positionScale<font></font>
                * Mathf.Max(1, numBodies / DEFAULT_PARTICLE_NUM);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Prepare an array to set in the buffer</font></font><font></font>
  Body[] bodies = new Body[numBodies];<font></font>
<font></font>
  int i = 0;<font></font>
  while (i &lt; numBodies)<font></font>
  {<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Sampling inside the sphere</font></font><font></font>
    Vector3 pos = Random.insideUnitSphere;<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // set in an array</font></font><font></font>
    bodies[i].position = pos * scale;<font></font>
    bodies[i].velocity = Vector3.zero;<font></font>
    bodies[i].mass = Random.Range(0.1f, 1.0f);<font></font>
<font></font>
<font></font>
    i++;<font></font>
  }<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Set the array in the buffer</font></font><font></font>
  bodyBuffers[READ].SetData(bodies);<font></font>
  bodyBuffers[WRITE].SetData(bodies);<font></font>
<font></font>
}<font></font>
</pre>
</div>

<h4><a id="h2-5-1-4"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation routine</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, we will actually move the simulation. </font><font style="vertical-align: inherit;">The following code is the part that is executed every frame.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, set the value in the constant buffer of ComputeShader. </font><font style="vertical-align: inherit;">For </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ Delta t of the</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> difference equation, </font><font style="vertical-align: inherit;">use "Time.deltaTime" provided by Unity. </font><font style="vertical-align: inherit;">In addition, due to the implementation of GPU, the number of threads and the number of thread blocks are also transferred.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the calculation is completed, the calculation result of the simulation is stored in the buffer for writing, so the buffer is replaced in the last line so that it can be used as the buffer for reading in the next frame.</font></font></p>
<div class="emlist-code">
<p class="caption">SimpleNBodySimulation.cs</p>
<pre class="emlist">void Update()<font></font>
{<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Transfer constants to compute shader</font></font><font></font>
  // Δt<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  NBodyCS.SetFloat ("_ DeltaTime", Time.deltaTime);</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Speed ​​attenuation rate</font></font><font></font>
  NBodyCS.SetFloat("_Damping", damping);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Softening factor</font></font><font></font>
  NBodyCS.SetFloat("_SofteningSquared", softeningSquared);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Number of particles</font></font><font></font>
  NBodyCS.SetInt("_NumBodies", numBodies);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Number of threads per block</font></font><font></font>
  NBodyCS.SetVector("_ThreadDim",<font></font>
    new Vector4(SIMULATION_BLOCK_SIZE, 1, 1, 0));<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Number of blocks</font></font><font></font>
  NBodyCS.SetVector("_GroupDim",<font></font>
  new Vector4(Mathf.CeilToInt(numBodies / SIMULATION_BLOCK_SIZE), 1, 1, 0));<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Transfer the buffer address</font></font><font></font>
  NBodyCS.SetBuffer(0, "_BodiesBufferRead", bodyBuffers[READ]);<font></font>
  NBodyCS.SetBuffer(0, "_BodiesBufferWrite", bodyBuffers[WRITE]);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Compute shader execution</font></font><font></font>
  NBodyCS.Dispatch(0,<font></font>
    Mathf.CeilToInt(numBodies / SIMULATION_BLOCK_SIZE), 1, 1);<font></font>
<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Swap Read / Write (conflict prevention)</font></font><font></font>
  Swap(bodyBuffers);<font></font>
}<font></font>
</pre>
</div>

<h4><a id="h2-5-1-5"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rendering</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the simulation calculation, issue an instance drawing instruction to the material that renders the particles. </font><font style="vertical-align: inherit;">When rendering a particle, it is necessary to give the position coordinates of the particle to the shader, so transfer the calculated buffer to the shader for rendering.</font></font></p>
<div class="emlist-code">
<p class="caption">ParticleRenderer.cs</p>
<pre class="emlist"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void OnRenderObject ()</font></font></font></font><font></font>
{<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  particleRenderMat.SetPass (0);</font></font></font></font><font></font>
  particleRenderMat.SetBuffer("_Particles"", bodyBuffers[READ]);<font></font>
<font></font>
  Graphics.DrawProcedural(MeshTopology.Points, numBodies);<font></font>
}<font></font>
</pre>
</div>

<h3><a id="h2-5-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.5.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GPU side program</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In N-Body simulation, it is necessary to calculate the interaction with all particles, so if it is calculated simply, the execution time will be </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O (n ^ 2)</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and performance cannot be achieved. </font><font style="vertical-align: inherit;">Therefore, I will utilize the usage of Shared Memory described in Chapter 3 of UnityGraphicsProgramming Vol1.</font></font></p>

<h4><a id="h2-5-2-1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Way of thinking</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data in the same block is stored in shared memory, which speeds up I / O. </font><font style="vertical-align: inherit;">The following is a conceptual diagram that resembles a thread block as a tile.</font></font></p>
<div id="id_takao_2Ftile" class="image">
<pre class="dummyimage"></pre>
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 2.5: Tile concept
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here, the row is the global thread (DispatchThreadID) that is running, and the column is the particle that is being exhausted in the thread. </font><font style="vertical-align: inherit;">It's like the columns you're running are shifting one by one to the right over time.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, the total number of tiles executed at the same time is (number of particles / number of threads in the group). </font><font style="vertical-align: inherit;">In the sample, the number of threads in the block is 256 (SIMULATION_BLOCK_SIZE), so it is recognized that the tile content is actually 256x256 instead of 5x5.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All rows are running in parallel, but because they share data within the tile, they wait until all the columns running in the tile reach Sync (do not go to the right of the Sync layer). </font><font style="vertical-align: inherit;">After reaching the Sync layer, the data of the next tile is reloaded into the shared memory.</font></font></p>

<h4><a id="h2-5-2-2"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preparing a constant buffer</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Describe the constant buffer for receiving the input from the CPU in the Compute Shader.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, prepare a buffer for storing particle data. </font><font style="vertical-align: inherit;">This time, the Body structure is summarized in "Body.cginc". </font><font style="vertical-align: inherit;">It is convenient to put together cginc for things that are likely to be reused later.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, make a declaration to use shared memory.</font></font></p>
<div class="emlist-code">
<p class="caption">SimpleNBodySimulation.compute</p>
<pre class="emlist">#include "Body.cginc"<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// constant</font></font><font></font>
cbuffer cb {<font></font>
        float   _SofteningSquared, _DeltaTime, _Damping;<font></font>
        uint    _NumBodies;<font></font>
        float4  _GroupDim, _ThreadDim;<font></font>
};<font></font>
<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Particle buffer</font></font><font></font>
StructuredBuffer&lt;Body&gt; _BodiesBufferRead;<font></font>
RWStructuredBuffer&lt;Body&gt; _BodiesBufferWrite;<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Shared memory (shared within the block)</font></font><font></font>
groupshared Body sharedBody[SIMULATION_BLOCK_SIZE];<font></font>
</pre>
</div>

<h4><a id="h2-5-2-3"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tile implementation</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, implement the tile.</font></font></p>
<div class="emlist-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleNBodySimulation.compute</font></font></font></font></p>
<pre class="emlist">float3 computeBodyForce(Body body, uint3 groupID, uint3 threadID)<font></font>
{<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  uint start = 0; // start</font></font><font></font>
  uint finish = _NumBodies;<font></font>
<font></font>
  float3 acc = (float3)0;<font></font>
  int currentTile = 0;<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Execute for the number of tiles (number of blocks)</font></font><font></font>
  for (uint i = start; i &lt; finish; i += SIMULATION_BLOCK_SIZE)<font></font>
  {<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Store in shared memory</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // sharedBody [thread ID in block]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // = _BodiesBufferRead [tile ID * total number of threads in block + thread ID]</font></font><font></font>
    sharedBody[threadID.x]<font></font>
      = _BodiesBufferRead[wrap(groupID.x + currentTile, _GroupDim.x)<font></font>
        * SIMULATION_BLOCK_SIZE + threadID.x];<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Group sync</font></font><font></font>
    GroupMemoryBarrierWithGroupSync();<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Calculate the effect of gravity from the surroundings</font></font><font></font>
    acc = gravitation(body, acc, threadID);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    GroupMemoryBarrierWithGroupSync();</font></font></font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    currentTile ++; // Go to the next tile</font></font><font></font>
  }<font></font>
<font></font>
  return acc;<font></font>
<font></font>
}<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Put the image of the for loop in the code in the next image.</font></font></p>
<div id="id_takao_2Ftile__uni" class="image">
<pre class="dummyimage"></pre>
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 2.6: Tile ID for loop
</font></font></p>
</div>

<h4><a id="h2-5-2-4"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interaction calculation</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since we controlled the movement of the tile in the previous loop, we </font><font style="vertical-align: inherit;">will implement </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the for loop in the tile</font></font></b><!-- IDX:タイルの中でのforループ --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> this time </font><font style="vertical-align: inherit;">.</font></font></p>
<div class="emlist-code">
<p class="caption">SimpleNBodySimulation.compute</p>
<pre class="emlist">float3 gravitation(Body body, float3 accel, uint3 threadID)<font></font>
{<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // 100% survey</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Execute for the number of threads in the block</font></font><font></font>
  for (uint i = 0; i &lt; SIMULATION_BLOCK_SIZE;)<font></font>
  {<font></font>
    accel = bodyBodyInteraction(accel, sharedBody[i], body);<font></font>
    i++;<font></font>
  }<font></font>
<font></font>
  return accel;<font></font>
}<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This completes the 100% survey in the tile. </font><font style="vertical-align: inherit;">Also, at the timing after the return of this function, it waits until all the threads in the tile complete the process.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then implement the expression (\ ref {eq: first}) as follows:</font></font></p>
<div class="emlist-code">
<p class="caption">SimpleNBodySimulation.compute</p>
<pre class="emlist"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Calculation in Sigma</font></font><font></font>
float3 bodyBodyInteraction(float3 acc, Body b_i, Body b_j)<font></font>
{<font></font>
  float3 r = b_i.position - b_j.position;<font></font>
<font></font>
  // distSqr = dot(r_ij, r_ij) + EPS^2<font></font>
  float distSqr = r.x * r.x + r.y * r.y + r.z * r.z;<font></font>
  distSqr += _SofteningSquared;<font></font>
<font></font>
  // invDistCube = 1/distSqr^(3/2)<font></font>
  float distSixth = distSqr * distSqr * distSqr;<font></font>
  float invDistCube = 1.0f / sqrt(distSixth);<font></font>
<font></font>
  // s = m_j * invDistCube<font></font>
  float s = b_j.mass * invDistCube;<font></font>
<font></font>
  // a_i =  a_i + s * r_ij<font></font>
  acc += r * s;<font></font>
<font></font>
  return acc;<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font></font></font><font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This completes the program for calculating the total acceleration.</font></font></p>

<h4><a id="h2-5-2-5"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Update position with finite difference method</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, the coordinates and velocity of the particles in the next frame are calculated using the acceleration calculated so far.</font></font></p>
<div class="emlist-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleNBodySimulation.compute</font></font></font></font></p>
<pre class="emlist">[numthreads(SIMULATION_BLOCK_SIZE,1,1)]<font></font>
void CSMain (<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        uint3 groupID: SV_GroupID, // Group ID</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        uint3 threadID: SV_GroupThreadID, // Thread ID in the group</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        uint3 DTid: SV_DispatchThreadID // Global Thread ID</font></font><font></font>
) {<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        // Current global thread index</font></font><font></font>
        uint index = DTid.x;<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        // Read particles from buffer</font></font><font></font>
        Body body = _BodiesBufferRead[index];<font></font>
<font></font>
        float3 force = computeBodyForce(body, groupID, threadID);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        body.velocity + = force * _DeltaTime;</font></font></font></font><font></font>
        body.velocity *= _Damping;<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        // Difference</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        body.position + = body.velocity * _DeltaTime;</font></font></font></font><font></font>
<font></font>
        _BodiesBufferWrite[index] = body;<font></font>
<font></font>
}<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The position coordinates of the celestial body have been updated. </font><font style="vertical-align: inherit;">This completes the simulation of the movement of the celestial body!</font></font></p>

<h2><a id="h2-6"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.6　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to render grains</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this section, </font><font style="vertical-align: inherit;">I would like to supplement the drawing method of GPU particles, which was insufficiently explained </font><font style="vertical-align: inherit;">in the previous </font><font style="vertical-align: inherit;">article </font></font><a id="fnb-ugp1" href="https://freder.io/files/unity3/takao.html#fn-ugp1" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-ugp1"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 2] The same particle rendering is performed in "Unity Graphics Programming Vol.1-Chapter 5 Fluid Simulation by SPH Method".</font></font></p></div>

<h3><a id="h2-6-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.6.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Billboard</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A billboard is a simple planar object that always faces the camera. </font><font style="vertical-align: inherit;">It is no exaggeration to say that most particle systems in the world are implemented by billboards. </font><font style="vertical-align: inherit;">In order to implement the billboard simply, we need to make good use of the view transformation matrix.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The view transformation matrix contains numerical information that returns the camera position and rotation to the origin. </font><font style="vertical-align: inherit;">In other words, by multiplying all the objects in space by the view transformation matrix, it is transformed into a coordinate system with the camera as the origin.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, </font><font style="vertical-align: inherit;">for a billboard that has the characteristic </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">of facing the direction of</font></font></b><!-- IDX:カメラの方向を向く --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the </font><b class="kw"><font style="vertical-align: inherit;">camera,</font></b><font style="vertical-align: inherit;"> it seems that </font><font style="vertical-align: inherit;">the </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inverse matrix of the</font></font></b><!-- IDX:逆行列 --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> view transformation matrix containing only the rotation information </font><font style="vertical-align: inherit;">should be multiplied as the model transformation matrix. </font><font style="vertical-align: inherit;">(Although it will be described later, it is difficult to understand, so the </font><font style="vertical-align: inherit;">illustration is </font></font><span class="imgref"><a href="https://freder.io/files/unity3/takao.html#id_takao_2Fbillboard"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shown in Figure 2.8</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .)</font></font></p>

<h4><a id="h2-6-1-1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Billboard implementation</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First of all, create a Quad mesh to draw the particles. </font><font style="vertical-align: inherit;">This can be easily achieved by extending one vertex to a Quad parallel to the xy plane with a geometry shader </font></font><a id="fnb-ugpgeo" href="https://freder.io/files/unity3/takao.html#fn-ugpgeo" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-ugpgeo"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 3] For a detailed explanation of geometry shaders, see UnityGraphicsProgramming Vol.1 "Growing grass with geometry shaders".</font></font></p></div>
<div id="id_takao_2Fbill" class="image">
<img src="./Chapter 2 _ Gravitational N-Body Simulation_files/bill.jpg" alt="Quad extension with Geometry Shader" class="width-090per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 2.7: Quad extension with Geometry Shader
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If </font><font style="vertical-align: inherit;">you give </font><font style="vertical-align: inherit;">this quad an inverse matrix </font></font><a id="fnb-inverse" href="https://freder.io/files/unity3/takao.html#fn-inverse" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 4</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that cancels the translation component of the view transformation matrix </font><font style="vertical-align: inherit;">as a model transformation matrix, you can create a quad that faces the camera on the spot.</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-inverse"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 4] Since it is known that the inverse matrix of the view transformation matrix can be simply transposed, it is implemented here by transposing.</font></font></p></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I don't know what you're talking about, so here's an explanatory diagram.</font></font></p>
<div id="id_takao_2Fbillboard" class="image">
<pre class="dummyimage"></pre>
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 2.8: How the billboard works
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Furthermore, by applying a view and projection matrix to the billboard facing the camera, it can be converted to the coordinates on the screen. </font><font style="vertical-align: inherit;">The shader that implements these is shown below.</font></font></p>
<div class="emlist-code">
<p class="caption">ParticleRenderer.shader</p>
<pre class="emlist">[maxvertexcount(4)]<font></font>
void geom(point v2g input[1], inout TriangleStream&lt;g2f&gt; outStream) {<font></font>
  g2f o;<font></font>
<font></font>
  float4 pos = input[0].pos;<font></font>
<font></font>
  float4x4 billboardMatrix = UNITY_MATRIX_V;<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  // Take out only the rotating component</font></font><font></font>
  billboardMatrix._m03 = billboardMatrix._m13 =<font></font>
    billboardMatrix._m23 = billboardMatrix._m33 = 0;<font></font>
<font></font>
  for (int x = 0; x &lt; 2; x++) {<font></font>
    for (int y = 0; y &lt; 2; y++) {<font></font>
      float2 uv = float2(x, y);<font></font>
      o.uv = uv;<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      o.pos = pos</font></font><font></font>
        + mul(transpose(billboardMatrix), float4((uv * 2 - float2(1, 1))<font></font>
        * _Scale, 0, 1));<font></font>
<font></font>
      o.pos = mul(UNITY_MATRIX_VP, o.pos);<font></font>
<font></font>
      o.id = input[0].id;<font></font>
<font></font>
      outStream.Append(o);<font></font>
    }<font></font>
  }<font></font>
<font></font>
  outStream.RestartStrip();<font></font>
}<font></font>
<font></font>
</pre>
</div>

<h2><a id="h2-7"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.7　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Results</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's see the result of the above simulation.</font></font></p>
<div id="id_takao_2Fsimple" class="image">
<img src="./Chapter 2 _ Gravitational N-Body Simulation_files/simple.png" alt="Simulation result (feeling of korejanai ...)">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 2.9: Simulation results (feeling of korejanai ...)
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Looking at the movement, all the particles are gathered in the center, which is not visually interesting. </font><font style="vertical-align: inherit;">Therefore, we will add some ideas in the next section.</font></font></p>

<h2><a id="h2-8"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.8　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ingenuity to make it visually interesting</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The corresponding scene is "NBodySimulation.unity". </font><font style="vertical-align: inherit;">Even if it is a device, there is only one line to change, and the tile calculation part will be cut off in the middle as follows.</font></font></p>
<div class="emlist-code">
<p class="caption">NBodySimulation.compute</p>
<pre class="emlist">float3 computeBodyForce(Body body, uint3 groupID, uint3 threadID)<font></font>
{<font></font>
  ・・・<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  uint finish = _NumBodies / div; // Cut in the middle</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ・・・</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result, the calculation of the interaction is discarded in the middle without being exhausted, but as a result, it is not affected by all the particles, so some particle lumps are generated and aggregated into one point. Will never happen.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then, the interaction between the parts of multiple masses </font><font style="vertical-align: inherit;">produces a more dynamic movement as </font></font><span class="imgref"><a href="https://freder.io/files/unity3/takao.html#id_takao_2Fthumb"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shown in Figure 2.1</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at the beginning </font><font style="vertical-align: inherit;">.</font></font></p>

<h2><a id="h2-9"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.9　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Summary</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this chapter, we explained the GPU implementation method of Gravitational N-Body Simulation. </font><font style="vertical-align: inherit;">From small atoms to the large universe, the potential of N-Body simulation is infinite. </font><font style="vertical-align: inherit;">Why don't you try to create your own universe on Unity? </font><font style="vertical-align: inherit;">I hope you can help me even a little!</font></font></p>

<h2><a id="h2-10"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.10　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Reference</font></font></h2>
<ul>
<li>GPU Gems 3 - Chapter 31. Fast N-Body Simulation with CUDA</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What can be learned from N-body simulation? </font><font style="vertical-align: inherit;">--Michiko Fujii, Kagoshima University </font></font><a href="http://www.astro-wakate.org/ss2011/web/ss11_proceedings/proceeding/galaxy_fujii.pdf" class="link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.astro-wakate.org/ss2011/web/ss11_proceedings/proceeding/galaxy_fujii.pdf</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quaternion and Billboard-wgld.org </font></font><a href="https://wgld.org/d/webgl/w035.html" class="link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://wgld.org/d/webgl/w035.html</font></font></a></li>
</ul><div id="goog-gt-tt" class="goog-tooltip skiptranslate" dir="ltr" style="visibility: hidden; left: 34px; top: 27.125px; display: none;"><div style="padding: 8px;"><div><div class="logo"><img src="./Chapter 2 _ Gravitational N-Body Simulation_files/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text">第2章　Gravitational N-Body Simulation</div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none; opacity: 0;"></div></div>


<div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 1001px; height: 263px; display: none;" src="./Chapter 2 _ Gravitational N-Body Simulation_files/saved_resource(1).html"></iframe><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 197px; height: 69px; display: none;" src="./Chapter 2 _ Gravitational N-Body Simulation_files/saved_resource(2).html"></iframe><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 1001px; height: 263px; display: none;"></iframe><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 197px; height: 69px; display: none;"></iframe><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 1001px; height: 263px; display: none;"></iframe><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 197px; height: 69px; display: none;"></iframe></body></html>