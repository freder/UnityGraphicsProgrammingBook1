<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:ops="http://www.idpf.org/2007/ops" xml:lang="en" style="height: 100%;" class="translated-ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <link rel="stylesheet" type="text/css" href="./Chapter 5 _ Fluid Simulation by SPH Method_files/style.scss">
  <meta name="generator" content="Re:VIEW">
  <title>Fluid simulation by SPH method</title>

			<style>
				img {
					max-width: 80vw;
					max-height: 80vh;
				}
			</style><style>
					.goog-te-banner-frame {
						display: none;
					}
				</style>
			<script>(function(){(function injection() {
  var pageLang = 'ja';
  var userLang = 'en';

  var uid = '1E07F158C6FA4460B352973E9693B329';
  var teId = 'TE_' + uid;
  var cbId = 'TECB_' + uid;

  function show() {
    window.setTimeout(function() {
      window[teId].showBanner(true);
    }, 10);
  }

  function newElem() {
    
  }

  if (window[teId]) {
    show();
  } else {
    if (!window.google || !google.translate ||
        !google.translate.TranslateElement) {
      if (!window[cbId]) {
        window[cbId] = function() {
          window[teId] = newElem();
          show();
        };
      }
      
    }
  }
})();})();</script><script src="https://translate.google.com/translate_a/element.js?cb=TECB_1E07F158C6FA4460B352973E9693B329&amp;client=tee&amp;hl=en"></script><script src="./Chapter 5 _ Fluid Simulation by SPH Method_files/f.txt"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/translate_static/js/element/main.js"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="./Chapter 5 _ Fluid Simulation by SPH Method_files/translateelement.css"><script type="text/javascript" charset="UTF-8" src="./Chapter 5 _ Fluid Simulation by SPH Method_files/main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script><script type="text/javascript" charset="UTF-8" src="./Chapter 5 _ Fluid Simulation by SPH Method_files/element_main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/translate_static/js/element/main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script></head>
		
<body style="position: relative; min-height: 100%; top: 40px;"><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div>
<h1><a id="h5"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapter 5　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fluid Simulation by SPH Method</font></font></h1>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the previous chapter, we explained how to create a fluid simulation using the grid method. </font><font style="vertical-align: inherit;">In this chapter, we will use the particle method, which is another fluid simulation method, especially the SPH method, to express the movement of the fluid. </font><font style="vertical-align: inherit;">Please note that there are some inadequate expressions as the explanation is given in a slightly chewed manner.</font></font></p>

<h2><a id="h5-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Basic knowledge</font></font></h2>

<h3><a id="h5-1-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Euler's perspective and Lagrange's perspective</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are Euler's viewpoint and Lagrange's viewpoint as the method of observing the movement of fluid. </font><font style="vertical-align: inherit;">Euler's viewpoint is to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fix</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> observation points on the fluid at equal intervals </font><font style="vertical-align: inherit;">and analyze the movement of the fluid at the observation points. </font><font style="vertical-align: inherit;">On the other hand, the Lagrange viewpoint is to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">float</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> an </font><font style="vertical-align: inherit;">observation point that moves along the flow </font><font style="vertical-align: inherit;">of fluid and observe the movement of the fluid at that observation point ( </font><font style="vertical-align: inherit;">see </font></font><span class="imgref"><a href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#lagrange"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 5.1</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Basically, the fluid simulation method using Euler's viewpoint is called the lattice method, and the fluid simulation method using Lagrange's viewpoint is called the particle method.</font></font></p>
<div id="lagrange" class="image">
<img src="./Chapter 5 _ Fluid Simulation by SPH Method_files/lagrange.png" alt="Left: Euler-like, Right: Lagrange-like" class="width-070per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 5.1: Left: Euler-like, Right: Lagrange-like
</font></font></p>
</div>

<h3><a id="h5-1-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lagrange derivative (material derivative)</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The method of calculating the derivative differs between the Euler perspective and the Lagrange perspective. </font></font><a id="fnb-quantity" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#fn-quantity" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">the physical quantity </font><a id="fnb-quantity" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#fn-quantity" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;">* 1</font></a><font style="vertical-align: inherit;"> expressed from Euler's point of view </font><font style="vertical-align: inherit;">is shown below.</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-quantity"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 1] Physical quantities refer to observable velocities and masses. </font><font style="vertical-align: inherit;">In short, you can think of it as something that has a unit.</font></font></p></div>
<div class="equation">
<pre>  \phi = \phi (\overrightarrow{x}, t)
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This </font><font style="vertical-align: inherit;">means the </font><font style="vertical-align: inherit;">physical quantity </font><span class="equation"><font style="vertical-align: inherit;">\ phi</font></span><font style="vertical-align: inherit;"> at the position </font><span class="equation"><font style="vertical-align: inherit;">\ overrightarrow {x}</font></span><font style="vertical-align: inherit;"> at </font><font style="vertical-align: inherit;">time </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The time derivative of this physical quantity is</font></font><span class="equation"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"></font><span class="equation"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"></font></p>
<div class="equation">
<pre>  \frac{\partial \phi}{\partial t}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Can be expressed as. </font><font style="vertical-align: inherit;">Of course, this is </font><font style="vertical-align: inherit;">a derivative from Euler's point of view because </font><font style="vertical-align: inherit;">the position of the physical quantity is </font><font style="vertical-align: inherit;">fixed by </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ overridearrow {x}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-advect"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 2] The movement of the observation point along the flow is called advection.</font></font></p></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the other hand, from the Lagrange perspective </font><font style="vertical-align: inherit;">, the observation point itself is a function of time because </font><font style="vertical-align: inherit;">it moves </font></font><a id="fnb-advect" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#fn-advect" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> along the flow </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Therefore, </font><font style="vertical-align: inherit;">the observation point </font><font style="vertical-align: inherit;">at </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ overrightarrow {x} _0</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in </font><font style="vertical-align: inherit;">the initial state </font><font style="vertical-align: inherit;">is at time </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="equation">
<pre>  \overrightarrow{x}(\overrightarrow{x}_0, t)
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exists in. </font><font style="vertical-align: inherit;">Therefore, the notation of physical quantities is also</font></font></p>
<div class="equation">
<pre>  \phi = \phi (\overrightarrow{x}(\overrightarrow{x}_0, t), t)
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It will be. </font><font style="vertical-align: inherit;">Looking at </font><font style="vertical-align: inherit;">the current physical quantity and the </font><font style="vertical-align: inherit;">amount of change in the physical quantity after </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ Delta t</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seconds </font><font style="vertical-align: inherit;">according to the definition of differentiation</font></font></p>
<div class="equation">
<pre>  \displaystyle \lim_{\Delta t \to 0} \frac{\phi(\overrightarrow{x}(\overrightarrow{x}_0, t + \Delta t), t + \Delta t) - \phi(\overrightarrow{x}(\overrightarrow{x}_0, t), t)}{\Delta t}
</pre>
</div>
<div class="equation">
<pre>  = \sum_i \frac{\partial \phi}{\partial x_i} \frac{\partial x_i}{\partial t} + \frac{\partial \phi}{\partial t}
</pre>
</div>
<div class="equation">
<pre>  = \left( \left( \begin{matrix}u_1\\u_2\\u_3\end{matrix} \right)<font></font>
    \cdot<font></font>
    \left( \begin{matrix} \frac{\partial}{\partial x_1}\\\frac{\partial}{\partial x_2}\\\frac{\partial}{\partial x_3} \end{matrix} \right)<font></font>
    + \frac{\partial}{\partial t}<font></font>
    \right) \phi\\<font></font>
</pre>
</div>
<div class="equation">
<pre>  = (\frac{\partial}{\partial t} + \overrightarrow{u} \cdot {grad}) \phi
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It will be. </font><font style="vertical-align: inherit;">This is the time derivative of the physical quantity considering the movement of the observation point. </font><font style="vertical-align: inherit;">However, using this notation complicates the formula, so</font></font></p>
<div class="equation">
<pre>  \dfrac{D}{Dt} := \frac{\partial}{\partial t} + \overrightarrow{u} \cdot {grad}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It can be shortened by introducing the operator. </font><font style="vertical-align: inherit;">A series of operations that take into account the movement of observation points is called Lagrange differentiation. </font><font style="vertical-align: inherit;">At first glance, it may seem complicated, but in the particle method where the observation points move, it is more convenient to express the equation from a Lagrangian point of view.</font></font></p>

<h3><a id="h5-1-3"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1.3　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fluid uncompressed conditions</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A fluid can be considered to have no volume change if its velocity is well below the speed of sound. </font><font style="vertical-align: inherit;">This is called the uncompressed condition of the fluid and is expressed by the following formula.</font></font></p>
<div class="equation">
<pre>  \nabla \cdot \overrightarrow{u} = 0
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This indicates that there is no gushing or disappearance in the fluid. </font><font style="vertical-align: inherit;">Since the derivation of this equation involves a slightly complicated integral, the explanation is omitted </font></font><a id="fnb-bridson" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#fn-bridson" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Think of it as "do not compress the fluid!"</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-bridson"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 3] It is explained in detail in "Fluid Simulation for Computer Graphics --Robert Bridson".</font></font></p></div>

<h2><a id="h5-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Particle method simulation</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the particle method, a fluid is </font><font style="vertical-align: inherit;">divided into </font><font style="vertical-align: inherit;">small </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">particles</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the movement of the fluid is observed from a Lagrangian perspective. </font><font style="vertical-align: inherit;">This particle corresponds to the observation point in the previous section. </font><font style="vertical-align: inherit;">Even if it is called the "particle method" in one word, many methods have been proposed at present, and it is famous</font></font></p>
<ul>
<li>Smoothed Particle Hydrodynamics(SPH)法</li>
<li>Fluid Implicit Particle (FLIP) 法</li>
<li>Particle In Cell (PIC) 法</li>
<li>Moving Particle Semi-implicit (MPS) 法</li>
<li>Material Point Method (MPM) 法</li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And so on.</font></font></p>

<h3><a id="h5-2-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Derivation of Navier-Stokes equation in particle method</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, the Navier-Stokes equation (hereinafter referred to as NS equation) in the particle method is described as follows.</font></font></p>
<div class="equation">
<pre>  \dfrac{D \overrightarrow{u}}{Dt} = -\dfrac{1}{\rho}\nabla p + \nu \nabla \cdot \nabla \overrightarrow{u} + \overrightarrow{g}<font></font>
  \label{eq:navier}<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The shape is a little different from the NS equation that came out in the grid method in the previous chapter. </font><font style="vertical-align: inherit;">The advection term is completely omitted, but if you look at the relationship between the Euler derivative and the Lagrange derivative, you can see that it can be transformed into this shape well. </font><font style="vertical-align: inherit;">In the particle method, the observation point is moved along the flow, so there is no need to consider the advection term when calculating the NS equation. </font><font style="vertical-align: inherit;">The calculation of advection can be completed by directly updating the particle position based on the acceleration calculated by the NS equation.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A real fluid is a collection of molecules, so it can be said to be a kind of particle system. </font><font style="vertical-align: inherit;">However, it is impossible to calculate the actual number of molecules with a computer, so it is necessary to adjust it to a computable size. </font><font style="vertical-align: inherit;">Each grain ( </font><a id="fnb-blobfoot" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#fn-blobfoot" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;">* 4</font></a><font style="vertical-align: inherit;"> ) </font><font style="vertical-align: inherit;">shown in </font></font><span class="imgref"><a href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#blob"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 5.2</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> represents a portion of the fluid divided by a computable size. </font><font style="vertical-align: inherit;">Each of these grains </font><font style="vertical-align: inherit;">can be thought of as having a </font><font style="vertical-align: inherit;">mass </font><span class="equation"><font style="vertical-align: inherit;">m</font></span><font style="vertical-align: inherit;"> , a position vector </font><span class="equation"><font style="vertical-align: inherit;">\ overridearrow {x}</font></span><font style="vertical-align: inherit;"> , a velocity vector </font><span class="equation"><font style="vertical-align: inherit;">\ overridearrow {u}</font></span><font style="vertical-align: inherit;"> , and a volume </font><span class="equation"><font style="vertical-align: inherit;">V</font></span><font style="vertical-align: inherit;"> , respectively.</font></font><a id="fnb-blobfoot" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#fn-blobfoot" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><span class="equation"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"></font><span class="equation"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"></font><span class="equation"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"></font><span class="equation"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"></font></p>
<div id="blob" class="image">
<img src="./Chapter 5 _ Fluid Simulation by SPH Method_files/blob.png" alt="Fluid particle approximation" class="width-070per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 5.2: Fluid particle approximation
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For each of these grains </font><font style="vertical-align: inherit;">, the acceleration is calculated by calculating </font><font style="vertical-align: inherit;">the external force </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ overridearrow {f}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and solving the equation of motion </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m \ overridearrow {a} = \ overridearrow {f}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and how in the next time step. You can decide whether to move to.</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-blobfoot"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 4] Called'Blob'in English</font></font></p></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As mentioned above, each particle moves by receiving some force from the surroundings, but what is that "force"? </font><font style="vertical-align: inherit;">A simple example is gravity </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m \ overrightarrow {g},</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> but it should also receive some force from surrounding particles. </font><font style="vertical-align: inherit;">These forces are explained below.</font></font></p>

<h4><a id="h5-2-1-1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pressure</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first force exerted on a fluid particle is pressure. </font><font style="vertical-align: inherit;">The fluid always flows from the higher pressure side to the lower pressure side. </font><font style="vertical-align: inherit;">If the same amount of pressure is applied from all directions, the force will be canceled and the movement will stop, so consider the case where the pressure balance is uneven. </font><font style="vertical-align: inherit;">As mentioned in the previous chapter, by taking the gradient of the pressure scalar field, it is possible to calculate the direction with the highest pressure rise rate from the viewpoint of your own particle position. </font><font style="vertical-align: inherit;">The direction in which the particles receive the force is from the one with the highest pressure to the one with the lowest pressure, so take the minus and </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">become-\ nabla p</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Also, since particles have a volume, the pressure applied to the particles is </font><font style="vertical-align: inherit;">calculated by </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multiplying-\ nabla p</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by the volume of the particles </font></font><a id="fnb-vol" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#fn-vol" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 5</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Finally, </font><font style="vertical-align: inherit;">the result </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--V \ nabla p</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is derived.</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-vol"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 5] Due to the uncompressed condition of the fluid, the integral of the pressure applied to the particles can be expressed simply by multiplying the volume.</font></font></p></div>

<h4><a id="h5-2-1-2"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Viscous force</font></font></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second force applied to fluid particles is viscous force. </font><font style="vertical-align: inherit;">A viscous fluid is a fluid that is hard to deform, such as honey and melted chocolate. </font><font style="vertical-align: inherit;">Applying the word viscous to the expression of the particle method, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the velocity of a particle is easy to average the velocity of the surrounding particles</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">As mentioned in the previous chapter, the operation of averaging the surroundings can be performed using the Laplacian.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expressing the degree of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">viscosity</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> using the </font><b><font style="vertical-align: inherit;">kinematic viscosity coefficient </font></b></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ mu</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it can be expressed as </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ mu \ nabla \ cdot \ nabla \ overridearrow {u}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>

<h4><a id="h5-2-1-3"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integration of pressure, viscous force and external force</font></font></h4>
<p><font style="vertical-align: inherit;"></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Applying</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> these forces to the equation of motion </font><span class="equation"><font style="vertical-align: inherit;">m \ overrightarrow {a} = \ overrightarrow {f}</font></span><font style="vertical-align: inherit;"> ,</font></font></p>
<div class="equation">
<pre>  m \dfrac{D\overrightarrow{u}}{Dt} = - V \nabla p + V \mu \nabla \cdot \nabla \overrightarrow{u} + m\overrightarrow{g}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here, since </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ rho V,</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> it is transformed ( </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is canceled).</font></font></p>
<div class="equation">
<pre>  \rho \dfrac{D\overrightarrow{u}}{Dt} = - \nabla p + \mu \nabla \cdot \nabla \overrightarrow{u} + \rho \overrightarrow{g}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divide by </font><font style="vertical-align: inherit;">both sides </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ rho</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></p>
<div class="equation">
<pre>  \dfrac{D\overrightarrow{u}}{Dt} = - \dfrac{1}{\rho}\nabla p + \dfrac{\mu}{\rho} \nabla \cdot \nabla \overrightarrow{u} + \overrightarrow{g}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, the coefficient of viscosity term </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ dfrac {\ mu} {\</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rho} in </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ nu</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by introducing,</font></font></p>
<div class="equation">
<pre>  \dfrac{D\overrightarrow{u}}{Dt} = - \dfrac{1}{\rho}\nabla p + \nu \nabla \cdot \nabla \overrightarrow{u} + \overrightarrow{g}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, we were able to derive the NS equation mentioned at the beginning.</font></font></p>

<h3><a id="h5-2-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Representation of advection in the particle method</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the particle method, the particles themselves represent the observation points of the fluid, so the calculation of the advection term is completed by simply moving the particle position. </font><font style="vertical-align: inherit;">In the actual calculation of the time derivative, infinitely small time is used, but since infinity cannot be expressed by computer calculation, </font><font style="vertical-align: inherit;">the differentiation is expressed using </font><font style="vertical-align: inherit;">sufficiently small time </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ Delta t</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This is called the difference, and the </font><font style="vertical-align: inherit;">smaller </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ Delta t</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the more accurate the calculation.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducing the expression of difference for acceleration,</font></font></p>
<div class="equation">
<pre>  \overrightarrow{a} = \dfrac{D\overrightarrow{u}}{Dt} \equiv \frac{\Delta \overrightarrow{u}}{\Delta t}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It will be. </font><font style="vertical-align: inherit;">So the velocity increment </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ Delta \ overrightarrow {u}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is</font></font></p>
<div class="equation">
<pre>\Delta \overrightarrow{u} = \Delta t \overrightarrow{a}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And also for the position increment,</font></font></p>
<div class="equation">
<pre>  \overrightarrow{u} = \frac{\partial \overrightarrow{x}}{\partial t} \equiv \frac{\Delta \overrightarrow{x}}{\Delta t}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Than,</font></font></p>
<div class="equation">
<pre>\Delta \overrightarrow{x} = \Delta t \overrightarrow{u}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It will be.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By using this result, the velocity vector and position vector in the next frame can be calculated. </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assuming</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that the particle velocity in the current frame is </font><span class="equation"><font style="vertical-align: inherit;">\ overrightarrow {u} _n</font></span><font style="vertical-align: inherit;"> , the particle velocity in the next frame is </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ overrightarrow {u} _ {n + 1}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="equation">
<pre>\overrightarrow{u}_{n+1} = \overrightarrow{u}_n + \Delta \overrightarrow{u} = \overrightarrow{u}_n + \Delta t \overrightarrow{a}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Can be expressed as.</font></font></p>
<p><font style="vertical-align: inherit;"></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assuming</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that the particle position in the current frame is </font><span class="equation"><font style="vertical-align: inherit;">\ overridearrow {x} _n</font></span><font style="vertical-align: inherit;"> , the particle position in the next frame is </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ overridearrow {x} _ {n + 1}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="equation">
<pre>\overrightarrow{x}_{n+1} = \overrightarrow{x}_n + \Delta \overrightarrow{x} = \overrightarrow{x}_n + \Delta t \overrightarrow{u}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Can be expressed as.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This technique is called the forward Euler method. </font><font style="vertical-align: inherit;">By repeating this every frame, it is possible to express the movement of particles at each time.</font></font></p>

<h2><a id="h5-3"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.3　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fluid simulation by SPH method</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the previous section, we explained how to derive the NS equation in the particle method. </font><font style="vertical-align: inherit;">Of course, these differential equations cannot be solved as they are on a computer, so some kind of approximation needs to be made. </font><font style="vertical-align: inherit;">As a method, I </font><font style="vertical-align: inherit;">will explain the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPH method</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that </font><font style="vertical-align: inherit;">is often used in the CG field </font><font style="vertical-align: inherit;">.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The SPH method was originally used for collision simulation between celestial bodies in astrophysics </font><font style="vertical-align: inherit;">, but it was also applied to fluid simulation in CG by </font><font style="vertical-align: inherit;">Desbrun et al. </font></font><a id="fnb-desbrun" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#fn-desbrun" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 6 in</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1996 </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In addition, parallelization is easy, and the current GPU can calculate a large number of particles in real time. </font><font style="vertical-align: inherit;">In computer simulation, it is necessary to discretize continuous physical quantities and perform calculations, and the method of performing this discretization </font><font style="vertical-align: inherit;">using a function called a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">weight function</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is called the SPH method.</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-desbrun"><p class="footnote">[*6] Desbrun and Cani, Smoothed Particles: A new paradigm for animating highly deformable bodies, Eurographics Workshop on Computer Animation and Simulation (EGCAS), 1996.</p></div>

<h3><a id="h5-3-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.3.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Discretization of physical quantities</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the SPH method, each particle has an influence range, and the closer the particle is to other particles, the greater the influence of that particle. </font></font><span class="imgref"><a href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#id_2dkernel"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 5.3 shows the</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> extent of this effect </font><font style="vertical-align: inherit;">.</font></font></p>
<div id="id_2dkernel" class="image">
<img src="./Chapter 5 _ Fluid Simulation by SPH Method_files/2dkernel.png" alt="Two-dimensional weight function" class="width-050per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 5.3: Two-dimensional weighting function
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This function </font><font style="vertical-align: inherit;">is called the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">weight function </font></font></b><a id="fnb-weight_fn" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#fn-weight_fn" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 7</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-weight_fn"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 7] Normally, this function is also called a kernel function, but it is called this function to distinguish it from the kernel function in Compute Shader.</font></font></p></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assuming that the physical quantity in the SPH method is </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ phi</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it is discretized as follows using a weighting function.</font></font></p>
<div class="equation">
<pre>  \phi(\overrightarrow{x}) = \sum_{j \in N}m_j\frac{\phi_j}{\rho_j}W(\overrightarrow{x_j} - \overrightarrow{x}, h)
</pre>
</div>
<p><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N, m, \ rho, and h</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are the set of neighboring particles, the mass of the particles, the density of the particles, and the radius of influence of the weighting function, respectively. </font><font style="vertical-align: inherit;">Also, the function </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">W</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the weighting function mentioned earlier.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Furthermore, partial differential operations such as gradient and Laplacian can be applied to this physical quantity, and the gradient is</font></font></p>
<div class="equation">
<pre>  \nabla \phi(\overrightarrow{x}) = \sum_{j \in N}m_j\frac{\phi_j}{\rho_j} \nabla W(\overrightarrow{x_j} - \overrightarrow{x}, h)
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laplacian</font></font></p>
<div class="equation">
<pre>  \nabla^2 \phi(\overrightarrow{x}) = \sum_{j \in N}m_j\frac{\phi_j}{\rho_j} \nabla^2 W(\overrightarrow{x_j} - \overrightarrow{x}, h)
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Can be expressed as. </font><font style="vertical-align: inherit;">As you can see from the equation, the physical quantity gradient and the Laplacian are images that apply only to the weighting function. </font><font style="vertical-align: inherit;">The weight function </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">W</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is different depending on the physical quantity to be obtained, but the explanation of the reason is omitted </font></font><a id="fnb-fujisawa" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#fn-fujisawa" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-fujisawa"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 8] It is explained in detail in "Basics of Physical Simulation for CG-Makoto Fujisawa".</font></font></p></div>

<h3><a id="h5-3-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.3.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Discretization of density</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The density of fluid particles is determined by using the formula of the physical quantity discretized by the weighting function.</font></font></p>
<div class="equation">
<pre>  \rho(\overrightarrow{x}) = \sum_{j \in N}m_jW_{poly6}(\overrightarrow{x_j} - \overrightarrow{x}, h)
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is given. </font><font style="vertical-align: inherit;">Here, the weight function </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">W to be</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> used </font><font style="vertical-align: inherit;">is given below.</font></font></p>
<div id="poly6" class="image">
<img src="./Chapter 5 _ Fluid Simulation by SPH Method_files/poly6.jpg" alt="Poly6 weight function" class="width-070per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 5.4: Poly6 weight function
</font></font></p>
</div>

<h3><a id="h5-3-3"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.3.3　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Discretization of viscous terms</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Discretizing the viscosity term also uses the weighting function as in the case of density.</font></font></p>
<div class="equation">
<pre>  f_{i}^{visc} = \mu\nabla^2\overrightarrow{u}_i = \mu \sum_{j \in N}m_j\frac{\overrightarrow{u}_j - \overrightarrow{u}_i}{\rho_j} \nabla^2 W_{visc}(\overrightarrow{x_j} - \overrightarrow{x}, h)
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is expressed as. </font><font style="vertical-align: inherit;">Where the weighting function Laplacian </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ nabla ^ 2 W_ {visc}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is given below.</font></font></p>
<div id="visc" class="image">
<img src="./Chapter 5 _ Fluid Simulation by SPH Method_files/visc.jpg" alt="Laplacian of Viscosity weight function" class="width-070per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 5.5: Laplacian of Viscosity weighting function
</font></font></p>
</div>

<h3><a id="h5-3-4"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.3.4　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Discretization of pressure terms</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Similarly, the pressure term is discretized.</font></font></p>
<div class="equation">
<pre>  f_{i}^{press} = - \frac{1}{\rho_i} \nabla p_i = - \frac{1}{\rho_i} \sum_{j \in N}m_j\frac{p_j - p_i}{2\rho_j} \nabla W_{spiky}(\overrightarrow{x_j} - \overrightarrow{x}, h)
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Where the gradient of the weighting function </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">W_ {spiky}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is given below.</font></font></p>
<div id="spiky" class="image">
<img src="./Chapter 5 _ Fluid Simulation by SPH Method_files/spiky.jpg" alt="Gradient of Spiky weight function" class="width-070per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 5.6: Gradient of Spiky weight function
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At this time, the pressure of the particles is called the Tait equation in advance.</font></font></p>
<div class="equation">
<pre>    p = B\left\{\left(\frac{\rho}{\rho_0}\right)^\gamma - 1\right\}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is calculated by. </font><font style="vertical-align: inherit;">Where </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the gas constant. </font><font style="vertical-align: inherit;">In order to guarantee incompressibility, Poisson's equation must be solved, but it is not suitable for real-time calculation. </font><font style="vertical-align: inherit;">Instead, it is said that the SPH method </font></font><a id="fnb-wcsph" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#fn-wcsph" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 9</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is not as good at calculating the pressure term as the lattice method in terms of ensuring incompressibility approximately.</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-wcsph"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 9] The SPH method, which calculates pressure using the Tait equation, is specially called the WCSPH method.</font></font></p></div>

<h2><a id="h5-4"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.4　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Implementation of SPH method</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Samples can be </font><font style="vertical-align: inherit;">found under Assets / SPHFluid </font><font style="vertical-align: inherit;">in this repository ( </font></font><a href="https://github.com/IndieVisualLab/UnityGraphicsProgramming" class="link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/IndieVisualLab/UnityGraphicsProgramming</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Please note that in this implementation, speedup and numerical stability are not considered in order to explain the SPH method as simply as possible.</font></font></p>

<h3><a id="h5-4-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.4.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parameters</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A description of the various parameters used in the simulation can be found in the comments in the code.</font></font></p>
<div id="parameters" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.1: Parameters used for simulation (FluidBase.cs)</font></font></p>
<pre class="list language-csharp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1: NumParticleEnum particleNum = NumParticleEnum.NUM_8K; // Number of particles</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 2: float smoothlen = 0.012f; // Particle radius</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 3: float pressureStiffness = 200.0f; // Pressure term coefficient</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 4: float restDensity = 1000.0f; // rest density</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 5: float particleMass = 0.0002f; // particle mass</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 6: float viscosity = 0.1f; // Viscosity coefficient</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 7: float maxAllowableTimestep = 0.005f; // Time step width</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 8: float wallStiffness = 3000.0f; // Penalty wall power</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 9: int iterations = 4; // number of iterations</font></font><font></font>
10: Vector2 gravity = new Vector2(0.0f, -0.5f);     // 重力<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
11: Vector2 range = new Vector2 (1, 1); // Simulation space</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
12: bool simulate = true; // Run or pause</font></font><font></font>
13: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
14: int numParticles; // Number of particles</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
15: float timeStep; // Time step width</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
16: float densityCoef; // Poly6 kernel density coefficient</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
17: float gradPressureCoef; // Pressure coefficient of Spiky kernel</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
18: float lapViscosityCoef; // Laplacian kernel viscosity coefficient</font></font><font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Please note that in this demoscene, the inspector sets a value that is different from the parameter initialization value described in the code.</font></font></p>

<h3><a id="h5-4-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.4.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Calculation of coefficients of SPH weighting function</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since the coefficient of the weight function does not change during simulation, it is calculated on the CPU side at the time of initialization. </font><font style="vertical-align: inherit;">(However, it is updated in the Update function in consideration of the possibility of editing the parameter during execution)</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since the mass of each particle is constant this time, the mass </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m in</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the formula of the physical quantity </font><font style="vertical-align: inherit;">goes out of the sigma and becomes as follows.</font></font></p>
<div class="equation">
<pre>  \phi(\overrightarrow{x}) = m \sum_{j \in N}\frac{\phi_j}{\rho_j}W(\overrightarrow{x_j} - \overrightarrow{x}, h)
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, the mass can be included in the coefficient calculation.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since the coefficient changes depending on the type of weight function, calculate the coefficient for each.</font></font></p>
<div id="coefs" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.2: Pre-calculation of weight function coefficients (FluidBase.cs)</font></font></p>
<pre class="list language-csharp"> 1: densityCoef = particleMass * 4f / (Mathf.PI * Mathf.Pow(smoothlen, 8));<font></font>
 2: gradPressureCoef<font></font>
 3:     = particleMass * -30.0f / (Mathf.PI * Mathf.Pow(smoothlen, 5));<font></font>
 4: lapViscosityCoef<font></font>
 5:     = particleMass * 20f / (3 * Mathf.PI * Mathf.Pow(smoothlen, 5));<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, the coefficients (and various parameters) calculated on the CPU side are stored in the constant buffer on the GPU side.</font></font></p>
<div id="setconst" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.3: Transferring a Value to the Compute Shader's Constant Buffer (FluidBase.cs)</font></font></p>
<pre class="list language-csharp"> 1: fluidCS.SetInt("_NumParticles", numParticles);<font></font>
 2: fluidCS.SetFloat("_TimeStep", timeStep);<font></font>
 3: fluidCS.SetFloat("_Smoothlen", smoothlen);<font></font>
 4: fluidCS.SetFloat("_PressureStiffness", pressureStiffness);<font></font>
 5: fluidCS.SetFloat("_RestDensity", restDensity);<font></font>
 6: fluidCS.SetFloat("_Viscosity", viscosity);<font></font>
 7: fluidCS.SetFloat("_DensityCoef", densityCoef);<font></font>
 8: fluidCS.SetFloat("_GradPressureCoef", gradPressureCoef);<font></font>
 9: fluidCS.SetFloat("_LapViscosityCoef", lapViscosityCoef);<font></font>
10: fluidCS.SetFloat("_WallStiffness", wallStiffness);<font></font>
11: fluidCS.SetVector("_Range", range);<font></font>
12: fluidCS.SetVector("_Gravity", gravity);<font></font>
</pre>
</div>
<div id="const" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.4: Compute Shader constant buffer (SPH2D.compute)</font></font></p>
<pre class="list language-csharp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1: int _NumParticles; // Number of particles</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 2: float _TimeStep; // Time step width (dt)</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 3: float _Smoothlen; // particle radius</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 4: float _PressureStiffness; // Becker's coefficient</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 5: float _RestDensity; // Rest density</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 6: float _DensityCoef; // Coefficient when calculating density</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 7: float _GradPressureCoef; // Coefficient when calculating pressure</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 8: float _LapViscosityCoef; // Coefficient when calculating viscosity</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 9: float _WallStiffness; // Pushing back force of the penalty method</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10: float _Viscosity; // Viscosity coefficient</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
11: float2 _Gravity; // Gravity</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
12: float2 _Range; // Simulation space</font></font><font></font>
13: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
14: float3 _MousePos; // Mouse position</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
15: float _MouseRadius; // Radius of mouse interaction</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
16: bool _MouseDown; // Is the mouse pressed?</font></font><font></font>
</pre>
</div>

<h3><a id="h5-4-3"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.4.3　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Density calculation</font></font></h3>
<div id="density_kernel" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.5: Kernel function for calculating density (SPH2D.compute)</font></font></p>
<pre class="list language-c"> 1: [numthreads(THREAD_SIZE_X, 1, 1)]<font></font>
 2: void DensityCS(uint3 DTid : SV_DispatchThreadID) {<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 3: uint P_ID = DTid.x; // Particle ID currently being processed</font></font><font></font>
 4: <font></font>
 5:     float h_sq = _Smoothlen * _Smoothlen;<font></font>
 6:     float2 P_position = _ParticlesBufferRead[P_ID].position;<font></font>
 7: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 8: // Proximity exploration (O(n^2))</font></font><font></font>
 9:     float density = 0;<font></font>
10:     for (uint N_ID = 0; N_ID &lt; _NumParticles; N_ID++) {<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
11: if (N_ID == P_ID) continue; // Avoid referencing itself</font></font><font></font>
12: <font></font>
13:             float2 N_position = _ParticlesBufferRead[N_ID].position;<font></font>
14: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
15: float2 diff = N_position-P_position; // particle distance</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
16: float r_sq = dot (diff, diff); // Particle distance squared</font></font><font></font>
17: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
18: // Exclude particles that do not fit within the radius</font></font><font></font>
19:             if (r_sq &lt; h_sq) {<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
20: // No need to take a route as the calculation only includes the square</font></font><font></font>
21:                     density += CalculateDensity(r_sq);<font></font>
22:             }<font></font>
23:     }<font></font>
24: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
25: // Update density buffer</font></font><font></font>
26:     _ParticlesDensityBufferWrite[P_ID].density = density;<font></font>
27: }<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Normally, it is necessary to search for nearby particles using an appropriate neighborhood search algorithm without searching for all particles, but in this implementation, 100% survey is performed for simplicity (for loop on line 10). .. </font><font style="vertical-align: inherit;">Also, since the distance between you and the other particle is calculated, you avoid calculating between your own particles in the 11th line.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font><font style="vertical-align: inherit;">case classification by </font><font style="vertical-align: inherit;">the effective radius </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of the </font><font style="vertical-align: inherit;">weight function </font><font style="vertical-align: inherit;">is realized by the if statement on the 19th line. </font><font style="vertical-align: inherit;">Density addition (sigma calculation) is realized by adding the calculation result inside sigma to the variable initialized with 0 in the 9th line. </font><font style="vertical-align: inherit;">Here is the formula for calculating the density again.</font></font></p>
<div class="equation">
<pre>  \rho(\overrightarrow{x}) = \sum_{j \in N}m_jW_{poly6}(\overrightarrow{x_j} - \overrightarrow{x}, h)
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The density is calculated using the Poly6 weighting function as shown in the above equation. </font><font style="vertical-align: inherit;">The Poly6 weighting function is </font><font style="vertical-align: inherit;">calculated in </font></font><span class="listref"><a href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#density_weight"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.6</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div id="density_weight" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.6: Density Calculation (SPH2D.compute)</font></font></p>
<pre class="list language-c"> 1: inline float CalculateDensity(float r_sq) {<font></font>
 2:     const float h_sq = _Smoothlen * _Smoothlen;<font></font>
 3:     return _DensityCoef * (h_sq - r_sq) * (h_sq - r_sq) * (h_sq - r_sq);<font></font>
 4: }<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, </font><font style="vertical-align: inherit;">line 25 </font><font style="vertical-align: inherit;">of </font></font><span class="listref"><a href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#density_kernel"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.5</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> writes to the write buffer.</font></font></p>

<h3><a id="h5-4-4"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.4.4　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Calculation of pressure per particle</font></font></h3>
<div id="press_kernel" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.7: Weighting function (SPH2D.compute) to calculate pressure per particle</font></font></p>
<pre class="list language-c"> 1: [numthreads(THREAD_SIZE_X, 1, 1)]<font></font>
 2: void PressureCS(uint3 DTid : SV_DispatchThreadID) {<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 3: uint P_ID = DTid.x; // Particle ID currently being processed</font></font><font></font>
 4: <font></font>
 5:     float  P_density = _ParticlesDensityBufferRead[P_ID].density;<font></font>
 6:     float  P_pressure = CalculatePressure(P_density);<font></font>
 7: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 8: // Update pressure buffer</font></font><font></font>
 9:     _ParticlesPressureBufferWrite[P_ID].pressure = P_pressure;<font></font>
10: }<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before solving the pressure term, calculate the pressure for each particle to reduce the calculation cost of the pressure term later. </font><font style="vertical-align: inherit;">As I mentioned earlier, pressure calculation originally requires solving an equation called Poisson's equation, such as the following equation.</font></font></p>
<div class="equation">
<pre>    \nabla^2 p = \rho \frac{\nabla \overrightarrow{u}}{\Delta t}
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, the operation of solving Poisson's equation accurately with a computer is very expensive, so it is calculated approximately using the Tait equation below.</font></font></p>
<div class="equation">
<pre>    p = B\left\{\left(\frac{\rho}{\rho_0}\right)^\gamma - 1\right\}
</pre>
</div>
<div id="tait" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.8: Implementation of the Tait equation (SPH2D.compute)</font></font></p>
<pre class="list language-c"> 1: inline float CalculatePressure(float density) {<font></font>
 2:     return _PressureStiffness * max(pow(density / _RestDensity, 7) - 1, 0);<font></font>
 3: }<font></font>
</pre>
</div>

<h3><a id="h5-4-5"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.4.5　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Calculation of pressure term and viscosity term</font></font></h3>
<div id="force_kernel" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.9: Kernel function to calculate pressure and viscosity terms (SPH2D.compute)</font></font></p>
<pre class="list language-c"> 1: [numthreads(THREAD_SIZE_X, 1, 1)]<font></font>
 2: void ForceCS(uint3 DTid : SV_DispatchThreadID) {<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 3: uint P_ID = DTid.x; // Particle ID currently being processed</font></font></font></font><font></font>
 4: <font></font>
 5:     float2 P_position = _ParticlesBufferRead[P_ID].position;<font></font>
 6:     float2 P_velocity = _ParticlesBufferRead[P_ID].velocity;<font></font>
 7:     float  P_density = _ParticlesDensityBufferRead[P_ID].density;<font></font>
 8:     float  P_pressure = _ParticlesPressureBufferRead[P_ID].pressure;<font></font>
 9: <font></font>
10:     const float h_sq = _Smoothlen * _Smoothlen;<font></font>
11: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
12: // Proximity exploration (O(n^2))</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
13: float2 press = float2 (0, 0);</font></font></font></font><font></font>
14:     float2 visco = float2(0, 0);<font></font>
15:     for (uint N_ID = 0; N_ID &lt; _NumParticles; N_ID++) {<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
16: if (N_ID == P_ID) continue; // Skip if targeting itself</font></font><font></font>
17: <font></font>
18:             float2 N_position = _ParticlesBufferRead[N_ID].position;<font></font>
19: <font></font>
20:             float2 diff = N_position - P_position;<font></font>
21:             float r_sq = dot(diff, diff);<font></font>
22: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
23: // Exclude particles that do not fit within the radius</font></font><font></font>
24:             if (r_sq &lt; h_sq) {<font></font>
25:                     float  N_density<font></font>
26:                     = _ParticlesDensityBufferRead[N_ID].density;<font></font>
27:                     float  N_pressure<font></font>
28:                     = _ParticlesPressureBufferRead[N_ID].pressure;<font></font>
29:                     float2 N_velocity<font></font>
30:                     = _ParticlesBufferRead[N_ID].velocity;<font></font>
31:                     float  r = sqrt(r_sq);<font></font>
32: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
33: // Pressure item</font></font><font></font>
34:                     press += CalculateGradPressure(...);<font></font>
35: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
36: // Sticky items</font></font><font></font>
37:                     visco += CalculateLapVelocity(...);<font></font>
38:             }<font></font>
39:     }<font></font>
40: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
41: // Integration</font></font><font></font>
42:     float2 force = press + _Viscosity * visco;<font></font>
43: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
44: // Acceleration buffer update</font></font><font></font>
45:     _ParticlesForceBufferWrite[P_ID].acceleration = force / P_density;<font></font>
46: }<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The pressure term and viscosity term are calculated in the same way as the density calculation method.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, the force is calculated by the following pressure term on the 31st line.</font></font></p>
<div class="equation">
<pre>  f_{i}^{press} = - \frac{1}{\rho_i} \nabla p_i = - \frac{1}{\rho_i} \sum_{j \in N}m_j\frac{p_j - p_i}{2\rho_j} \nabla W_{press}(\overrightarrow{x_j} - \overrightarrow{x}, h)
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The calculation of the contents of Sigma is performed by the following function.</font></font></p>
<div id="press_weight" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.10: Calculation of Pressure Term Elements (SPH2D.compute)</font></font></p>
<pre class="list language-c"> 1: inline float2 CalculateGradPressure(...) {<font></font>
 2:     const float h = _Smoothlen;<font></font>
 3:     float avg_pressure = 0.5f * (N_pressure + P_pressure);<font></font>
 4:     return _GradPressureCoef * avg_pressure / N_density<font></font>
 5:             * pow(h - r, 2) / r * (diff);<font></font>
 6: }<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, the force is calculated by the following viscosity term on the 34th line.</font></font></p>
<div class="equation">
<pre>  f_{i}^{visc} = \mu\nabla^2\overrightarrow{u}_i = \mu \sum_{j \in N}m_j\frac{\overrightarrow{u}_j - \overrightarrow{u}_i}{\rho_j} \nabla^2 W_{visc}(\overrightarrow{x_j} - \overrightarrow{x}, h)
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The calculation of the contents of Sigma is performed by the following function.</font></font></p>
<div id="visc_weight" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.11: Calculation of Viscosity Term Elements (SPH2D.compute)</font></font></p>
<pre class="list language-c"> 1: inline float2 CalculateLapVelocity(...) {<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 2:     const float h = _Smoothlen;</font></font></font></font><font></font>
 3:     float2 vel_diff = (N_velocity - P_velocity);<font></font>
 4:     return _LapViscosityCoef / N_density * (h - r) * vel_diff;<font></font>
 5: }<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, on </font><font style="vertical-align: inherit;">line 39 of </font></font><span class="listref"><a href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#force_kernel"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.9</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the forces calculated by the pressure and viscosity terms are added and written to the buffer as the final output.</font></font></p>

<h3><a id="h5-4-6"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.4.6　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Collision detection and position update</font></font></h3>
<div id="integrate_kernel" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.12: Kernel function for collision detection and position update (SPH2D.compute)</font></font></p>
<pre class="list language-c"> 1: [numthreads(THREAD_SIZE_X, 1, 1)]<font></font>
 2: void IntegrateCS(uint3 DTid : SV_DispatchThreadID) {<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 3: const unsigned int P_ID = DTid.x; // Particle ID currently being processed</font></font><font></font>
 4: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 5: // Position and speed before update</font></font><font></font>
 6:     float2 position = _ParticlesBufferRead[P_ID].position;<font></font>
 7:     float2 velocity = _ParticlesBufferRead[P_ID].velocity;<font></font>
 8:     float2 acceleration = _ParticlesForceBufferRead[P_ID].acceleration;<font></font>
 9: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10: // Mouse interaction</font></font><font></font>
11:     if (distance(position, _MousePos.xy) &lt; _MouseRadius &amp;&amp; _MouseDown) {<font></font>
12:             float2 dir = position - _MousePos.xy;<font></font>
13:             float pushBack = _MouseRadius-length(dir);<font></font>
14:             acceleration += 100 * pushBack * normalize(dir);<font></font>
15:     }<font></font>
16: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
17: // Here to write collision detection -----</font></font><font></font>
18: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
19: // Wall boundary (penalty method)</font></font><font></font>
20:     float dist = dot(float3(position, 1), float3(1, 0, 0));<font></font>
21:     acceleration += min(dist, 0) * -_WallStiffness * float2(1, 0);<font></font>
22: <font></font>
23:     dist = dot(float3(position, 1), float3(0, 1, 0));<font></font>
24:     acceleration += min(dist, 0) * -_WallStiffness * float2(0, 1);<font></font>
25: <font></font>
26:     dist = dot(float3(position, 1), float3(-1, 0, _Range.x));<font></font>
27:     acceleration += min(dist, 0) * -_WallStiffness * float2(-1, 0);<font></font>
28: <font></font>
29:     dist = dot(float3(position, 1), float3(0, -1, _Range.y));<font></font>
30:     acceleration += min(dist, 0) * -_WallStiffness * float2(0, -1);<font></font>
31: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
32: // Addition of gravity</font></font><font></font>
33:     acceleration += _Gravity;<font></font>
34: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
35: // Update the next particle position with the forward Euler method</font></font><font></font>
36:     velocity += _TimeStep * acceleration;<font></font>
37:     position += _TimeStep * velocity;<font></font>
38: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
39: // Particle buffer update</font></font><font></font>
40:     _ParticlesBufferWrite[P_ID].position = position;<font></font>
41:     _ParticlesBufferWrite[P_ID].velocity = velocity;<font></font>
42: }<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Collision detection with a wall is performed using the penalty method (lines 19-30). </font><font style="vertical-align: inherit;">The penalty method is a method of pushing back with a strong force as much as it protrudes from the boundary position.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Originally, collision detection with obstacles is also performed before collision detection with a wall, but in this implementation, interaction with the mouse is performed (lines 213-218). </font><font style="vertical-align: inherit;">If the mouse is pressed, the specified force is applied to move it away from the mouse position.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gravity, which is an external force, is added on the 33rd line. </font><font style="vertical-align: inherit;">Setting the gravity value to zero results in weightlessness and interesting visual effects. </font><font style="vertical-align: inherit;">Also, update the position using the forward Euler method described above (lines 36-37) and write the final result to the buffer.</font></font></p>

<h3><a id="h5-4-7"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.4.7　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Simulation main routine</font></font></h3>
<div id="routine" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.13: Simulation key functions (FluidBase.cs)</font></font></p>
<pre class="list language-csharp"> 1: private void RunFluidSolver() {<font></font>
 2: <font></font>
 3:   int kernelID = -1;<font></font>
 4:   int threadGroupsX = numParticles / THREAD_SIZE_X;<font></font>
 5: <font></font>
 6:   // Density<font></font>
 7:   kernelID = fluidCS.FindKernel("DensityCS");<font></font>
 8:   fluidCS.SetBuffer(kernelID, "_ParticlesBufferRead", ...);<font></font>
 9:   fluidCS.SetBuffer(kernelID, "_ParticlesDensityBufferWrite", ...);<font></font>
10:   fluidCS.Dispatch(kernelID, threadGroupsX, 1, 1);<font></font>
11: <font></font>
12:   // Pressure<font></font>
13:   kernelID = fluidCS.FindKernel("PressureCS");<font></font>
14:   fluidCS.SetBuffer(kernelID, "_ParticlesDensityBufferRead", ...);<font></font>
15:   fluidCS.SetBuffer(kernelID, "_ParticlesPressureBufferWrite", ...);<font></font>
16:   fluidCS.Dispatch(kernelID, threadGroupsX, 1, 1);<font></font>
17: <font></font>
18:   // Force<font></font>
19:   kernelID = fluidCS.FindKernel("ForceCS");<font></font>
20:   fluidCS.SetBuffer(kernelID, "_ParticlesBufferRead", ...);<font></font>
21:   fluidCS.SetBuffer(kernelID, "_ParticlesDensityBufferRead", ...);<font></font>
22:   fluidCS.SetBuffer(kernelID, "_ParticlesPressureBufferRead", ...);<font></font>
23:   fluidCS.SetBuffer(kernelID, "_ParticlesForceBufferWrite", ...);<font></font>
24:   fluidCS.Dispatch(kernelID, threadGroupsX, 1, 1);<font></font>
25: <font></font>
26:   // Integrate<font></font>
27:   kernelID = fluidCS.FindKernel("IntegrateCS");<font></font>
28:   fluidCS.SetBuffer(kernelID, "_ParticlesBufferRead", ...);<font></font>
29:   fluidCS.SetBuffer(kernelID, "_ParticlesForceBufferRead", ...);<font></font>
30:   fluidCS.SetBuffer(kernelID, "_ParticlesBufferWrite", ...);<font></font>
31:   fluidCS.Dispatch(kernelID, threadGroupsX, 1, 1);<font></font>
32: <font></font>
33:   SwapComputeBuffer(ref particlesBufferRead, ref particlesBufferWrite);<font></font>
34: }<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is the part that calls the Compute Shader kernel function described so far every frame. </font><font style="vertical-align: inherit;">Give the appropriate ComputeBuffer for each kernel function.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now, </font><font style="vertical-align: inherit;">remember that the smaller </font><font style="vertical-align: inherit;">the time step width </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ Delta t</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the less error the simulation will have. </font><font style="vertical-align: inherit;">When running at 60FPS, </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ Delta t = 1/60</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but this causes a large error and the particles explode. </font><font style="vertical-align: inherit;">Furthermore, </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if the</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> time step width is smaller than </font><span class="equation"><font style="vertical-align: inherit;">\ Delta t = 1/60, the</font></span><font style="vertical-align: inherit;"> time per frame will advance slower than the real time, resulting in slow motion. </font><font style="vertical-align: inherit;">To avoid this, set </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ Delta t = 1 / (60 \ times {iterarion}) and run</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the main routine iterarion times per frame.</font></font></p>
<div id="iteration" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.14: Major Function Iteration (FluidBase.cs)</font></font></p>
<pre class="list language-csharp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1: // Reduce the time step width and iterate multiple times to improve the calculation accuracy.</font></font><font></font>
 2: for (int i = 0; i&lt;iterations; i++) {<font></font>
 3:     RunFluidSolver();<font></font>
 4: }<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This allows you to perform real-time simulations with a small time step width.</font></font></p>

<h3><a id="h5-4-8"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.4.8　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to use the buffer</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unlike a normal single-access particle system, particles interact with each other, so it is a problem if other data is rewritten during the calculation. </font><font style="vertical-align: inherit;">To avoid this, prepare two buffers, a read buffer and a write buffer, which do not rewrite the value when performing calculations on the GPU. </font><font style="vertical-align: inherit;">By swapping these buffers every frame, you can update the data without conflict.</font></font></p>
<div id="swap" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.15: Buffer Swapping Function (FluidBase.cs)</font></font></p>
<pre class="list language-csharp"> 1: void SwapComputeBuffer(ref ComputeBuffer ping, ref ComputeBuffer pong) {<font></font>
 2:     ComputeBuffer temp = ping;<font></font>
 3:     ping = pong;<font></font>
 4:     pong = temp;<font></font>
 5: }<font></font>
</pre>
</div>

<h3><a id="h5-4-9"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.4.9　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Particle rendering</font></font></h3>
<div id="rendercs" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.16: Rendering Particles (FluidRenderer.cs)</font></font></p>
<pre class="list language-csharp"> 1: void DrawParticle() {<font></font>
 2: <font></font>
 3:   Material m = RenderParticleMat;<font></font>
 4: <font></font>
 5:   var inverseViewMatrix = Camera.main.worldToCameraMatrix.inverse;<font></font>
 6: <font></font>
 7:   m.SetPass(0);<font></font>
 8:   m.SetMatrix("_InverseMatrix", inverseViewMatrix);<font></font>
 9:   m.SetColor("_WaterColor", WaterColor);<font></font>
10:   m.SetBuffer("_ParticlesBuffer", solver.ParticlesBufferRead);<font></font>
11:   Graphics.DrawProcedural(MeshTopology.Points, solver.NumParticles);<font></font>
12: }<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the 10th line, set the buffer containing the position calculation result of the fluid particle in the material and transfer it to the shader. </font><font style="vertical-align: inherit;">On the 11th line, we are instructing to draw instances for the number of particles.</font></font></p>
<div id="render" class="code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 5.17: Particle Rendering (Particle.shader)</font></font></p>
<pre class="list language-c"> 1: struct FluidParticle {<font></font>
 2:     float2 position;<font></font>
 3:     float2 velocity;<font></font>
 4: };<font></font>
 5: <font></font>
 6: StructuredBuffer&lt;FluidParticle&gt; _ParticlesBuffer;<font></font>
 7: <font></font>
 8: // --------------------------------------------------------------------<font></font>
 9: // Vertex Shader<font></font>
10: // --------------------------------------------------------------------<font></font>
11: v2g vert(uint id : SV_VertexID) {<font></font>
12: <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
13: v2g or = (v2g) 0;</font></font><font></font>
14:     o.pos = float3(_ParticlesBuffer[id].position.xy, 0);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
15: o.color = float4 (0, 0.1, 0.1, 1);</font></font><font></font>
16:     return o;<font></font>
17: }<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lines 1-6 define the information for receiving fluid particle information. </font><font style="vertical-align: inherit;">At this time, it is necessary to match the definition with the structure of the buffer transferred from the script to the material. </font><font style="vertical-align: inherit;">The position data is received by referring to the buffer element with id: SV_VertexID as shown in the 14th line.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After that, as with a normal particle system </font><font style="vertical-align: inherit;">, create a </font><font style="vertical-align: inherit;">billboard </font><a id="fnb-billboard" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#fn-billboard" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;">* 10</font></a><font style="vertical-align: inherit;"> centered on the position data of the calculation result with the geometry shader </font><font style="vertical-align: inherit;">as </font></font><span class="imgref"><a href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#bill"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shown in Fig. 5.7</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">and attach and render the particle image.</font></font><a id="fnb-billboard" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/takao.html#fn-billboard" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<div id="bill" class="image">
<img src="./Chapter 5 _ Fluid Simulation by SPH Method_files/bill.jpg" alt="Billboard creation" class="width-100per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 5.7: Creating a billboard
</font></font></p>
</div>
<div class="footnote" epub:type="footnote" id="fn-billboard"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 10] A Plane whose table always faces the viewpoint.</font></font></p></div>

<h2><a id="h5-5"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.5　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Results</font></font></h2>
<div id="result" class="image">
<img src="./Chapter 5 _ Fluid Simulation by SPH Method_files/result.png" alt="Rendering result">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 5.8: Rendering result
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The video is </font><font style="vertical-align: inherit;">posted </font><font style="vertical-align: inherit;">here ( </font></font><a href="https://youtu.be/KJVu26zeK2w" class="link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://youtu.be/KJVu26zeK2w</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></p>

<h2><a id="h5-6"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.6　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Summary</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this chapter, the method of fluid simulation using the SPH method is shown. </font><font style="vertical-align: inherit;">By using the SPH method, it has become possible to handle the movement of fluid as a general purpose like a particle system.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As mentioned earlier, there are many types of fluid simulation methods other than the SPH method. </font><font style="vertical-align: inherit;">Through this chapter, we hope that you will be interested in other physics simulations themselves in addition to other fluid simulation methods, and expand the range of expressions.</font></font></p></body></html>