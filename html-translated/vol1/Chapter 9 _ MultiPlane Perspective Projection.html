<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:ops="http://www.idpf.org/2007/ops" xml:lang="en" style="height: 100%;" class="translated-ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <link rel="stylesheet" type="text/css" href="./Chapter 9 _ MultiPlane Perspective Projection_files/style.scss">
  <meta name="generator" content="Re:VIEW">
  <title>MultiPlane PerspectiveProjection</title>

			<style>
				img {
					max-width: 80vw;
					max-height: 80vh;
				}
			</style><style>
					.goog-te-banner-frame {
						display: none;
					}
				</style>
			<script>(function(){(function injection() {
  var pageLang = 'ja';
  var userLang = 'en';

  var uid = '1E07F158C6FA4460B352973E9693B329';
  var teId = 'TE_' + uid;
  var cbId = 'TECB_' + uid;

  function show() {
    window.setTimeout(function() {
      window[teId].showBanner(true);
    }, 10);
  }

  function newElem() {
    
  }

  if (window[teId]) {
    show();
  } else {
    if (!window.google || !google.translate ||
        !google.translate.TranslateElement) {
      if (!window[cbId]) {
        window[cbId] = function() {
          window[teId] = newElem();
          show();
        };
      }
      
    }
  }
})();})();</script><script src="https://translate.google.com/translate_a/element.js?cb=TECB_1E07F158C6FA4460B352973E9693B329&amp;client=tee&amp;hl=en"></script><script src="./Chapter 9 _ MultiPlane Perspective Projection_files/f.txt"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/translate_static/js/element/main.js"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="./Chapter 9 _ MultiPlane Perspective Projection_files/translateelement.css"><script type="text/javascript" charset="UTF-8" src="./Chapter 9 _ MultiPlane Perspective Projection_files/main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script><script type="text/javascript" charset="UTF-8" src="./Chapter 9 _ MultiPlane Perspective Projection_files/element_main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/translate_static/js/element/main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script></head>
		
<body style="position: relative; min-height: 100%; top: 40px;"><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div>
<h1><a id="h9"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapter 9　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MultiPlane Perspective Projection</font></font></h1>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this chapter, we will introduce a video projection method that allows you to experience the experience of being in the CG world by projecting images on multiple surfaces such as the walls and floor of a rectangular parallelepiped room. </font><font style="vertical-align: inherit;">In addition, as the background, we will explain camera processing in CG and its application examples. </font><font style="vertical-align: inherit;">The sample project can be found </font><font style="vertical-align: inherit;">in Assets / Room </font><font style="vertical-align: inherit;">Projection in Unity Project </font></font><a id="fnb-project" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/RoomProjection.html#fn-project" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of Unity </font><font style="vertical-align: inherit;">Graphics Programming, so please have a look. </font><font style="vertical-align: inherit;">In addition, this content has </font><font style="vertical-align: inherit;">been significantly revised and revised based on the content contributed to the </font><font style="vertical-align: inherit;">"Mathematics Seminar December 2016" </font></font><a id="fnb-susemi" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/RoomProjection.html#fn-susemi" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-project"><p class="footnote"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[* 1] Sample project https://github.com/IndieVisualLab/UnityGraphicsProgramming</font></font></p></div>
<div class="footnote" epub:type="footnote" id="fn-susemi"><p class="footnote">[*2] https://www.nippyo.co.jp/shop/magazine/7292.html</p></div>

<h2><a id="h9-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How the camera works in CG</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Camera processing in general CG is processing that projects a 3D model of the visible range onto a 2D image using perspective projection conversion. </font><font style="vertical-align: inherit;">The perspective projection conversion is a local coordinate system with the center of each model as the origin, a world coordinate system with the origin at a uniquely determined location in the CG world, a view coordinate system centered on the camera, and a clip coordinate system for clipping (this). Is a 4-dimensional coordinate system in which w also has meaning, and the 3-dimensional version is called </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NDC (Normalized Device Coordinates</font></font></b><!-- IDX:NDC --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), which is a screen coordinate system that represents the 2-dimensional position of the output screen. The coordinates of the vertices are projected in order.</font></font></p>
<div id="spaces" class="image">
<img src="./Chapter 9 _ MultiPlane Perspective Projection_files/spaces.png" alt="Flow of coordinate conversion">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 9.1: Flow of coordinate transformation
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, since each of these transformations can be represented by one matrix, it is common practice to multiply the matrices in advance so that some coordinate transformations can be done by multiplying the matrix and the vector once.</font></font></p>

<h2><a id="h9-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Perspective consistency across multiple cameras</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In a camera in CG, a quadrangular pyramid with the apex at the camera position and the bottom surface at the camera orientation is called the viewing frustum, and can be illustrated as a 3D volume that represents the projection of the camera.</font></font></p>
<div id="frustum" class="image">
<img src="./Chapter 9 _ MultiPlane Perspective Projection_files/frustum.png" alt="Frustum" class="width-050per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 9.2: Frustum
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the viewing frustums of the two cameras share the apex and the sides are in contact, they will be connected visually even if the projection surfaces are facing different directions, and the perspectives when viewed from the apex will be the same. I will.</font></font></p>
<div id="frustum2" class="image">
<img src="./Chapter 9 _ MultiPlane Perspective Projection_files/frustum2.png" alt="Touching frustum (placed a little apart for clarity)">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 9.3: Touching frustum (placed slightly apart for clarity)
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This can be understood by considering the view frustum as a set of innumerable lines of sight and thinking that the lines of sight are continuous (= images that are consistent in perspective can be projected). </font><font style="vertical-align: inherit;">This idea was extended to five cameras, and the angle of view was adjusted so that the five view frustums shared the apex and were in contact with the adjacent view frustums, thereby corresponding to each surface of the room. You can generate a video. </font><font style="vertical-align: inherit;">Theoretically, 6 faces including the ceiling are possible, but this time we consider it as a projector installation space and assume 5 faces excluding the ceiling.</font></font></p>
<div id="frustum5" class="image">
<img src="./Chapter 9 _ MultiPlane Perspective Projection_files/frustum5.png" alt="5 view frustums corresponding to the room">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 9.4: Five viewing frustums corresponding to the room
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By viewing from this apex, that is, the location corresponding to all camera positions, you can view images that are consistent in perspective regardless of the direction of the room.</font></font></p>

<h2><a id="h9-3"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.3　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Derivation of projection matrix</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The projection matrix (hereinafter referred to as </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proj</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) is a matrix that transforms from the view coordinate system to the clip coordinate system.</font></font></p>
<ul>
<li><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Position vector in the clip coordinate system</font></font></li>
<li><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : is the position vector in the view coordinate system</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is expressed as follows by the formula.</font></font></p>
<div class="equation">
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C = Proj * V
</font></font></pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Furthermore </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> each element of </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C_ {w}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will position coordinates in NDC by dividing.</font></font></p>
<div class="equation">
<pre>NDC = (\frac{C_{x}}{C_{w}},\frac{C_{y}}{C_{w}},\frac{C_{z}}{C_{w}})
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C_ {w} = -V_ {z}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (make </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proj so</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that). </font><font style="vertical-align: inherit;">Since the front direction of the view coordinate system is the Z minus direction, it is minus. </font><font style="vertical-align: inherit;">In NDC, the display range is </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-1 \ leq x, y, z \ leq 1,</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and this conversion </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scales </font></font></span><font style="vertical-align: inherit;"></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V_ {x, y}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> according to </font><span class="equation"><font style="vertical-align: inherit;">V_ { </font></span><span class="equation"><font style="vertical-align: inherit;">z}</font></span><font style="vertical-align: inherit;"> to </font><font style="vertical-align: inherit;">obtain a perspective expression.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now </font><font style="vertical-align: inherit;">let's think about how to make </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proj</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Let </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N be</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the coordinate of </font><font style="vertical-align: inherit;">the upper right point of nearClipPlane and </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> be </font><font style="vertical-align: inherit;">the coordinate of the upper </font><font style="vertical-align: inherit;">right point of farClipPlane in the view coordinate system </font><font style="vertical-align: inherit;">.</font></font></p>
<div id="NF" class="image">
<img src="./Chapter 9 _ MultiPlane Perspective Projection_files/NF.png" alt="N,F" class="width-050per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 9.5: N, F
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First of all, </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you pay attention to </font><span class="equation"><font style="vertical-align: inherit;">x</font></span><font style="vertical-align: inherit;"> ,</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projection range of </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-1 \ leq x \ leq 1</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to become a</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Later </font><font style="vertical-align: inherit;">divided by </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C_ {w} (= -V_ {z})</font></font></span><font style="vertical-align: inherit;"></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Considering</font></font></p>
<div class="equation">
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proj [0,0] = \ frac {N_ {z}} {N_ {x}}
</font></font></pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If so, it looks good. </font><font style="vertical-align: inherit;">Since the ratio of x and z does not change, any x, z such as </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proj [0] [0] = \ frac {F_ {z}} {F_ {x}}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be used at the right end of the view frustum.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Similarly</font></font></p>
<div class="equation">
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proj [1,1] = \ frac {N_ {z}} {N_ {y}}
</font></font></pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Can also be obtained.</font></font></p>
<p><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> little ingenuity is required for </font><span class="equation"><font style="vertical-align: inherit;">z</font></span><font style="vertical-align: inherit;"> . </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> calculation related to z in </font><span class="equation"><font style="vertical-align: inherit;">Proj * V</font></span><font style="vertical-align: inherit;"> is as follows.</font></font></p>
<div class="equation">
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C_ {z} = Proj [2,2] * V_ {z} + Proj [2,3] * V_ {w} (however, V_ {w} = 1)
</font></font></pre>
</div>
<div class="equation">
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NDC_ {z} = \ frac {C_ {z}} {C_ {w}} (however, C_ {w} = -V_ {z})
</font></font></pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here, </font><font style="vertical-align: inherit;">I want to convert </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N_ {z} → -1, F_ {z} → 1</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so </font><font style="vertical-align: inherit;">I put </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a = Proj [2,2], b = Proj [2,3].</font></font></span><font style="vertical-align: inherit;"></font></p>
<div class="equation">
<pre>-1 = \frac{1}{N_{z}} (aN_{z} +b),　<font></font>
1 = \frac{1}{F_{z}} (aF_{z} +b)<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A solution can be obtained from this system of equations.</font></font></p>
<div class="equation">
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proj [2,2] = a = \ frac {F_ {z} + N_ {z}} {F_ {z} -N_ {z}},　</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proj [2,3] = b = \ frac {-2F_ {z} N_ {z}} {F_ {z} -N_ {z}}</font></font></font></font><font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, </font><font style="vertical-align: inherit;">I want </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C_ {w} = -V_ {w}</font></font></span><font style="vertical-align: inherit;"></font></p>
<div class="equation">
<pre>Proj[3,2] = -1
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will do.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, the required </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proj</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> has the following form.</font></font></p>
<div class="equation">
<pre>Proj = \left(<font></font>
\begin{array}{cccc}<font></font>
    \frac{N_{z}}{N_{x}} &amp;   0 &amp; 0 &amp; 0\\<font></font>
    0   &amp; \frac{N_{z}}{N_{y}} &amp; 0 &amp; 0\\<font></font>
    0   &amp;   0 &amp; \frac{F_{z}+N_{z}}{F_{z}-N_{z}} &amp; \frac{-2F_{z}N_{z}}{F_{z}-N_{z}} \\<font></font>
    0   &amp;   0 &amp; -1 &amp; 0<font></font>
\end{array}<font></font>
\right)<font></font>
</pre>
</div>

<h3><a id="h9-3-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.3.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Camera.projectionMatrix trap</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some of the people who have dealt with projection matrices in shaders may feel uncomfortable with the contents so far. </font><font style="vertical-align: inherit;">Actually, the handling of the projection matrix of Unity is complicated, and the contents so far are the explanation about Camera.projectionMatrix. </font><font style="vertical-align: inherit;">This value is OpenGL compliant regardless of platform </font></font><a id="fnb-opengl_projection" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/RoomProjection.html#fn-opengl_projection" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is why -1 \ leq NDC_ {z} \ leq 1</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C_ {w} = -V_ {w}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-opengl_projection"><p class="footnote">[*3] https://docs.unity3d.com/ScriptReference/GL.GetGPUProjectionMatrix.html</p></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, Camera.projectionMatrix is ​​not always used for perspective projection conversion as it is converted to a platform-dependent form when it is passed to the shader in Unity. </font><font style="vertical-align: inherit;">In particular, </font><font style="vertical-align: inherit;">the range and orientation of </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NDC_ {z}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (that is, the handling of the Z buffer) are diverse and easy to get caught </font></font><a id="fnb-zbuff" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/RoomProjection.html#fn-zbuff" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 4</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-zbuff"><p class="footnote">[*4] https://docs.unity3d.com/Manual/SL-PlatformDifferences.html</p></div>

<h2><a id="h9-4"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.4　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Operation of the viewing frustum</font></font></h2>

<h3><a id="h9-4-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.4.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Projection surface size adjustment</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The shape of the bottom of the view frustum, or projection plane, depends on the camera's </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fov (fieldOfView)</font></font></b><!-- IDX:fov --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aspect (aspect ratio)</font></font></b><!-- IDX:aspect --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In Unity's camera, the angle of view is published in the Inspector, but the aspect ratio is not published, so you need to edit it from the code. </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The</font></font></b><!-- IDX:faceSize --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> code to calculate the angle of view and aspect ratio from </font><b class="kw"><font style="vertical-align: inherit;">faceSize (the size of the surface of the room)</font></b><font style="vertical-align: inherit;"> and </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">distance (distance from the viewpoint to the surface)</font></font></b><!-- IDX:distance --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is as follows.</font></font></p>
<div id="fov_aspect" class="caption-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 9.1: Finding the angle of view and aspect ratio</font></font></p>
<pre class="list language-csharp">camera.aspect = faceSize.x / faceSize.y;<font></font>
camera.fieldOfView = 2f * Mathf.Atan2(faceSize.y * 0.5f, distance)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                     * Mathf.Rad2Deg;</font></font></font></font><font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note that Mathf.Atan2 () is used to find half the angle of fov with radian, doubled, and corrected to degree for substitution in Camera.fieldOfView.</font></font></p>

<h3><a id="h9-4-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.4.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Movement of projection plane (lens shift)</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider the case where the viewpoint is not in the center of the room. </font><font style="vertical-align: inherit;">If the projection plane can be translated vertically and horizontally with respect to the viewpoint, the same effect as moving the viewpoint with respect to the projection plane can be obtained. </font><font style="vertical-align: inherit;">In the real world, this </font><font style="vertical-align: inherit;">corresponds to a function called </font></font><b class="kw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lens shift</font></font></b><!-- IDX:レンズシフト --><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that </font><font style="vertical-align: inherit;">adjusts the projection position of the image with a projector or the like </font><font style="vertical-align: inherit;">.</font></font></p>
<div id="lensshift" class="image">
<img src="./Chapter 9 _ MultiPlane Perspective Projection_files/lensshift.png" alt="Lens shift">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 9.6: Lens shift
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Looking back at the mechanism by which the camera performs perspective projection, what part of the lens shift is the process? </font><font style="vertical-align: inherit;">When projecting to NDC with a projection matrix, it seems good to shift x and y. Let's look at the Projection matrix again.</font></font></p>
<div class="equation">
<pre>Proj = \left(<font></font>
\begin{array}{cccc}<font></font>
    \frac{N_{z}}{N_{x}} &amp;   0 &amp; 0 &amp; 0\\<font></font>
    0   &amp; \frac{N_{z}}{N_{y}} &amp; 0 &amp; 0\\<font></font>
    0   &amp;   0 &amp; \frac{F_{z}+N_{z}}{F_{z}-N_{z}} &amp; \frac{-2F_{z}N_{z}}{F_{z}-N_{z}} \\<font></font>
    0   &amp;   0 &amp; -1 &amp; 0<font></font>
\end{array}<font></font>
\right)<font></font>
</pre>
</div>
<p><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As long as C_ {x} and C_ {y}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are out of alignment </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I want to put something in </font><font style="vertical-align: inherit;">the translation components of the matrix, </font><span class="equation"><font style="vertical-align: inherit;">Proj [0,3] and Pro [1,3]</font></span><font style="vertical-align: inherit;"> , but later </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C_ {w}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Considering that it is divided by, the </font><font style="vertical-align: inherit;">correct answer is to put </font><font style="vertical-align: inherit;">it in </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proj [0,2], Pro [1,2]</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<div class="equation">
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proj = \left(</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
\begin{array}{cccc}</font></font></font></font><font></font>
    \frac{N_{z}}{N_{x}} &amp;   0 &amp; LensShift_{x} &amp; 0\\<font></font>
    0   &amp; \frac{N_{z}}{N_{y}} &amp; LensShift_{y} &amp; 0\\<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    0   &amp;   0 &amp; \frac{F_{z}+N_{z}}{F_{z}-N_{z}} &amp; \frac{-2F_{z}N_{z}}{F_{z}-N_{z}} \\</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    0   &amp;   0 &amp; -1 &amp; 0</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
\end{array}</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
\right)</font></font></font></font><font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since the unit of LensShift is NDC, the size of the projection plane is normalized to -1 to 1. </font><font style="vertical-align: inherit;">The code looks like this:</font></font></p>
<div id="Lensshift" class="caption-code">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 9.2: Reflect lens shift in projection matrix</font></font></p>
<pre class="list language-csharp">var shift = new Vector2(<font></font>
    positionOffset.x / faceSize.x,<font></font>
    positionOffset.y / faceSize.y<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
) * 2f;</font></font></font></font><font></font>
var projectionMatrix = camera.projectionMatrix;<font></font>
projectionMatrix[0,2] = shift.x;<font></font>
projectionMatrix[1,2] = shift.y;<font></font>
camera.projectionMatrix = projectionMatrix;<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note that once set to Camera.projectionMatrix, subsequent changes to Camera.fieldOfView will not be reflected unless Camera.ResetProjectionMatrix () is called. </font></font><a id="fnb-resetProjectionMatrix" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/RoomProjection.html#fn-resetProjectionMatrix" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">*Five</font></font></a></p>
<div class="footnote" epub:type="footnote" id="fn-resetProjectionMatrix"><p class="footnote">[*5] https://docs.unity3d.com/ScriptReference/Camera-projectionMatrix.html</p></div>

<h2><a id="h9-5"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.5　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> room projection</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is assumed that the viewer's viewpoint position can be tracked in a rectangular parallelepiped room. </font><font style="vertical-align: inherit;">Since the size of the projection surface of the viewing frustum can be translated by the method in the previous section, the viewing frustum is moved so that the viewpoint position is the apex of the viewing frustum and the wall surface or floor surface is the projection surface. You can ask for it. </font><font style="vertical-align: inherit;">By making each camera such a viewing frustum, it is possible to create an image for each projection plane. </font><font style="vertical-align: inherit;">By projecting this image into an actual room, the viewer will be able to see the CG world with perspective.</font></font></p>
<div id="projection_room" class="image">
<img src="./Chapter 9 _ MultiPlane Perspective Projection_files/projection_room.png" alt="Room simulation (overhead view)">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 9.7: Room simulation (overhead view)
</font></font></p>
</div>
<div id="projection_firstperson" class="image">
<img src="./Chapter 9 _ MultiPlane Perspective Projection_files/projection_firstperson.png" alt="Room simulation (first person view)">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 9.8: Room simulation (first person view)
</font></font></p>
</div>

<h2><a id="h9-6"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.6　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Summary</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this chapter, we introduced a projection method that matches perspectives on multiple projection planes by applying a projection matrix. </font><font style="vertical-align: inherit;">I think that it can be said that it is a VR with a non-approach similar to the recent HMD type in that it makes a wide range of the field of view a dynamically responsive image instead of placing the display in front of you. </font><font style="vertical-align: inherit;">In addition, this method does not deceive binocular parallax or eye focus, so it may not be possible to see stereoscopically as it is, and it may look like a "moving picture projected on the wall". </font><font style="vertical-align: inherit;">It seems that we need to devise a little more to increase the immersive feeling.</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enlarge the room so that the binocular parallax is small, and increase the distance from the viewer to the projection surface.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prevents the plane of the projection surface from being conscious of reflected light as much as possible</font></font><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make a dark image</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make walls and floors as non-specular as possible</font></font></li>
</ul>
</li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A mechanism called </font><font style="vertical-align: inherit;">"CAVE" </font></font><a id="fnb-cave" href="https://freder.github.io/UnityGraphicsProgrammingBook1/articles/RoomProjection.html#fn-cave" class="noteref" epub:type="noteref"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 6</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that </font><font style="vertical-align: inherit;">combines the same method with stereoscopic vision </font><font style="vertical-align: inherit;">is known.</font></font></p>
<div class="footnote" epub:type="footnote" id="fn-cave"><p class="footnote">[*6] https://en.wikipedia.org/wiki/Cave_automatic_virtual_environment</p></div></body></html>