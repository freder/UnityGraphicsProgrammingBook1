<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:ops="http://www.idpf.org/2007/ops" xml:lang="en" class="translated-ltr" style="height: 100%;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <link rel="stylesheet" type="text/css" href="./Chapter 7 _ Poisson Disk Sampling_files/style.scss">
  <meta name="generator" content="Re:VIEW">
  <title>Poisson Disk Sampling</title>

			<style>
				img {
					max-width: 80vw;
					max-height: 80vh;
				}
			</style><style>
					.goog-te-banner-frame {
						display: none;
					}
				</style>
			<script>(function(){(function injection() {
  var pageLang = 'ja';
  var userLang = 'en';

  var uid = '1E07F158C6FA4460B352973E9693B329';
  var teId = 'TE_' + uid;
  var cbId = 'TECB_' + uid;

  function show() {
    window.setTimeout(function() {
      window[teId].showBanner(true);
    }, 10);
  }

  function newElem() {
    
  }

  if (window[teId]) {
    show();
  } else {
    if (!window.google || !google.translate ||
        !google.translate.TranslateElement) {
      if (!window[cbId]) {
        window[cbId] = function() {
          window[teId] = newElem();
          show();
        };
      }
      
    }
  }
})();})();</script><script src="https://translate.google.com/translate_a/element.js?cb=TECB_1E07F158C6FA4460B352973E9693B329&amp;client=tee&amp;hl=en"></script><script src="./Chapter 7 _ Poisson Disk Sampling_files/f.txt"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/translate_static/js/element/main.js"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="./Chapter 7 _ Poisson Disk Sampling_files/translateelement.css"><script type="text/javascript" charset="UTF-8" src="./Chapter 7 _ Poisson Disk Sampling_files/main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script><script type="text/javascript" charset="UTF-8" src="./Chapter 7 _ Poisson Disk Sampling_files/element_main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://translate.googleapis.com/translate_static/css/translateelement.css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/translate_static/js/element/main.js"></script><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/element/TE_20201130_00/e/js/element/element_main.js"></script></head>
		
<body style="position: relative; min-height: 100%; top: 40px;"><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div><div class="skiptranslate" style=""><iframe id=":0.container" class="goog-te-banner-frame skiptranslate" frameborder="0" src="javascript:''" style="visibility:visible"></iframe></div>
<h1><a id="h7"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapter 7　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Poisson Disk Sampling</font></font></h1>

<h2><a id="h7-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Introduction</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This chapter provides an overview of Poisson Disk Sampling (hereinafter referred to as "PDS") and an explanation of the CPU implementation algorithm.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fast Poisson Disk Sampling in Arbitary Dimensions (high-speed Poisson disk sampling in any dimension: hereinafter, "FPDS" is used) is adopted for the implementation in the CPU. </font><font style="vertical-align: inherit;">This algorithm was proposed by Robert Bridson of the University of British Columbia in a 2007 paper submitted to SIGGRAPH.</font></font></p>

<h2><a id="h7-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.2　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Overview</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some people may not know what PDS is in the first place, so this section will explain PDS.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, plot a large number of points in a suitable space. </font><font style="vertical-align: inherit;">Next, </font><font style="vertical-align: inherit;">consider a </font><font style="vertical-align: inherit;">distance </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> greater than 0 </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">At this time, as </font></font><span class="imgref"><a href="https://freder.io/files/unity4/aoyama.html#id_aoyama_2Frandom__point"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shown</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in Fig </font><span class="imgref"><a href="https://freder.io/files/unity4/aoyama.html#id_aoyama_2Frandom__point"><font style="vertical-align: inherit;">. 7.1</font></a></span><font style="vertical-align: inherit;"> , the </font><font style="vertical-align: inherit;">distribution in which </font><font style="vertical-align: inherit;">all the points are at random positions but all the points are </font><font style="vertical-align: inherit;">separated by </font><font style="vertical-align: inherit;">at least </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or more is called the Poisson-disk distribution. </font><font style="vertical-align: inherit;">In other words, </font><font style="vertical-align: inherit;">even if two points are randomly selected from </font></font><span class="imgref"><a href="https://freder.io/files/unity4/aoyama.html#id_aoyama_2Frandom__point"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 7.1</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the distance between them </font><font style="vertical-align: inherit;">will not always be less than </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in any combination </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sampling such a Poisson-disk distribution, in other words, generating a Poisson-disk distribution by calculation, is called PDS.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With this PDS, you can get a random point cloud with uniformity. </font><font style="vertical-align: inherit;">Therefore, it is used for sampling in filtering processing such as antialiasing, and sampling for determining composite pixels in texture composition processing.</font></font></p>
<div id="id_aoyama_2Frandom__point" class="image">
<img src="./Chapter 7 _ Poisson Disk Sampling_files/random_point.png" alt="Plot random points" class="width-050per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 7.1: Plot random points
</font></font></p>
</div>

<h2><a id="h7-3"></a><span class="secno">7.3　</span>Fast Poisson Disk Sampling in Arbitary Dimensions （CPU実装）</h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The biggest feature of FPDS is that it is dimension-independent. </font><font style="vertical-align: inherit;">Most of the methods proposed so far are based on the assumption of two-dimensional calculation, and it has not been possible to efficiently perform three-dimensional sampling. </font><font style="vertical-align: inherit;">Therefore, FPDS was proposed to perform high-speed calculations in any dimension.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FPDS can be calculated in O (N) and can be implemented based on the same algorithm in any dimension. </font><font style="vertical-align: inherit;">This section describes the FPDS process step by step.</font></font></p>

<h3><a id="h7-3-1"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.3.1　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Introduction of FPDS</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Three parameters are used in the calculation of FPDS.</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sampling space range: </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rn</font></font></span></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Minimum distance between points: </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r</font></font></span></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sampling limit: </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k</font></font></span></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These parameters can be freely entered by the user. </font><font style="vertical-align: inherit;">The above parameters are also used in the following explanations.</font></font></p>

<h3><a id="h7-3-2"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.3.2</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Divide the sampling space into </font><span class="secno"><font style="vertical-align: inherit;">Grids　</font></span></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divide the sampling space into Grids to speed up the calculation of the distance between points. </font><font style="vertical-align: inherit;">Here, the number of dimensions of the sampling space is </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and the size of each divided space (hereinafter referred to as "cell") is </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ frac {r} {\ sqrt {n}}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><span class="imgref"><a href="https://freder.io/files/unity4/aoyama.html#id_aoyama_2Feuclid"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 7.2</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As shown in </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ sqrt {n}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is, </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the length of each axis in the dimension represents the absolute value of the first vector.</font></font></p>
<div id="id_aoyama_2Feuclid" class="image">
<img src="./Chapter 7 _ Poisson Disk Sampling_files/euclid.png" alt="When n = 3" class="width-075per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 7.2: When n = 3
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then, the sampled points belong to the cell that contains the coordinates. </font><font style="vertical-align: inherit;">Since the size of each cell is </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ frac {r} {\ sqrt {n}}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the center distance between adjacent cells is also </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ frac {r} {\ sqrt {n}}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In other words, </font><font style="vertical-align: inherit;">by dividing the space by </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ frac {r} {\ sqrt {n}}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">as you can see from </font></font><span class="imgref"><a href="https://freder.io/files/unity4/aoyama.html#id_aoyama_2Fgrid"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 7.3</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , at most one point belongs to each cell. </font><font style="vertical-align: inherit;">Furthermore, when searching the neighborhood of a certain cell, by searching the </font><font style="vertical-align: inherit;">surrounding cells by </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ pm {n}</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , all the cells within the </font><font style="vertical-align: inherit;">minimum distance </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be searched.</font></font></p>
<div id="id_aoyama_2Fgrid" class="image">
<img src="./Chapter 7 _ Poisson Disk Sampling_files/grid.png" alt="Partition of a set at n = 2" class="width-075per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 7.3: Partition of a set at n = 2
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, this Grid can be represented by an n-dimensional array, so it is very easy to implement. </font><font style="vertical-align: inherit;">By assigning the sampled point to the cell corresponding to its coordinates, it is possible to easily search for other points that exist nearby.</font></font></p>
<div class="emlist-code">
<p class="caption"> </p>
<pre class="emlist language-cs"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Get a 3D array that represents a 3D grid</font></font><font></font>
Vector3?[, ,] GetGrid(Vector3 bottomLeftBack, Vector3 topRightForward<font></font>
    , float min, int iteration)<font></font>
{<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Sampling space</font></font><font></font>
    var dimension = (topRightForward - bottomLeftBack);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Multiply the minimum distance by the reciprocal of √3 (I want to avoid division)</font></font><font></font>
    var cell = min * InvertRootTwo;<font></font>
<font></font>
    return new Vector3?[<font></font>
        Mathf.CeilToInt(dimension.x / cell) + 1,<font></font>
        Mathf.CeilToInt(dimension.y / cell) + 1,<font></font>
        Mathf.CeilToInt(dimension.z / cell) + 1<font></font>
    ];<font></font>
}<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
// Get the Index of the cell corresponding to the coordinates</font></font><font></font>
Vector3Int GetGridIndex(Vector3 point, Settings set)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{</font></font></font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Calculate Index by dividing the distance from the reference point by the cell size</font></font><font></font>
    return new Vector3Int(<font></font>
        Mathf.FloorToInt((point.x - set.BottomLeftBack.x) / set.CellSize),<font></font>
        Mathf.FloorToInt((point.y - set.BottomLeftBack.y) / set.CellSize),<font></font>
        Mathf.FloorToInt((point.z - set.BottomLeftBack.z) / set.CellSize)<font></font>
    );<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font></font></font><font></font>
</pre>
</div>

<h3><a id="h7-3-3"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.3.3　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Calculate initial sample points</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculate the first sample point that will be the starting point for the calculation. </font><font style="vertical-align: inherit;">At this point, no matter which coordinates are sampled, </font><font style="vertical-align: inherit;">there is no other point closer than the </font><font style="vertical-align: inherit;">distance </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r,</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> so one completely random coordinate is determined.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Based on the coordinates of this calculated sample point, it belongs to the corresponding cell and is added to the active list and sampling list. </font><font style="vertical-align: inherit;">This active list is a list that stores the starting points for sampling. </font><font style="vertical-align: inherit;">Sampling will be performed sequentially based on the points saved in this active list.</font></font></p>
<div class="emlist-code">
<p class="caption"> </p>
<pre class="emlist language-cs"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Find one random coordinate</font></font><font></font>
void GetFirstPoint(Settings set, Bags bags)<font></font>
{<font></font>
    var first = new Vector3(<font></font>
        Random.Range(set.BottomLeftBack.x, set.TopRightForward.x),<font></font>
        Random.Range(set.BottomLeftBack.y, set.TopRightForward.y),<font></font>
        Random.Range(set.BottomLeftBack.z, set.TopRightForward.z)<font></font>
    );<font></font>
    var index = GetGridIndex(first, set);<font></font>
<font></font>
    bags.Grid[index.x, index.y, index.z] = first;<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Sampling list, eventually returning this List as a result</font></font><font></font>
    bags.SamplePoints.Add(first);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Active list, sampling around this List</font></font><font></font>
    bags.ActivePoints.Add(first);<font></font>
}<font></font>
</pre>
</div>

<h3><a id="h7-3-4"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.3.4　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Select a reference point from the active list</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Randomly </font><font style="vertical-align: inherit;">select </font><font style="vertical-align: inherit;">Index </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the active list </font><font style="vertical-align: inherit;">and let the </font><font style="vertical-align: inherit;">coordinates stored in </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> be </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x_i</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">(Of course, at the very beginning </font><font style="vertical-align: inherit;">, </font><span class="equation"><font style="vertical-align: inherit;">i</font></span><font style="vertical-align: inherit;"> is 0 </font><font style="vertical-align: inherit;">because it </font><font style="vertical-align: inherit;">is </font><font style="vertical-align: inherit;">only the point generated in </font></font><a href="https://freder.io/files/unity4/aoyama.html#h7-3-3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"7.3.3 Calculate the initial sample points"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .)</font></font><span class="equation"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With this </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x_i</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as the center, other points will be sampled with respect to nearby coordinates. </font><font style="vertical-align: inherit;">By repeating this, the entire space can be sampled.</font></font></p>
<div id="id_aoyama_2Ffirst__darts" class="image">
<img src="./Chapter 7 _ Poisson Disk Sampling_files/first_darts.png" alt="Select initial sampling point" class="width-050per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 7.4: Select initial sampling point
</font></font></p>
</div>
<div class="emlist-code">
<p class="caption"> </p>
<pre class="emlist language-cs"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Randomly select points from the active list</font></font><font></font>
var index = Random.Range(0, bags.ActivePoints.Count);<font></font>
var point = bags.ActivePoints[index];<font></font>
</pre>
</div>

<h3><a id="h7-3-5"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.3.5　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sampling</font></font></h3>
<p><span class="equation"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Random coordinates </font><span class="equation"><font style="vertical-align: inherit;">x ^ {\ prime} _i</font></span><font style="vertical-align: inherit;"> are calculated </font><font style="vertical-align: inherit;">within an n-dimensional sphere (a circle for 2D and a sphere for 3D) with a </font><font style="vertical-align: inherit;">radius of </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or more and </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2r</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or less </font><font style="vertical-align: inherit;">centered on </font><span class="equation"><font style="vertical-align: inherit;">x_i</font></span><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Next, </font><font style="vertical-align: inherit;">check if there are other points </font><font style="vertical-align: inherit;">with a distance </font><font style="vertical-align: inherit;">closer than </font><span class="equation"><font style="vertical-align: inherit;">r</font></span><font style="vertical-align: inherit;"> around </font><font style="vertical-align: inherit;">the calculated </font><span class="equation"><font style="vertical-align: inherit;">x ^ {\ prime} _i</font></span><font style="vertical-align: inherit;"> .</font></font><span class="equation"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"></font><span class="equation"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"></font><span class="equation"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here, the distance calculation for all other points is a process with a higher load as the number of other points increases. </font><font style="vertical-align: inherit;">Therefore, in order to solve this problem, </font><font style="vertical-align: inherit;">the Grid generated in </font></font><a href="https://freder.io/files/unity4/aoyama.html#h7-3-2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"7.3.2 Dividing the sampling space into Grid"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is used, </font><font style="vertical-align: inherit;">and the calculation is performed by examining only the cells around the cell to which </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x ^ {\ prime} _i</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> belongs. Reduce the amount. </font><font style="vertical-align: inherit;">If there are other points in the surrounding cells, </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x ^ {\ prime} _i</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is discarded, and if there are no other points, </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x ^ {\ prime} _i</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> belongs to the corresponding cell, and the active list and sampling list Add to.</font></font></p>
<div id="id_aoyama_2Ffirst__sampling" class="image">
<img src="./Chapter 7 _ Poisson Disk Sampling_files/first_sampling.png" alt="Sampling other points based on the initial sampling point" class="width-050per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 7.5: Sampling other points relative to the initial sampling point
</font></font></p>
</div>
<div class="emlist-code">
<p class="caption"> </p>
<pre class="emlist language-cs"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Find the next sampling point based on the point coordinates</font></font><font></font>
private static bool GetNextPoint(Vector3 point, Settings set, Bags bags)<font></font>
{<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Find a random point in the range r ~ 2r around the point coordinates</font></font><font></font>
    var p = point +<font></font>
        GetRandPosInSphere(set.MinimumDistance, 2f * set.MinimumDistance);<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // If it is out of the sampling space, it will be treated as sampling failure.</font></font><font></font>
    if(set.Dimension.Contains(p) == false) { return false; }<font></font>
<font></font>
    var minimum = set.MinimumDistance * set.MinimumDistance;<font></font>
    var index = GetGridIndex(p, set);<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    var drop = false;</font></font></font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Calculate the range of Grid to search</font></font><font></font>
    var around = 3;<font></font>
    var fieldMin = new Vector3Int(<font></font>
        Mathf.Max(0, index.x - around), Mathf.Max(0, index.y - around),<font></font>
        Mathf.Max(0, index.z - around)<font></font>
    );<font></font>
    var fieldMax = new Vector3Int(<font></font>
        Mathf.Min(set.GridWidth, index.x + around),<font></font>
        Mathf.Min(set.GridHeight, index.y + around),<font></font>
        Mathf.Min(set.GridDepth, index.z + around)<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    );</font></font></font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Check if there are other points in the surrounding Grid</font></font><font></font>
    for(var i = fieldMin.x; i &lt;= fieldMax.x &amp;&amp; drop == false; i++)<font></font>
    {<font></font>
        for(var j = fieldMin.y; j &lt;= fieldMax.y &amp;&amp; drop == false; j++)<font></font>
        {<font></font>
            for(var k = fieldMin.z; k &lt;= fieldMax.z &amp;&amp; drop == false; k++)<font></font>
            {<font></font>
                var q = bags.Grid[i, j, k];<font></font>
                if(q.HasValue &amp;&amp; (q.Value - p).sqrMagnitude &lt;= minimum)<font></font>
                {<font></font>
                    drop = true;<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
    if(drop == true) { return false; }<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    // Adopted because there are no other points in the vicinity</font></font><font></font>
    bags.SamplePoints.Add(p);<font></font>
    bags.ActivePoints.Add(p);<font></font>
    bags.Grid[index.x, index.y, index.z] = p;<font></font>
    return true;<font></font>
}<font></font>
</pre>
</div>

<h3><a id="h7-3-6"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.3.6　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Repeat sampling</font></font></h3>
<p><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With x_i</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at the center, </font><font style="vertical-align: inherit;">only one point was </font></font><a href="https://freder.io/files/unity4/aoyama.html#h7-3-5"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sampled in "7.3.5 Sampling"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but this is </font><font style="vertical-align: inherit;">repeated </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> times. </font><font style="vertical-align: inherit;">If </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x_i</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> repeated times, if you were not able to sample even one point, </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x_i</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to remove from the active list.</font></font></p>
<div id="id_aoyama_2Flooped__sampling" class="image">
<img src="./Chapter 7 _ Poisson Disk Sampling_files/looped_sampling.png" alt="<span class=&quot;equation&quot;>k = 7</span>のとき" class="width-050per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 7.6: </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">K = 7</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> when the
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then, when </font><font style="vertical-align: inherit;">the repetition of </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is finished, </font><font style="vertical-align: inherit;">it returns </font></font><a href="https://freder.io/files/unity4/aoyama.html#h7-3-4"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to "7.3.4 Select a reference point from the active list"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">You can sample the entire space by repeating this until the active list reaches zero.</font></font></p>
<div class="emlist-code">
<p class="caption"> </p>
<pre class="emlist language-cs"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Repeat sampling</font></font><font></font>
public static List&lt;Vector3&gt; Sampling(Vector3 bottomLeft, Vector3 topRight,<font></font>
    float minimumDistance, int iterationPerPoint)<font></font>
{<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    var settings = GetSettings (</font></font></font></font><font></font>
        bottomLeft,<font></font>
        topRight,<font></font>
        minimumDistance,<font></font>
        iterationPerPoint &lt;= 0 ?<font></font>
            DefaultIterationPerPoint : iterationPerPoint<font></font>
    );<font></font>
    var bags = new Bags()<font></font>
    {<font></font>
        Grid = new Vector3?[<font></font>
            settings.GridWidth + 1,<font></font>
            settings.GridHeight + 1,<font></font>
            settings.GridDepth + 1<font></font>
        ],<font></font>
        SamplePoints = new List&lt;Vector3&gt;(),<font></font>
        ActivePoints = new List&lt;Vector3&gt;()<font></font>
    };<font></font>
    GetFirstPoint(settings, bags);<font></font>
<font></font>
    do<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    {</font></font></font></font><font></font>
        var index = Random.Range(0, bags.ActivePoints.Count);<font></font>
        var point = bags.ActivePoints[index];<font></font>
<font></font>
        var found = false;<font></font>
        for(var k = 0; k &lt; settings.IterationPerPoint; k++)<font></font>
        {<font></font>
            found = found | GetNextPoint(point, settings, bags);<font></font>
        }<font></font>
<font></font>
        if(found == false) { bags.ActivePoints.RemoveAt(index); }<font></font>
    }<font></font>
    while(bags.ActivePoints.Count &gt; 0);<font></font>
<font></font>
    return bags.SamplePoints;<font></font>
}<font></font>
</pre>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In other words, if you briefly explain the overall flow</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Determine the space and divide it into grids</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Determine the initial point appropriately</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sampling around the initial point</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the sampled points, sample the periphery in the same way.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For all points, finish when the surroundings can be sampled</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It means that. </font><font style="vertical-align: inherit;">Since parallelization is not proposed in this algorithm, if the sampling space </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rn</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is wide or the minimum distance </font></font><span class="equation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is small, a certain amount of calculation time is required, but it is easy to sample in any dimension. , A very attractive advantage.</font></font></p>

<h2><a id="h7-4"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.4　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Summary</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the processing up to this point </font><font style="vertical-align: inherit;">, the sampling result can be obtained as </font></font><span class="imgref"><a href="https://freder.io/files/unity4/aoyama.html#id_aoyama_2Fresult"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shown in Fig. 7.7</font></font></a></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This image is a circle created and placed by Geometry Shader at the sampled coordinates. </font><font style="vertical-align: inherit;">You can see that the circles do not overlap and are filled to the full extent.</font></font></p>
<div id="id_aoyama_2Fresult" class="image">
<img src="./Chapter 7 _ Poisson Disk Sampling_files/result.png" alt="Visualization of sampling results" class="width-050per">
<p class="caption"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 7.7: Visualization of sampling results
</font></font></p>
</div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As I mentioned at the beginning, Poisson disc sampling is used in a wide range of places, from antialiasing and image composition to image effects such as Blur and evenly spaced objects. </font><font style="vertical-align: inherit;">It doesn't give you a clear visual result on its own, but it's often used behind the high-quality visuals we usually see. </font><font style="vertical-align: inherit;">It can be said that it is one of the algorithms that is worth knowing when doing visual programming.</font></font></p>

<h2><a id="h7-5"></a><span class="secno"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.5　</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Reference</font></font></h2>
<ul>
<li>Fast Poisson Disk Sampling in Arbitrary Dimensions - <a href="https://www.cct.lsu.edu/~fharhad/ganbatte/siggraph2007/CD2/content/sketches/0250.pdf" class="link">https://www.cct.lsu.edu/~fharhad/ganbatte/siggraph2007/CD2/content/sketches/0250.pdf</a></li>
</ul><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="./Chapter 7 _ Poisson Disk Sampling_files/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div>


<div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 1001px; height: 263px; display: none;" src="./Chapter 7 _ Poisson Disk Sampling_files/saved_resource(1).html"></iframe><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 197px; height: 69px; display: none;" src="./Chapter 7 _ Poisson Disk Sampling_files/saved_resource(2).html"></iframe><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google Translate"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Original text</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Contribute a better translation</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 1001px; height: 263px; display: none;"></iframe><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 197px; height: 69px; display: none;"></iframe><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 1001px; height: 263px; display: none;"></iframe><iframe frameborder="0" class="goog-te-menu-frame skiptranslate" title="Language Translate Widget" style="visibility: visible; box-sizing: content-box; width: 197px; height: 69px; display: none;"></iframe></body></html>